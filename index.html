<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berthel's MCQ Generator</title>

  <!-- Latin Modern (via fontsource) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/latin-modern-roman@5.0.18/400.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/latin-modern-roman@5.0.18/700.css">

  <!-- KaTeX for math rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

  <style>
    :root {
      --hunter: #355E3B;
      --hunter-2: #2E5233;
      --bg: #f6f7f6;
      --card: #ffffff;
      --ink: #101316;
      --muted: #59636e;
      --border: #d7dadd;
      --focus: #1f7a3a;
      --danger: #b00020;
      --ok: #0b6b2a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Latin Modern Roman", "Times New Roman", Times, serif;
      color: var(--ink);
      background: var(--bg);
      line-height: 1.55;
      font-size: 18px;
    }

    header {
      background: linear-gradient(0deg, var(--hunter-2), var(--hunter));
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,0.18);
    }

    .wrap {
      max-width: 1040px;
      margin: 0 auto;
      padding: 18px;
    }

    .head {
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 18px 0;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .sub {
      margin-top: 6px;
      color: rgba(255,255,255,0.86);
      font-size: 15px;
      max-width: 70ch;
    }

    main .wrap { padding-top: 14px; }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 980px) {
      .grid { grid-template-columns: 1.2fr 0.8fr; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      padding: 16px;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 19px;
    }

    .muted { color: var(--muted); }

    .step {
      display: flex;
      gap: 10px;
      align-items: baseline;
      margin: 12px 0 8px;
    }

    .step b {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: rgba(53,94,59,0.12);
      color: var(--hunter);
      border: 1px solid rgba(53,94,59,0.25);
      font-size: 14px;
    }

    label {
      font-size: 13.5px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    textarea, input[type="number"] {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 12px;
      font-family: inherit;
      font-size: 17px;
      background: #fff;
      outline: none;
    }

    textarea { min-height: 210px; resize: vertical; }

    textarea:focus, input:focus {
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(31,122,58,0.15);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width: 700px) {
      .row.two { grid-template-columns: 1fr 1fr; }
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .btn {
      appearance: none;
      border: 0;
      background: var(--hunter);
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      font-family: inherit;
      font-size: 15.5px;
      font-weight: 700;
      cursor: pointer;
    }

    .btn:hover { background: var(--hunter-2); }

    .btn.secondary {
      background: transparent;
      color: var(--hunter);
      border: 1px solid var(--hunter);
    }

    .btn.secondary:hover { background: rgba(53,94,59,0.07); }

    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .status {
      margin-top: 10px;
      font-size: 13.5px;
      color: var(--muted);
    }

    .status.error { color: var(--danger); }
    .status.ok { color: var(--ok); }

    .quiz {
      margin-top: 14px;
      display: none;
    }

    .questions { display: grid; gap: 14px; }

    .q {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: #fff;
    }

    .qhead {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      align-items: baseline;
    }

    .qnum { font-weight: 700; color: var(--hunter); }

    .stem { font-size: 17px; margin-bottom: 10px; }

    .opt {
      display: grid;
      grid-template-columns: 26px 1fr;
      gap: 10px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin: 8px 0;
    }

    .opt:hover { background: rgba(53,94,59,0.04); }

    .letter { font-weight: 700; color: var(--hunter); }

    .results {
      margin-top: 14px;
      border-top: 1px solid var(--border);
      padding-top: 14px;
      display: none;
    }

    .score { font-weight: 700; font-size: 16.5px; }

    .explain {
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(16,19,22,0.02);
    }

    .badge {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      margin-left: 8px;
      border: 1px solid var(--border);
    }

    .badge.ok { color: var(--ok); border-color: rgba(11,107,42,0.35); background: rgba(11,107,42,0.08); }
    .badge.bad { color: var(--danger); border-color: rgba(176,0,32,0.35); background: rgba(176,0,32,0.08); }

    details summary {
      cursor: pointer;
      font-weight: 700;
      color: var(--hunter);
      margin-top: 8px;
    }

    .mini {
      font-size: 13.5px;
      color: var(--muted);
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: rgba(16,19,22,0.06);
      border: 1px solid rgba(16,19,22,0.12);
      padding: 1px 6px;
      border-radius: 8px;
    }

    footer {
      color: var(--muted);
      font-size: 12.5px;
      padding: 18px;
      text-align: center;
    }

    a.link {
      color: rgba(255,255,255,0.95);
      text-decoration: underline;
      text-decoration-thickness: 1px;
      text-underline-offset: 3px;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="head">
        <div>
          <h1>Berthel's MCQ Generator</h1>
          <div class="sub">Generate MCQs in <a class="link" href="#" id="gptInline">MCQ Machine</a>, then paste the JSON here to take the quiz and review feedback.</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid">
        <section class="card">
          <h2>Workflow</h2>

          <div class="step"><b>1</b><div><strong>Paste reference text</strong> and choose how many MCQs you want.</div></div>
          <label for="refText">Reference text (pure text)</label>
          <textarea id="refText" placeholder="Paste a passage, notes, worksheet text, or syllabus excerpt here."></textarea>

          <div class="row two" style="margin-top:12px;">
            <div>
              <label for="count">Number of MCQs (1–100)</label>
              <input id="count" type="number" min="1" max="100" value="10" />
              <div class="mini">Short texts usually support fewer high-quality questions.</div>
            </div>
            <div>
              <label>MCQ Machine (your GPT)</label>
              <div class="mini">Opens in a new tab. No API keys. Generation happens in your GPT.</div>
              <div class="actions" style="margin-top:8px;">
                <button class="btn secondary" id="openGptBtn" type="button">Open MCQ Machine</button>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="copyPromptBtn">Copy prompt for GPT</button>
            <button class="btn secondary" id="clearBtn" type="button">Clear</button>
          </div>

          <div class="status" id="status">Ready.</div>

          <div class="step" style="margin-top:18px;"><b>2</b><div><strong>Paste the generated MCQ JSON</strong> from the GPT and load the quiz.</div></div>
          <label for="mcqJson">MCQ JSON</label>
          <textarea id="mcqJson" placeholder="Paste JSON here (the GPT must output ONLY valid JSON matching the required schema)."></textarea>

          <div class="actions">
            <button class="btn" id="loadBtn" type="button">Load quiz</button>
            <button class="btn secondary" id="sampleBtn" type="button">Insert sample JSON</button>
          </div>

          <div class="mini" style="margin-top:10px;">
            Math is supported with <span class="kbd">$...$</span> or <span class="kbd">$$...$$</span> inside stems/options/rationales.
          </div>
        </section>

        <section class="card">
          <h2>Output requirements (for the GPT)</h2>
          <div class="muted" style="font-size:14.5px;">
            <p style="margin:0 0 10px;">Your GPT must return <strong>ONLY JSON</strong> with:</p>
            <ul style="margin:0; padding-left:18px;">
              <li><strong>Exactly</strong> the MCQ count requested.</li>
              <li>Four options (<strong>A–D</strong>), one best answer, no all/none-of-the-above.</li>
              <li>Rationales for the best answer and for each distractor.</li>
            </ul>
            <p style="margin:10px 0 0;">If the JSON fails to load here, it’s almost always because extra text was included around the JSON.</p>
          </div>
        </section>
      </div>

      <section class="card quiz" id="quizCard">
        <h2>Quiz</h2>
        <div class="questions" id="questions"></div>
        <div class="actions">
          <button class="btn" id="submitBtn" type="button">Submit answers</button>
          <button class="btn secondary" id="resetBtn" type="button">Reset</button>
        </div>
        <div class="results" id="results"></div>
      </section>
    </div>
  </main>

  <footer>
    Static classroom tool. No API keys. MCQ generation happens in your GPT; this page renders the quiz and feedback.
  </footer>

<script>
  const GPT_URL = "https://chatgpt.com/g/g-6982be1a28bc8191a58c17da12247ba2-mcq-machine";

  // Required JSON shape (loose validation; strict validation belongs in the GPT).
  function isValidMcqPayload(obj) {
    if (!obj || typeof obj !== 'object') return false;
    if (!Array.isArray(obj.questions) || obj.questions.length < 1) return false;
    if (!obj.title || typeof obj.title !== 'string') return false;
    if (!obj.inferred_level || typeof obj.inferred_level !== 'string') return false;
    for (const q of obj.questions) {
      if (!q || typeof q !== 'object') return false;
      if (typeof q.id !== 'number') return false;
      if (typeof q.stem !== 'string') return false;
      if (!q.options || typeof q.options !== 'object') return false;
      for (const L of ['A','B','C','D']) {
        if (typeof q.options[L] !== 'string') return false;
      }
      if (!['A','B','C','D'].includes(q.correct)) return false;
      if (typeof q.rationale_correct !== 'string') return false;
      if (!q.rationale_wrong || typeof q.rationale_wrong !== 'object') return false;
      for (const L of ['A','B','C','D']) {
        if (typeof q.rationale_wrong[L] !== 'string') return false;
      }
    }
    return true;
  }

  const el = (id) => document.getElementById(id);
  const statusEl = el('status');
  const quizCard = el('quizCard');
  const questionsWrap = el('questions');
  const resultsWrap = el('results');

  const copyPromptBtn = el('copyPromptBtn');
  const openGptBtn = el('openGptBtn');
  const clearBtn = el('clearBtn');
  const loadBtn = el('loadBtn');
  const sampleBtn = el('sampleBtn');
  const submitBtn = el('submitBtn');
  const resetBtn = el('resetBtn');

  let mcqData = null;

  function setStatus(msg, kind) {
    statusEl.textContent = msg;
    statusEl.className = 'status' + (kind === 'error' ? ' error' : kind === 'ok' ? ' ok' : '');
  }

  function escapeHtml(s) {
    return s.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#039;');
  }

  function renderMath(container) {
    if (typeof renderMathInElement !== 'function') return;
    renderMathInElement(container, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false },
        { left: '\(', right: '\)', display: false },
        { left: '\[', right: '\]', display: true }
      ],
      throwOnError: false
    });
  }

  function buildQuiz(mcq) {
    questionsWrap.innerHTML = '';
    resultsWrap.style.display = 'none';
    resultsWrap.innerHTML = '';

    const qs = mcq.questions.slice().sort((a,b) => a.id - b.id);

    qs.forEach((q) => {
      const qDiv = document.createElement('div');
      qDiv.className = 'q';
      qDiv.dataset.qid = String(q.id);

      const head = document.createElement('div');
      head.className = 'qhead';
      head.innerHTML = `<div class=\"qnum\">Question ${q.id}</div>`;

      const stem = document.createElement('div');
      stem.className = 'stem';
      stem.innerHTML = escapeHtml(q.stem);

      qDiv.appendChild(head);
      qDiv.appendChild(stem);

      ['A','B','C','D'].forEach((L) => {
        const opt = document.createElement('label');
        opt.className = 'opt';
        opt.innerHTML = `
          <div><input type=\"radio\" name=\"q${q.id}\" value=\"${L}\" /></div>
          <div>
            <div class=\"letter\">${L}.</div>
            <div>${escapeHtml(q.options[L])}</div>
          </div>
        `;
        qDiv.appendChild(opt);
      });

      questionsWrap.appendChild(qDiv);
      renderMath(qDiv);
    });

    quizCard.style.display = 'block';
    setStatus('Quiz loaded. Answer and submit.', 'ok');
  }

  function collectAnswers() {
    const answers = new Map();
    for (const q of mcqData.questions) {
      const chosen = document.querySelector(`input[name=\"q${q.id}\"]:checked`);
      answers.set(q.id, chosen ? chosen.value : null);
    }
    return answers;
  }

  function gradeQuiz() {
    const answers = collectAnswers();
    let correctCount = 0;

    const graded = mcqData.questions
      .slice()
      .sort((a,b) => a.id - b.id)
      .map((q) => {
        const chosen = answers.get(q.id);
        const isCorrect = chosen === q.correct;
        if (isCorrect) correctCount += 1;
        return { q, chosen, isCorrect };
      });

    const total = graded.length;

    resultsWrap.style.display = 'block';
    resultsWrap.innerHTML = '';

    const summary = document.createElement('div');
    summary.className = 'score';
    summary.textContent = `Score: ${correctCount} / ${total}`;
    resultsWrap.appendChild(summary);

    graded.forEach(({q, chosen, isCorrect}) => {
      const box = document.createElement('div');
      box.className = 'explain';

      const badge = isCorrect
        ? '<span class=\"badge ok\">Correct</span>'
        : '<span class=\"badge bad\">Incorrect</span>';

      const chosenText = chosen ? `${chosen}. ${escapeHtml(q.options[chosen])}` : 'No answer selected';
      const correctText = `${q.correct}. ${escapeHtml(q.options[q.correct])}`;

      box.innerHTML = `
        <div style=\"font-weight:700;\">Question ${q.id} ${badge}</div>
        <div style=\"margin-top:6px;\">${escapeHtml(q.stem)}</div>
        <div style=\"margin-top:10px;\"><b>Your answer:</b> ${chosenText}</div>
        <div style=\"margin-top:6px;\"><b>Best answer:</b> ${correctText}</div>
        <details>
          <summary>Rationales</summary>
          <div style=\"margin-top:8px;\"><b>Why the best answer is best:</b> ${escapeHtml(q.rationale_correct)}</div>
          <div style=\"margin-top:10px;\"><b>Why each option is wrong (or not best):</b></div>
          <ul style=\"margin:6px 0 0; padding-left:18px;\">
            <li><b>A:</b> ${escapeHtml(q.rationale_wrong.A)}</li>
            <li><b>B:</b> ${escapeHtml(q.rationale_wrong.B)}</li>
            <li><b>C:</b> ${escapeHtml(q.rationale_wrong.C)}</li>
            <li><b>D:</b> ${escapeHtml(q.rationale_wrong.D)}</li>
          </ul>
        </details>
      `;

      resultsWrap.appendChild(box);
      renderMath(box);
    });

    renderMath(resultsWrap);
  }

  function resetQuiz() {
    if (!mcqData) return;
    document.querySelectorAll('input[type=\"radio\"]').forEach(r => r.checked = false);
    resultsWrap.style.display = 'none';
    resultsWrap.innerHTML = '';
    setStatus('Reset.', 'ok');
  }

  openGptBtn.addEventListener('click', () => window.open(GPT_URL, '_blank', 'noopener'));
  el('gptInline').addEventListener('click', (e) => { e.preventDefault(); window.open(GPT_URL, '_blank', 'noopener'); });

  copyPromptBtn.addEventListener('click', async () => {
    const text = (el('refText').value || '').trim();
    const n = Number(el('count').value);

    if (!text) { setStatus('Paste reference text first.', 'error'); return; }
    if (!Number.isFinite(n) || n < 1 || n > 100) { setStatus('Choose 1–100 MCQs.', 'error'); return; }

    const prompt = `You are a professional assessment item writer for formal education assessments spanning early elementary through pre-university.

Generate exactly ${n} high-quality multiple-choice questions (MCQs) strictly and only from the reference text below.

MANDATORY:
- Four options labeled A–D
- Exactly one best answer
- No 'All of the above' or 'None of the above'
- Distractors must be plausible and mutually exclusive; no length/grammar clues
- Infer level from the text and match wording/difficulty appropriately

OUTPUT (MANDATORY):
Return ONLY valid JSON in this exact structure (no extra text):
{
  "title": "...",
  "inferred_level": "early elementary|upper elementary|secondary|pre-university",
  "questions": [
    {
      "id": 1,
      "stem": "...",
      "options": {"A": "...", "B": "...", "C": "...", "D": "..."},
      "correct": "A|B|C|D",
      "rationale_correct": "...",
      "rationale_wrong": {"A": "...", "B": "...", "C": "...", "D": "..."}
    }
  ]
}

REFERENCE TEXT:
${text}`;

    try {
      await navigator.clipboard.writeText(prompt);
      setStatus('Prompt copied. Paste into MCQ Machine.', 'ok');
    } catch {
      setStatus('Clipboard blocked. Select and copy the prompt manually.', 'error');
    }
  });

  loadBtn.addEventListener('click', () => {
    const raw = (el('mcqJson').value || '').trim();
    if (!raw) { setStatus('Paste MCQ JSON first.', 'error'); return; }

    try {
      const parsed = JSON.parse(raw);
      if (!isValidMcqPayload(parsed)) {
        setStatus('JSON parsed, but it does not match the required MCQ structure.', 'error');
        return;
      }
      mcqData = parsed;
      buildQuiz(mcqData);
      setStatus('Quiz loaded successfully.', 'ok');
    } catch (e) {
      setStatus('Invalid JSON. Ensure you pasted ONLY the JSON (no extra text).', 'error');
    }
  });

  submitBtn.addEventListener('click', () => {
    if (!mcqData) { setStatus('Load a quiz first.', 'error'); return; }
    gradeQuiz();
    setStatus('Submitted. Review the annotated key below.', 'ok');
  });

  resetBtn.addEventListener('click', resetQuiz);

  clearBtn.addEventListener('click', () => {
    el('refText').value = '';
    el('count').value = 10;
    el('mcqJson').value = '';
    mcqData = null;
    questionsWrap.innerHTML = '';
    resultsWrap.innerHTML = '';
    resultsWrap.style.display = 'none';
    quizCard.style.display = 'none';
    setStatus('Cleared.', 'ok');
  });

  sampleBtn.addEventListener('click', () => {
    const sample = {
      title: "Sample MCQ Set",
      inferred_level: "secondary",
      questions: [
        {
          id: 1,
          stem: "Which expression simplifies to $2x + 3$?",
          options: {
            A: "$(x + 3) + x$",
            B: "$(2x)(3)$",
            C: "$x + (3x)$",
            D: "$2(x + 3)$"
          },
          correct: "A",
          rationale_correct: "$(x+3)+x = x + x + 3 = 2x + 3$.",
          rationale_wrong: {
            A: "Correct: combines like terms to $2x+3$.",
            B: "$(2x)(3)=6x$, missing the constant term.",
            C: "$x+3x=4x$, not $2x+3$.",
            D: "$2(x+3)=2x+6$, constant is too large."
          }
        }
      ]
    };
    el('mcqJson').value = JSON.stringify(sample, null, 2);
    setStatus('Sample JSON inserted. Click “Load quiz”.', 'ok');
  });

  setStatus('Ready.', null);
</script>
</body>
</html>
