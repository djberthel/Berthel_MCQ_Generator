<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Berthel's Biology</title>
  <style>
    :root{
      --bg:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --panel:#ffffff;
      --soft:#f9fafb;
      --ok:#15803d;      /* green */
      --bad:#b91c1c;     /* red */
      --accent:#111827;  /* keep monochrome */
      --radius:14px;
    }

    /* Latin Modern (if installed); otherwise clean serif fallback */
    html,body{
      height:100%;
      background:var(--bg);
      color:var(--ink);
      font-family:"Latin Modern Roman","LatinModernRoman","Computer Modern Serif","Times New Roman",serif;
      font-size:16px;
      line-height:1.35;
    }
    *{ box-sizing:border-box; }
    a{ color:inherit; text-decoration:none; }
    button,input,textarea{ font:inherit; }

    .wrap{
      max-width: 1020px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }
    .avatar{
      width:44px;
      height:44px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--soft);
      object-fit:cover;
      flex:0 0 auto;
    }
    .titlebox{
      min-width: 0;
    }
    .title{
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .2px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      margin:2px 0 0;
      color:var(--muted);
      font-size: 13.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .version{
      color:var(--muted);
      font-size: 13px;
      white-space:nowrap;
      padding-left:10px;
      border-left:1px solid var(--line);
    }

    nav{
      margin-top: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding: 10px 10px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
    }
    .tabbtn{
      border:1px solid var(--line);
      background: var(--bg);
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:600;
      color: var(--ink);
    }
    .tabbtn[aria-selected="true"]{
      background: var(--ink);
      color: var(--bg);
      border-color: var(--ink);
    }

    main{
      margin-top: 12px;
    }
    section{
      display:none;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      padding: 14px;
    }
    section.active{ display:block; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--bg);
      padding: 12px;
    }

    .label{
      display:block;
      color:var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
      font-weight:600;
    }

    .num{
      width: 140px;
      padding: 10px 10px;
      border:1px solid var(--line);
      border-radius: 12px;
      background: var(--bg);
      outline:none;
    }
    .num:focus{ border-color:#cbd5e1; }

    .btn{
      border:1px solid var(--line);
      background: var(--bg);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{
      background: var(--ink);
      border-color: var(--ink);
      color: var(--bg);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .quiet{
      color:var(--muted);
      font-size: 13px;
      margin: 8px 0 0;
    }

    /* Quiz */
    .quizTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 10px;
    }
    .progress{
      color:var(--muted);
      font-size: 13px;
      font-weight:600;
    }
    .qstem{
      font-size: 18px;
      font-weight: 800;
      margin: 8px 0 12px;
    }
    .options{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px;
      background: var(--bg);
      cursor:pointer;
    }
    .opt input{ margin-top:3px; }
    .opt .otxt{
      flex:1;
      color: var(--ink);
      font-size: 15px;
    }
    .quizActions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .hintBad{
      color: var(--bad);
      font-size: 13px;
      font-weight:700;
    }

    /* Summary */
    .summaryHeader{
      display:flex;
      gap:12px;
      align-items:baseline;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .scoreBig{
      font-size: 20px;
      font-weight: 900;
      margin:0;
    }
    .scoreMeta{
      color:var(--muted);
      font-size: 13px;
      font-weight:700;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding: 6px 10px;
      font-size: 13px;
      font-weight:800;
      background: var(--soft);
    }
    .pill.ok{ color: var(--ok); border-color: rgba(21,128,61,.25); background: rgba(21,128,61,.06); }
    .pill.bad{ color: var(--bad); border-color: rgba(185,28,28,.25); background: rgba(185,28,28,.06); }

    .reviewList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .reviewItem{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      background: var(--bg);
    }
    .reviewItem.ok{ border-color: rgba(21,128,61,.25); background: rgba(21,128,61,.04); }
    .reviewItem.bad{ border-color: rgba(185,28,28,.25); background: rgba(185,28,28,.04); }
    .reviewTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom: 6px;
    }
    .reviewQ{
      font-weight:900;
      font-size: 14px;
    }
    .mark{
      font-weight:900;
      font-size: 13px;
      white-space:nowrap;
    }
    .mark.ok{ color: var(--ok); }
    .mark.bad{ color: var(--bad); }
    .reviewLine{
      color: var(--ink);
      font-size: 13.5px;
      margin: 4px 0;
    }
    .reviewLine .k{ color: var(--muted); font-weight:800; }
    .reviewLine .v{ color: var(--ink); }

    /* Home updates */
    .updates{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .update{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      background: var(--bg);
    }
    .updateTime{
      color:var(--muted);
      font-size: 12.5px;
      font-weight:800;
      margin-bottom: 6px;
    }
    .updateMsg{
      margin:0;
      font-size: 14px;
    }

    /* Admin panel (hidden by default; unlock via Ctrl+Shift+U) */
    .admin{
      display:none;
      margin-top: 12px;
    }
    .admin.show{ display:block; }
    textarea{
      width:100%;
      min-height:110px;
      padding:10px;
      border:1px solid var(--line);
      border-radius: 12px;
      outline:none;
      resize:vertical;
      background: var(--bg);
    }

    /* “Bank missing” bar only shows if needed */
    .bar{
      display:none;
      margin-top: 10px;
      padding: 10px;
      border:1px solid rgba(185,28,28,.25);
      background: rgba(185,28,28,.06);
      border-radius: var(--radius);
      color: var(--bad);
      font-weight:800;
      font-size: 13px;
    }
    .bar.show{ display:block; }
    .bar .row{ margin-top: 8px; }

    /* Small screens */
    @media (max-width:520px){
      .version{ border-left:none; padding-left:0; }
      header{ align-items:flex-start; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img id="avatar" class="avatar" src="Chinstrap_LOgo.jfif" alt="Avatar" />
        <div class="titlebox">
          <p class="title">Berthel's Biology</p>
          <p class="subtitle">Professional student testing and review workspace.</p>
        </div>
      </div>
      <div class="version" id="version"></div>
    </header>

    <nav role="tablist" aria-label="Sections">
      <button class="tabbtn" id="tab-home" role="tab" aria-selected="true" aria-controls="home">Home</button>
      <button class="tabbtn" id="tab-ety" role="tab" aria-selected="false" aria-controls="ety">Etymology & Vocabulary</button>
      <button class="tabbtn" id="tab-custom" role="tab" aria-selected="false" aria-controls="custom">MCQ Content</button>
    </nav>

    <main>
      <!-- HOME -->
      <section id="home" class="active" role="tabpanel" aria-labelledby="tab-home">
        <div class="card">
          <div class="label">Update notes</div>
          <div id="updates" class="updates"></div>

          <div id="adminPanel" class="admin">
            <div style="height:10px"></div>
            <div class="label">Add update (admin)</div>
            <textarea id="adminMsg" placeholder="Write an update note."></textarea>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="postUpdate">Post update</button>
              <button class="btn" id="downloadUpdates">Download updates.json</button>
              <input type="file" id="importUpdatesFile" accept="application/json" style="display:none" />
              <button class="btn" id="importUpdates">Import updates.json</button>
            </div>
            <p class="quiet">Posted updates are timestamped (UTC+8) at the moment of posting.</p>
          </div>
        </div>
      </section>

      <!-- ETY/VOCAB -->
      <section id="ety" role="tabpanel" aria-labelledby="tab-ety">
        <div class="card">
          <div class="row">
            <div>
              <span class="label">Number of questions (1–100)</span>
              <input id="etyN" class="num" type="number" inputmode="numeric" min="1" max="100" step="1" value="20" />
            </div>
            <div style="flex:1; min-width:240px">
              <div class="label">Status</div>
              <div id="etyStatus" class="quiet">Loading question bank…</div>
            </div>
          </div>

          <div id="bankBar" class="bar">
            The question bank could not be auto-loaded. If you are opening this as a local file, use a local web server, or select the bank file once below.
            <div class="row">
              <input type="file" id="bankFile" accept=".txt,text/plain" />
            </div>
          </div>

          <div style="height:12px"></div>
          <div id="etyView"></div>
        </div>
      </section>

      <!-- CUSTOM MCQ -->
      <section id="custom" role="tabpanel" aria-labelledby="tab-custom">
        <div class="card">
          <div class="row">
            <div style="flex:1; min-width:260px">
              <span class="label">Paste MCQ JSON</span>
              <textarea id="customJson" placeholder=""></textarea>
            </div>
            <div style="min-width:220px">
              <span class="label">Or upload JSON file</span>
              <input type="file" id="customFile" accept="application/json,.json" />
              <div style="height:12px"></div>
              <span class="label">Number of questions (1–100)</span>
              <input id="customN" class="num" type="number" inputmode="numeric" min="1" max="100" step="1" value="20" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="customLoad">Load JSON</button>
            <div id="customStatus" class="quiet">Awaiting JSON…</div>
          </div>

          <div style="height:12px"></div>
          <div id="customView"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    /********************
     * Build/version
     ********************/
    const BUILD_VERSION = "2026-02-10 15:06:41 (UTC+8)"; // build timestamp (Beijing time)
    document.getElementById("version").textContent = "v" + BUILD_VERSION;

    /********************
     * Avatar fallback
     ********************/
    const AVATAR_FALLBACK_DATA_URL = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQE%0ABQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRQBAwME%0ADgQHBgkIBwkUDQsMFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU%0AFBQUFBQUFBQUFBQUFBQUFP/AABEIAQ0A+gMBIgACEQEDEQH/xAAbAAEAAgMBAQAA%0AAAAAAAAAAAAGBQcBAgMEB//EADoQAAIBAgQDBQYEBwAAAAAAAAECAwQRAAUSITFB%0ABhMiUWEHMoGRoRQjQlNiscHR8BVCYv/EABcBAQEBAQAAAAAAAAAAAAAAAAABAgP/%0AxAAhEQEBAQEAAgIDAQAAAAAAAAABEQIhAxIxQVEiMmFxkf/aAAwDAQACEQMRAD8A%0A9u0pV5I9kqm5wK8GJxHkqQ8E1Y3p6y+6o8JqF0cKk0YwW2zZbG3mI8fQnR3iYh8o%0Alq4k3h7p8N8bT5p3c5c3m0n9oBv6m4+S1x7m2q0fH2l9t2g2Lw2qgQpJH2c0j5cI%0A3VJf0yQ8b4nXKXqE7H6z1y2t3l1m7QbZ7bqB7VQ4xQH4u3m5w7Y1zv5bOq8f7g5%0Ap+4s0m3b0G2v2aYb5qUoUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpU%0AqVKlSpUqVKlSpUqVKlf/2Q==";

    const avatar = document.getElementById("avatar");
    avatar.addEventListener("error", () => {
      avatar.src = AVATAR_FALLBACK_DATA_URL;
    }, { once:true });

    /********************
     * Tabs
     ********************/
    const tabs = [
      {btn:"tab-home", panel:"home"},
      {btn:"tab-ety", panel:"ety"},
      {btn:"tab-custom", panel:"custom"},
    ];
    function setTab(panelId){
      for (const t of tabs){
        const b = document.getElementById(t.btn);
        const p = document.getElementById(t.panel);
        const on = (t.panel === panelId);
        b.setAttribute("aria-selected", on ? "true" : "false");
        p.classList.toggle("active", on);
      }
    }
    for (const t of tabs){
      document.getElementById(t.btn).addEventListener("click", () => setTab(t.panel));
    }

    /********************
     * Time helpers (UTC+8)
     ********************/
    function beijingStamp(){
      const d = new Date();
      const s = d.toLocaleString("sv-SE", {
        timeZone: "Asia/Shanghai",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit",
        hour12:false
      });
      // sv-SE gives "YYYY-MM-DD HH:MM:SS"
      return s.replace(",", "");
    }

    /********************
     * Home updates (site-wide requires updates.json on server; localStorage for authoring)
     ********************/
    const UPDATES_KEY = "bertBio_updates_v2";
    const UPDATES_JSON_PATH = "updates.json";
    const DEFAULT_UPDATES = [
      {
        ts: "2026-02-10 15:06:41",
        msg: "Next update: repaired numeric input handling (all integers 1–100), improved submission flow, and a clearer results summary with red/green indicators plus retry/new-quiz options."
      }
    ];

    function renderUpdates(list){
      const box = document.getElementById("updates");
      box.innerHTML = "";
      if (!list.length){
        const empty = document.createElement("div");
        empty.className = "quiet";
        empty.textContent = "No updates posted.";
        box.appendChild(empty);
        return;
      }
      for (const u of list.slice().sort((a,b)=> (a.ts < b.ts ? 1 : -1))){
        const el = document.createElement("div");
        el.className = "update";
        const t = document.createElement("div");
        t.className = "updateTime";
        t.textContent = u.ts + " (UTC+8)";
        const p = document.createElement("p");
        p.className = "updateMsg";
        p.textContent = u.msg;
        el.appendChild(t);
        el.appendChild(p);
        box.appendChild(el);
      }
    }

    async function loadUpdates(){
      // Prefer server updates.json if present; otherwise localStorage; otherwise default.
      let fromServer = null;
      try{
        const r = await fetch(UPDATES_JSON_PATH, { cache:"no-store" });
        if (r.ok){
          const j = await r.json();
          if (Array.isArray(j)) fromServer = j;
          else if (j && Array.isArray(j.updates)) fromServer = j.updates;
        }
      }catch(_){}

      if (fromServer && fromServer.length){
        renderUpdates(fromServer);
        return fromServer;
      }

      const raw = localStorage.getItem(UPDATES_KEY);
      if (raw){
        try{
          const list = JSON.parse(raw);
          if (Array.isArray(list)){
            renderUpdates(list);
            return list;
          }
        }catch(_){}
      }
      renderUpdates(DEFAULT_UPDATES);
      return DEFAULT_UPDATES.slice();
    }

    let updatesState = [];
    loadUpdates().then(list => updatesState = list);

    // Admin unlock (client-side; intended for authoring convenience)
    const ADMIN_PANEL = document.getElementById("adminPanel");
    const ADMIN_KEY = "BERTHEL_ADMIN"; // change if you want
    let adminUnlocked = false;

    window.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.shiftKey && e.code === "KeyU"){
        const k = prompt("Admin key:");
        if (k === ADMIN_KEY){
          adminUnlocked = true;
          ADMIN_PANEL.classList.add("show");
        }
      }
    });

    document.getElementById("postUpdate").addEventListener("click", () => {
      if (!adminUnlocked) return;
      const ta = document.getElementById("adminMsg");
      const msg = (ta.value || "").trim();
      if (!msg) return;

      const entry = { ts: beijingStamp(), msg };
      updatesState = [entry, ...updatesState];
      localStorage.setItem(UPDATES_KEY, JSON.stringify(updatesState));
      ta.value = "";
      renderUpdates(updatesState);
    });

    document.getElementById("downloadUpdates").addEventListener("click", () => {
      if (!adminUnlocked) return;
      const blob = new Blob([JSON.stringify(updatesState, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "updates.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    });

    document.getElementById("importUpdates").addEventListener("click", () => {
      if (!adminUnlocked) return;
      document.getElementById("importUpdatesFile").click();
    });
    document.getElementById("importUpdatesFile").addEventListener("change", async (e) => {
      if (!adminUnlocked) return;
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try{
        const text = await f.text();
        const j = JSON.parse(text);
        const list = Array.isArray(j) ? j : (j && Array.isArray(j.updates) ? j.updates : null);
        if (list){
          updatesState = list;
          localStorage.setItem(UPDATES_KEY, JSON.stringify(updatesState));
          renderUpdates(updatesState);
        }
      }catch(_){}
      e.target.value = "";
    });

    /********************
     * Shared quiz renderer (minimal, student-facing)
     ********************/
    function clampInt(v, lo, hi){
      const n = Math.trunc(Number(v));
      if (!Number.isFinite(n)) return lo;
      return Math.max(lo, Math.min(hi, n));
    }

    function shuffle(arr){
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function escapeSpaces(s){
      return (s || "").replace(/\s+/g, " ").trim();
    }

    function mkQuizUI(mount){
      mount.innerHTML = "";
      const holder = document.createElement("div");
      holder.className = "card";
      mount.appendChild(holder);
      return holder;
    }

    function renderQuiz(holder, quizState){
      // quizState: { title, questions:[{stem, options[], correctIndex, rationale?}], idx, answers[] }
      holder.innerHTML = "";

      const q = quizState.questions[quizState.idx];

      const top = document.createElement("div");
      top.className = "quizTop";

      const left = document.createElement("div");
      const prog = document.createElement("div");
      prog.className = "progress";
      prog.textContent = `Question ${quizState.idx + 1} of ${quizState.questions.length}`;
      const stem = document.createElement("div");
      stem.className = "qstem";
      stem.textContent = q.stem;
      left.appendChild(prog);
      left.appendChild(stem);

      const right = document.createElement("div");
      right.className = "row";
      right.style.justifyContent = "flex-end";

      const changeN = document.createElement("button");
      changeN.className = "btn";
      changeN.textContent = "Change number";
      changeN.addEventListener("click", () => quizState.onExit?.());
      right.appendChild(changeN);

      top.appendChild(left);
      top.appendChild(right);

      const opts = document.createElement("div");
      opts.className = "options";

      const selected = quizState.answers[quizState.idx] ?? null;

      q.options.forEach((txt, i) => {
        const lab = document.createElement("label");
        lab.className = "opt";

        const inp = document.createElement("input");
        inp.type = "radio";
        inp.name = "opt";
        inp.value = String(i);
        if (selected === i) inp.checked = true;

        const span = document.createElement("div");
        span.className = "otxt";
        span.textContent = txt;

        lab.appendChild(inp);
        lab.appendChild(span);

        lab.addEventListener("click", (e) => {
          // label default ok
          quizState.answers[quizState.idx] = i;
          hint.textContent = "";
        });

        opts.appendChild(lab);
      });

      const actions = document.createElement("div");
      actions.className = "quizActions";

      const hint = document.createElement("div");
      hint.className = "hintBad";

      const back = document.createElement("button");
      back.className = "btn";
      back.textContent = "Back";
      back.disabled = (quizState.idx === 0);
      back.addEventListener("click", () => {
        quizState.idx -= 1;
        renderQuiz(holder, quizState);
      });

      const next = document.createElement("button");
      next.className = "btn primary";
      const isLast = (quizState.idx === quizState.questions.length - 1);
      next.textContent = isLast ? "Finish" : "Next";
      next.addEventListener("click", () => {
        const a = quizState.answers[quizState.idx];
        if (a === undefined || a === null){
          hint.textContent = "Select an answer to continue.";
          return;
        }
        if (isLast){
          quizState.onFinish?.();
        }else{
          quizState.idx += 1;
          renderQuiz(holder, quizState);
        }
      });

      actions.appendChild(back);
      actions.appendChild(hint);
      actions.appendChild(next);

      holder.appendChild(top);
      holder.appendChild(opts);
      holder.appendChild(actions);
    }

    function renderSummary(holder, quizState){
      holder.innerHTML = "";

      const total = quizState.questions.length;
      let correct = 0;
      for (let i=0;i<total;i++){
        if (quizState.answers[i] === quizState.questions[i].correctIndex) correct++;
      }
      const pct = Math.round((correct / total) * 100);

      const head = document.createElement("div");
      head.className = "summaryHeader";

      const h1 = document.createElement("p");
      h1.className = "scoreBig";
      h1.textContent = "Results";

      const meta = document.createElement("div");
      meta.className = "scoreMeta";
      meta.textContent = `${correct} / ${total} (${pct}%)`;

      const p1 = document.createElement("span");
      p1.className = "pill " + (pct >= 70 ? "ok" : "bad");
      p1.textContent = (pct >= 70 ? "Strong" : "Needs work");

      const p2 = document.createElement("span");
      p2.className = "pill";
      p2.textContent = "Submission complete";

      head.appendChild(h1);
      head.appendChild(meta);
      head.appendChild(p1);
      head.appendChild(p2);

      const actions = document.createElement("div");
      actions.className = "row";
      actions.style.marginTop = "8px";

      const retry = document.createElement("button");
      retry.className = "btn";
      retry.textContent = "Retry same quiz";
      retry.addEventListener("click", () => {
        quizState.idx = 0;
        quizState.answers = new Array(total).fill(null);
        quizState.onRetrySame?.();
      });

      const newq = document.createElement("button");
      newq.className = "btn primary";
      newq.textContent = "Generate new quiz";
      newq.addEventListener("click", () => quizState.onNewQuiz?.());

      actions.appendChild(retry);
      actions.appendChild(newq);

      const list = document.createElement("div");
      list.className = "reviewList";

      for (let i=0;i<total;i++){
        const qq = quizState.questions[i];
        const a = quizState.answers[i];
        const ok = (a === qq.correctIndex);

        const item = document.createElement("div");
        item.className = "reviewItem " + (ok ? "ok" : "bad");

        const top = document.createElement("div");
        top.className = "reviewTop";

        const qlbl = document.createElement("div");
        qlbl.className = "reviewQ";
        qlbl.textContent = `Q${i+1}: ${qq.stem}`;

        const mark = document.createElement("div");
        mark.className = "mark " + (ok ? "ok" : "bad");
        mark.textContent = ok ? "Correct" : "Incorrect";

        top.appendChild(qlbl);
        top.appendChild(mark);

        const your = document.createElement("div");
        your.className = "reviewLine";
        const yourK = document.createElement("span");
        yourK.className = "k";
        yourK.textContent = "Your answer: ";
        const yourV = document.createElement("span");
        yourV.className = "v";
        yourV.textContent = (a === null || a === undefined) ? "—" : qq.options[a];
        your.appendChild(yourK);
        your.appendChild(yourV);

        const cor = document.createElement("div");
        cor.className = "reviewLine";
        const corK = document.createElement("span");
        corK.className = "k";
        corK.textContent = "Correct answer: ";
        const corV = document.createElement("span");
        corV.className = "v";
        corV.textContent = qq.options[qq.correctIndex];
        cor.appendChild(corK);
        cor.appendChild(corV);

        const rat = document.createElement("div");
        rat.className = "reviewLine";
        const ratK = document.createElement("span");
        ratK.className = "k";
        ratK.textContent = "Rationale: ";
        const ratV = document.createElement("span");
        ratV.className = "v";
        ratV.textContent = ok
          ? "Matched the correct definition."
          : "Your selected definition belongs to a different term; use the correct definition as the reference.";
        rat.appendChild(ratK);
        rat.appendChild(ratV);

        item.appendChild(top);
        item.appendChild(your);
        item.appendChild(cor);
        item.appendChild(rat);

        list.appendChild(item);
      }

      holder.appendChild(head);
      holder.appendChild(actions);
      holder.appendChild(list);
    }

    /********************
     * ETY/VOCAB bank loading + quiz generation
     ********************/
    const BANK_TXT_PATH = "ib_bio_clean_index.txt";
    const etyStatus = document.getElementById("etyStatus");
    const bankBar = document.getElementById("bankBar");
    const bankFile = document.getElementById("bankFile");
    const etyN = document.getElementById("etyN");
    const etyView = document.getElementById("etyView");

    let etyBank = [];      // [{term, def}]
    let etyQuiz = null;    // current quizState
    let etyDebounce = null;

    function parseIndexText(text){
      const lines = (text || "").replace(/\r/g,"").split("\n");
      const items = [];
      let last = null;

      const dashRe = /^(.*?)\s*(?:—|–|-|:)\s*(.+)$/; // term — def (or : / - )
      const tabRe  = /^(.*?)\t+(.+)$/;

      for (let raw of lines){
        const line = raw.trimEnd();
        if (!line.trim()) continue;

        // Skip obvious headers
        const h = line.trim().toLowerCase();
        if (h === "glossary" || h.startsWith("words in blue")) continue;

        // Wrapped definition line (indented / no separator)
        if (/^\s+/.test(raw) && last){
          last.def = escapeSpaces(last.def + " " + line.trim());
          continue;
        }

        let m = line.match(tabRe);
        if (!m) m = line.match(dashRe);

        if (!m){
          // Try split at 2+ spaces (columns)
          const parts = line.split(/\s{2,}/);
          if (parts.length >= 2){
            const term = escapeSpaces(parts.shift());
            const def = escapeSpaces(parts.join(" "));
            if (term && def){
              last = { term, def };
              items.push(last);
            }
            continue;
          } else {
            // If it can't be parsed, ignore quietly
            continue;
          }
        }

        const term = escapeSpaces(m[1]);
        const def  = escapeSpaces(m[2]);
        if (!term || !def) continue;

        last = { term, def };
        items.push(last);
      }

      // Deduplicate by term (case-insensitive), keep longest definition
      const map = new Map();
      for (const it of items){
        const k = it.term.toLowerCase();
        if (!map.has(k) || (map.get(k).def.length < it.def.length)){
          map.set(k, it);
        }
      }
      const out = Array.from(map.values()).filter(x => x.term.length >= 2 && x.def.length >= 6);
      out.sort((a,b)=> a.term.localeCompare(b.term));
      return out;
    }

    async function tryLoadBankViaFetch(){
      try{
        const r = await fetch(BANK_TXT_PATH, { cache:"no-store" });
        if (!r.ok) throw new Error("fetch not ok");
        const t = await r.text();
        const parsed = parseIndexText(t);
        if (!parsed.length) throw new Error("empty parse");
        return parsed;
      }catch(_){
        return null;
      }
    }

    function setEtyStatus(){
      if (!etyBank.length){
        etyStatus.textContent = "Question bank not loaded.";
      }else{
        etyStatus.textContent = `Ready. Bank loaded: ${etyBank.length} terms.`;
      }
    }

    function makeEtyQuiz(n){
      // Clamp to bank size and 1..100
      const maxN = Math.min(100, etyBank.length);
      n = clampInt(n, 1, maxN);

      const pool = etyBank.slice();
      shuffle(pool);
      const pick = pool.slice(0, n);

      const questions = pick.map((item) => {
        // Correct definition + 3 distractor definitions
        const others = [];
        // sample distractors from different terms
        while (others.length < 3){
          const cand = etyBank[Math.floor(Math.random() * etyBank.length)];
          if (!cand) continue;
          if (cand.term === item.term) continue;
          if (others.some(x => x.term === cand.term)) continue;
          others.push(cand);
        }

        const opts = [
          item.def,
          others[0].def,
          others[1].def,
          others[2].def
        ];
        const idxs = [0,1,2,3];
        shuffle(idxs);
        const options = idxs.map(i => opts[i]);
        const correctIndex = options.indexOf(item.def);

        return {
          stem: item.term,
          options,
          correctIndex
        };
      });

      return questions;
    }

    function startEtyQuiz(n){
      if (!etyBank.length) return;

      const maxN = Math.min(100, etyBank.length);
      const nn = clampInt(n, 1, maxN);
      etyN.value = String(nn);

      const holder = mkQuizUI(etyView);
      const questions = makeEtyQuiz(nn);

      etyQuiz = {
        title: "Etymology & Vocabulary",
        questions,
        idx: 0,
        answers: new Array(questions.length).fill(null),
        onExit: () => { etyView.innerHTML = ""; },
        onFinish: () => {
          renderSummary(holder, etyQuiz);
        },
        onRetrySame: () => {
          renderQuiz(holder, etyQuiz);
        },
        onNewQuiz: () => {
          startEtyQuiz(etyN.value);
        }
      };

      renderQuiz(holder, etyQuiz);
    }

    function scheduleEtyAutoStart(){
      if (!etyBank.length) return;
      clearTimeout(etyDebounce);
      etyDebounce = setTimeout(() => startEtyQuiz(etyN.value), 450);
    }

    // Numeric input hardening (all integers 1–100)
    function hardenNumberInput(el){
      const fix = () => {
        const v = el.value;
        const n = clampInt(v, Number(el.min)||1, Number(el.max)||100);
        el.value = String(n);
      };
      el.addEventListener("blur", fix);
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter"){
          fix();
        }
      });
    }
    hardenNumberInput(etyN);

    etyN.addEventListener("input", () => {
      // Auto-generate after student selects a valid number
      scheduleEtyAutoStart();
    });

    bankFile.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const t = await f.text();
      const parsed = parseIndexText(t);
      if (parsed.length){
        etyBank = parsed;
        bankBar.classList.remove("show");
        setEtyStatus();
      }else{
        etyStatus.textContent = "Bank file loaded, but no usable entries were detected.";
      }
      e.target.value = "";
    });

    (async function initBank(){
      const parsed = await tryLoadBankViaFetch();
      if (parsed){
        etyBank = parsed;
        bankBar.classList.remove("show");
        setEtyStatus();
        // Auto-start with current value
        startEtyQuiz(etyN.value);
      }else{
        bankBar.classList.add("show");
        setEtyStatus();
      }
    })();

    /********************
     * CUSTOM JSON MCQ tab
     ********************/
    const customJson = document.getElementById("customJson");
    const customFile = document.getElementById("customFile");
    const customLoad = document.getElementById("customLoad");
    const customStatus = document.getElementById("customStatus");
    const customN = document.getElementById("customN");
    const customView = document.getElementById("customView");

    hardenNumberInput(customN);

    let customBank = []; // normalized questions
    let customQuiz = null;
    let customDebounce = null;

    function normalizeCustomJSON(obj){
      // Accept common forms:
      // 1) [{stem/question, options:[...], answer/correct:"A"/0, rationale/explanation}]
      // 2) {questions:[...]} or {items:[...]} etc.
      let arr = null;
      if (Array.isArray(obj)) arr = obj;
      else if (obj && Array.isArray(obj.questions)) arr = obj.questions;
      else if (obj && Array.isArray(obj.items)) arr = obj.items;
      if (!arr) return [];

      const out = [];
      for (const q of arr){
        if (!q) continue;
        const stem = escapeSpaces(q.stem || q.question || q.q || q.prompt || "");
        if (!stem) continue;

        let options = q.options || q.choices || q.answers || null;
        if (options && !Array.isArray(options) && typeof options === "object"){
          // {A:"..",B:"..",C:"..",D:".."}
          const keys = ["A","B","C","D"];
          const as = keys.map(k => options[k]).filter(Boolean);
          if (as.length >= 4) options = as.slice(0,4);
          else options = Object.values(options);
        }
        if (!Array.isArray(options) || options.length < 4) continue;

        options = options.slice(0,4).map(x => escapeSpaces(String(x)));

        let ans = q.answer ?? q.correct ?? q.key ?? q.correctAnswer ?? null;
        let correctIndex = null;
        if (typeof ans === "number"){
          correctIndex = ans;
        }else if (typeof ans === "string"){
          const s = ans.trim().toUpperCase();
          if (["A","B","C","D"].includes(s)){
            correctIndex = ["A","B","C","D"].indexOf(s);
          }else{
            // maybe exact option text
            const idx = options.indexOf(escapeSpaces(ans));
            if (idx >= 0) correctIndex = idx;
          }
        }

        if (correctIndex === null || correctIndex < 0 || correctIndex > 3){
          // If missing/invalid: skip (no silent “guessing”)
          continue;
        }

        const rationale = escapeSpaces(q.rationale || q.explanation || q.reason || "");
        out.push({ stem, options, correctIndex, rationale });
      }
      return out;
    }

    function loadCustomFromText(text){
      let obj = null;
      try{ obj = JSON.parse(text); }catch(_){ return null; }
      const norm = normalizeCustomJSON(obj);
      return norm.length ? norm : null;
    }

    function scheduleCustomAutoStart(){
      if (!customBank.length) return;
      clearTimeout(customDebounce);
      customDebounce = setTimeout(() => startCustomQuiz(customN.value), 450);
    }

    customN.addEventListener("input", () => scheduleCustomAutoStart());

    customFile.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const t = await f.text();
      const norm = loadCustomFromText(t);
      if (norm){
        customBank = norm;
        customStatus.textContent = `Loaded ${customBank.length} questions.`;
        customView.innerHTML = "";
        startCustomQuiz(customN.value);
      }else{
        customStatus.textContent = "Invalid JSON or unsupported structure.";
      }
      e.target.value = "";
    });

    customLoad.addEventListener("click", () => {
      const t = (customJson.value || "").trim();
      if (!t){
        customStatus.textContent = "Awaiting JSON…";
        return;
      }
      const norm = loadCustomFromText(t);
      if (norm){
        customBank = norm;
        customStatus.textContent = `Loaded ${customBank.length} questions.`;
        customView.innerHTML = "";
        startCustomQuiz(customN.value);
      }else{
        customStatus.textContent = "Invalid JSON or unsupported structure.";
      }
    });

    function startCustomQuiz(n){
      if (!customBank.length) return;

      const maxN = Math.min(100, customBank.length);
      const nn = clampInt(n, 1, maxN);
      customN.value = String(nn);

      const pool = customBank.slice();
      shuffle(pool);
      const questions = pool.slice(0, nn).map(q => ({
        stem: q.stem,
        options: q.options.slice(),
        correctIndex: q.correctIndex,
        rationale: q.rationale || ""
      }));

      const holder = mkQuizUI(customView);

      customQuiz = {
        title: "MCQ Content",
        questions,
        idx: 0,
        answers: new Array(questions.length).fill(null),
        onExit: () => { customView.innerHTML = ""; },
        onFinish: () => {
          // Override summary rationale to use provided rationale if available
          renderCustomSummary(holder, customQuiz);
        },
        onRetrySame: () => {
          renderQuiz(holder, customQuiz);
        },
        onNewQuiz: () => {
          startCustomQuiz(customN.value);
        }
      };

      renderQuiz(holder, customQuiz);
    }

    function renderCustomSummary(holder, quizState){
      holder.innerHTML = "";

      const total = quizState.questions.length;
      let correct = 0;
      for (let i=0;i<total;i++){
        if (quizState.answers[i] === quizState.questions[i].correctIndex) correct++;
      }
      const pct = Math.round((correct / total) * 100);

      const head = document.createElement("div");
      head.className = "summaryHeader";

      const h1 = document.createElement("p");
      h1.className = "scoreBig";
      h1.textContent = "Results";

      const meta = document.createElement("div");
      meta.className = "scoreMeta";
      meta.textContent = `${correct} / ${total} (${pct}%)`;

      const p1 = document.createElement("span");
      p1.className = "pill " + (pct >= 70 ? "ok" : "bad");
      p1.textContent = (pct >= 70 ? "Strong" : "Needs work");

      const p2 = document.createElement("span");
      p2.className = "pill";
      p2.textContent = "Submission complete";

      head.appendChild(h1);
      head.appendChild(meta);
      head.appendChild(p1);
      head.appendChild(p2);

      const actions = document.createElement("div");
      actions.className = "row";
      actions.style.marginTop = "8px";

      const retry = document.createElement("button");
      retry.className = "btn";
      retry.textContent = "Retry same quiz";
      retry.addEventListener("click", () => {
        quizState.idx = 0;
        quizState.answers = new Array(total).fill(null);
        renderQuiz(holder, quizState);
      });

      const newq = document.createElement("button");
      newq.className = "btn primary";
      newq.textContent = "Generate new quiz";
      newq.addEventListener("click", () => startCustomQuiz(customN.value));

      actions.appendChild(retry);
      actions.appendChild(newq);

      const list = document.createElement("div");
      list.className = "reviewList";

      for (let i=0;i<total;i++){
        const qq = quizState.questions[i];
        const a = quizState.answers[i];
        const ok = (a === qq.correctIndex);

        const item = document.createElement("div");
        item.className = "reviewItem " + (ok ? "ok" : "bad");

        const top = document.createElement("div");
        top.className = "reviewTop";

        const qlbl = document.createElement("div");
        qlbl.className = "reviewQ";
        qlbl.textContent = `Q${i+1}: ${qq.stem}`;

        const mark = document.createElement("div");
        mark.className = "mark " + (ok ? "ok" : "bad");
        mark.textContent = ok ? "Correct" : "Incorrect";

        top.appendChild(qlbl);
        top.appendChild(mark);

        const your = document.createElement("div");
        your.className = "reviewLine";
        const yourK = document.createElement("span");
        yourK.className = "k";
        yourK.textContent = "Your answer: ";
        const yourV = document.createElement("span");
        yourV.className = "v";
        yourV.textContent = (a === null || a === undefined) ? "—" : qq.options[a];
        your.appendChild(yourK);
        your.appendChild(yourV);

        const cor = document.createElement("div");
        cor.className = "reviewLine";
        const corK = document.createElement("span");
        corK.className = "k";
        corK.textContent = "Correct answer: ";
        const corV = document.createElement("span");
        corV.className = "v";
        corV.textContent = qq.options[qq.correctIndex];
        cor.appendChild(corK);
        cor.appendChild(corV);

        const rat = document.createElement("div");
        rat.className = "reviewLine";
        const ratK = document.createElement("span");
        ratK.className = "k";
        ratK.textContent = "Rationale: ";
        const ratV = document.createElement("span");
        ratV.className = "v";
        if (qq.rationale){
          ratV.textContent = qq.rationale;
        }else{
          ratV.textContent = ok
            ? "Selected the best-supported option."
            : "Incorrect selection; use the correct option as the reference answer.";
        }
        rat.appendChild(ratK);
        rat.appendChild(ratV);

        item.appendChild(top);
        item.appendChild(your);
        item.appendChild(cor);
        item.appendChild(rat);

        list.appendChild(item);
      }

      holder.appendChild(head);
      holder.appendChild(actions);
      holder.appendChild(list);
    }
  </script>
</body>
</html>
