<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Berthel's Biology — unified MCQ testing, logging, etymology/vocab practice, and IB text search." />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Berthel's Biology · Unified Workspace v2026.02.10</title>

  <style>
    :root{
      color-scheme: light;

      --bg:#f2f2f2;
      --surface:#ffffff;
      --ink:#101010;
      --muted:#4a4a4a;

      --line:#d6d6d6;
      --line-strong:#a6a6a6;

      --ok:#1f6a2f;
      --bad:#9a1f1f;

      --shadow: 0 10px 22px rgba(0,0,0,.06);

      --header0:#121212;
      --header1:#2b2b2b;

      --radius: 14px;
      --radius-sm: 10px;
      --radius-pill: 999px;

      --focus: rgba(255,255,255,.22);
      --focus-dark: rgba(0,0,0,.28);

      --tap: rgba(0,0,0,.04);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      line-height:1.5;
      text-rendering: optimizeLegibility;
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:0 20px; }

    /* Header */
    header{
      color:#fff;
      background: radial-gradient(1200px 500px at 20% 0%, #3a3a3a 0%, transparent 60%),
                  linear-gradient(180deg, var(--header0), var(--header1));
      border-bottom:1px solid #5f5f5f;
    }

    .hero{
      padding:22px 0;
      display:flex;
      align-items:center;
      gap:16px;
    }

    .avatar{
      width:86px;
      height:70px;               /* oval */
      border-radius: var(--radius-pill);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.35);
      background:#fff;
      flex: 0 0 auto;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit: cover;
      object-position: 55% 30%;
      display:block;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:16px;
      min-width: 0;
    }
    .brand-text{ min-width:0; }

    h1{
      margin:0;
      font-size:34px;
      letter-spacing:.2px;
      line-height: 1.1;
    }
    .subtitle{
      margin:8px 0 0;
      color:#e2e2e2;
      max-width: 920px;
      font-size: 15px;
    }

    .build-chip{
      margin-top:10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.38);
      border-radius: var(--radius-pill);
      background: rgba(0,0,0,.26);
      color:#f4f4f4;
      font-size:12px;
      letter-spacing:.35px;
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:#fff;
      opacity:.85;
    }

    /* Tabs */
    nav{
      position:sticky;
      top:0;
      z-index:10;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding:12px 0;
    }

    .tab-btn{
      border:1px solid var(--line-strong);
      border-radius: var(--radius-pill);
      background:#fff;
      color:#1f1f1f;
      padding:9px 14px;
      font-weight:900;
      cursor:pointer;
      transition: transform .05s ease, background .18s ease, border-color .18s ease, color .18s ease;
    }
    .tab-btn:hover{ background: #f6f6f6; }
    .tab-btn:active{ transform: translateY(1px); }

    .tab-btn[aria-selected="true"]{
      background:#161616;
      color:#fff;
      border-color:#161616;
    }
    .tab-btn:focus-visible{
      outline:3px solid var(--focus-dark);
      outline-offset:2px;
    }

    /* Layout */
    main{ padding:18px 0 44px; }

    .panel{ display:none; }
    .panel.active{ display:block; }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface);
      padding:18px;
      margin-bottom:16px;
      box-shadow: var(--shadow);
    }
    .card h2,.card h3{ margin:0 0 10px; }
    .card p{ margin: 10px 0 0; }

    .grid{ display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
    .subgrid{ display:grid; gap:14px; grid-template-columns: 2fr 1fr; }
    @media (max-width:920px){ .subgrid{ grid-template-columns:1fr; } }

    /* Forms */
    label{
      display:block;
      margin:10px 0 6px;
      font-weight:900;
      font-size:13px;
      color:var(--muted);
      letter-spacing:.2px;
    }

    input[type="number"], input[type="search"], textarea{
      width:100%;
      border:1px solid #b8b8b8;
      border-radius: var(--radius-sm);
      padding:11px 12px;
      font-size:15px;
      font-family:inherit;
      color: var(--ink);
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    /* Force number input text visibility across odd UA styles */
    input[type="number"]{
      font-weight:900;
      letter-spacing:.2px;
      appearance: textfield;
      -moz-appearance: textfield;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button{
      -webkit-appearance: none;
      margin: 0;
    }

    textarea{ min-height:170px; resize:vertical; }

    input:focus-visible, textarea:focus-visible{
      outline:3px solid var(--focus-dark);
      outline-offset:2px;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      align-items:center;
    }

    button, .btn{
      border:1px solid #1f1f1f;
      border-radius: var(--radius-sm);
      padding:9px 14px;
      font:inherit;
      font-weight:900;
      background:#fff;
      color:#1f1f1f;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      transition: transform .05s ease, background .18s ease, color .18s ease, border-color .18s ease;
    }
    button:hover, .btn:hover{ background:#f6f6f6; }
    button:active, .btn:active{ transform: translateY(1px); }
    button.primary, .btn.primary{
      background:#1a1a1a;
      color:#fff;
      border-color:#1a1a1a;
    }
    button.primary:hover, .btn.primary:hover{ background:#0f0f0f; }

    button:focus-visible, .btn:focus-visible{
      outline:3px solid var(--focus-dark);
      outline-offset:2px;
    }

    .status{
      color:var(--muted);
      font-size:13px;
      margin:8px 0 0;
    }
    .status.good{ color: var(--ok); font-weight:800; }
    .status.bad{ color: var(--bad); font-weight:800; }

    .hidden{ display:none !important; }

    /* MCQ blocks */
    .question{
      border:1px solid var(--line);
      border-radius: var(--radius-sm);
      background:#fafafa;
      padding:12px;
      margin:12px 0;
    }
    .question-head{
      font-weight:1000;
      margin-bottom:6px;
      letter-spacing:.2px;
    }

    .option{
      display:grid;
      grid-template-columns:28px 1fr;
      gap:10px;
      margin:8px 0;
      border:1px solid #cfcfcf;
      border-radius: 10px;
      background:#fff;
      padding:10px;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease;
    }
    .option:hover{ background: #fbfbfb; }
    .option:active{ background: #f4f4f4; }
    .option input{ margin-top:3px; }

    .score{ font-size:22px; font-weight:1000; margin:0 0 10px; }
    .correct{ color:var(--ok); font-weight:1000; }
    .incorrect{ color:var(--bad); font-weight:1000; }

    /* Details (JSON output) */
    details{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius: var(--radius-sm);
      background: #fbfbfb;
      padding: 10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight:1000;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    details[open] summary{ margin-bottom:8px; }

    /* Etymology panel: match header palette */
    .card.dark{
      border-color: rgba(255,255,255,.18);
      background: radial-gradient(1000px 420px at 18% 0%, #3a3a3a 0%, transparent 60%),
                  linear-gradient(180deg, #111, #2a2a2a);
      color: #f2f2f2;
      box-shadow: 0 16px 28px rgba(0,0,0,.14);
    }
    .card.dark .status{ color: #d6d6d6; }
    .card.dark h2{ color:#fff; }
    .card.dark iframe{
      border-color: rgba(255,255,255,.20);
      background:#fff;
    }

    iframe{
      width:100%;
      min-height:720px;
      border:1px solid var(--line);
      border-radius: var(--radius-sm);
      background:#fff;
    }

    /* Search results */
    .search-results{
      max-height:520px;
      overflow:auto;
      border:1px solid var(--line);
      border-radius: var(--radius-sm);
      background:#fff;
      margin-top:10px;
    }
    .result-item{
      padding:10px 12px;
      border-bottom:1px solid #ececec;
      font-size:14px;
      white-space:pre-wrap;
    }
    .result-item:last-child{ border-bottom:none; }

    /* Tables */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      background:#fff;
      border:1px solid var(--line);
      border-radius: var(--radius-sm);
      overflow:hidden;
      margin-top:10px;
    }
    thead th{
      position: sticky;
      top: 0;
      background:#f6f6f6;
      z-index: 1;
    }
    th,td{ border-bottom:1px solid #ececec; padding:8px 10px; text-align:left; }

    footer{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      padding:16px;
    }

    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:.95em;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap hero">
    <div class="brand">
      <!-- Avatar: photoreal chinstrap penguin, oval crop -->
      <div class="avatar" aria-label="Chinstrap penguin avatar">
        <picture>
          <source type="image/webp" srcset="chinstrap_avatar_256.webp?v=20260210">
          <source type="image/jpeg" srcset="chinstrap_avatar_256.jpg?v=20260210">
          <!-- Last-resort fallback to your original JFIF, if present -->
          <img src="Chinstrap_LOgo.jfif" alt="Chinstrap penguin portrait" loading="eager" decoding="async">
        </picture>
      </div>

      <div class="brand-text">
        <h1>Berthel's Biology</h1>
        <p class="subtitle">
          Professional student testing and review workspace. Answer MCQs, log attempts, review explanations,
          practice etymology/vocabulary, and search the full IB Biology text file.
        </p>
        <div class="build-chip"><span class="dot"></span>LIVE BUILD: Unified Workspace v2026.02.10</div>
      </div>
    </div>
  </div>
</header>

<nav>
  <div class="wrap tabs" role="tablist" aria-label="Workspace modules">
    <button class="tab-btn" role="tab" aria-selected="true" data-panel="dashboard" type="button">Dashboard</button>
    <button class="tab-btn" role="tab" aria-selected="false" data-panel="mcq" type="button">MCQ Test + Review</button>
    <button class="tab-btn" role="tab" aria-selected="false" data-panel="etymo" type="button">Etymology &amp; Vocab</button>
    <button class="tab-btn" role="tab" aria-selected="false" data-panel="glossary" type="button">IB Text Search</button>
  </div>
</nav>

<main class="wrap">
  <section class="panel active" id="dashboard">
    <div class="card">
      <h2>All Modules Ready</h2>
      <div class="grid">
        <div><strong>MCQ Generator:</strong><br/>Build randomized MCQs from term–definition pairs (no external tooling).</div>
        <div><strong>MCQ Test + Log:</strong><br/>Students answer once → graded review. Guesses are logged in-browser.</div>
        <div><strong>Etymology + Vocab:</strong><br/>Runs embedded on this page (no separate navigation, no theme clash UI elements).</div>
        <div><strong>IB Text Search:</strong><br/>Search every line from <code>ib_bio_clean_index.txt</code>.</div>
      </div>
      <p class="status">Tip: This site is static; if you change files, hard-refresh (Ctrl+F5). Query-string cache-busting is already applied where it matters.</p>
    </div>
  </section>

  <section class="panel" id="mcq">
    <div class="subgrid">
      <div class="card">
        <h2>MCQ Generator</h2>
        <p class="status">Input format: one pair per line as <code>term | definition</code>. The generator auto-loads its output into the reviewer.</p>

        <label for="pairInput">Source terms</label>
        <textarea id="pairInput" spellcheck="false"
          placeholder="mitochondrion | site of aerobic respiration and ATP production&#10;ribosome | site of protein synthesis"></textarea>

        <div class="grid">
          <div>
            <label for="qCount">Number of questions</label>
            <input id="qCount" type="number" min="1" step="1" inputmode="numeric" value="8" aria-label="Number of questions to generate" />
            <p class="status" id="qCountHelp">Type a number (e.g., 10). It will clamp to the number of available pairs.</p>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="generateBtn" type="button">Generate + Load into Reviewer</button>
          <button id="useSamplePairsBtn" type="button">Load sample pairs</button>
        </div>

        <p class="status" id="genStatus"></p>

        <details id="jsonDetails">
          <summary>Show generated MCQ JSON</summary>
          <textarea id="generatedJson" spellcheck="false" readonly></textarea>
        </details>
      </div>

      <div class="card">
        <h2>MCQ Reviewer</h2>

        <label for="jsonInput">Paste MCQ JSON</label>
        <textarea id="jsonInput" spellcheck="false"
          placeholder='{"questions":[{"id":1,"stem":"...","options":{"A":"...","B":"...","C":"...","D":"..."},"correct":"A","rationale_correct":"...","rationale_wrong":{"A":"...","B":"...","C":"...","D":"..."}}]}'></textarea>

        <div class="actions">
          <button class="primary" id="loadBtn" type="button">Load Quiz</button>
          <button id="sampleBtn" type="button">Load sample quiz</button>
          <button id="resetBtn" type="button">Clear</button>
        </div>

        <p class="status" id="revStatus">Workflow: answer all questions → submit once → full graded review.</p>
      </div>
    </div>

    <div class="card hidden" id="quizCard">
      <h3>Student Test</h3>
      <div id="quiz"></div>
      <div class="actions">
        <button class="primary" id="submitBtn" type="button">Submit Answers</button>
      </div>
    </div>

    <div class="card hidden" id="resultsCard">
      <h3>Graded Review and Explanations</h3>
      <div id="results"></div>
    </div>

    <div class="card" id="attemptLogCard">
      <h3>Attempt Log (Guesses Recorded)</h3>
      <p class="status">Logged per submission: chosen answer, correct answer, correctness, timestamp. Stored in this browser’s localStorage.</p>
      <div class="actions">
        <button id="clearLogBtn" type="button">Clear Log</button>
      </div>
      <div id="attemptLogWrap"></div>
    </div>
  </section>

  <section class="panel" id="etymo">
    <div class="card dark">
      <h2>Etymology + Vocabulary Review</h2>
      <p class="status">Embedded below with the site’s header palette. If the embedded page changes, keep it in the same folder as <code>index.html</code>.</p>

      <iframe
        src="Berthel_Etymology_Vocab_Engine_Embedded_v10_2_FULL_DEFAULT_v11_GLOSSARY_ROOTS.html?v=20260210"
        title="Etymology and Vocabulary Engine"
        loading="lazy"></iframe>
    </div>
  </section>

  <section class="panel" id="glossary">
    <div class="card">
      <h2>IB Biology Full Text Search</h2>

      <label for="glossarySearch">Search all lines from ib_bio_clean_index.txt</label>
      <input id="glossarySearch" type="search" placeholder="Try: photosynthesis, ATP, evolution" />

      <p id="glossaryStatus" class="status">Loading full text file…</p>
      <div class="search-results" id="glossaryResults"></div>
    </div>
  </section>
</main>

<footer>Berthel's Biology · Built for smooth classroom testing and revision.</footer>

<script>
(() => {
  const state = {
    currentQuiz: null,
    glossaryLines: [],
    attemptLog: JSON.parse(localStorage.getItem('berthelAttemptLog') || '[]')
  };

  const $ = (id) => document.getElementById(id);
  const setStatus = (el, msg, tone) => {
    el.textContent = msg || '';
    el.classList.remove('good','bad');
    if (tone === 'good') el.classList.add('good');
    if (tone === 'bad') el.classList.add('bad');
  };

  // Tabs / Panels
  const tabs = [...document.querySelectorAll('.tab-btn')];
  const panels = [...document.querySelectorAll('.panel')];

  function switchPanel(panelId) {
    tabs.forEach(btn => {
      const active = (btn.dataset.panel === panelId);
      btn.setAttribute('aria-selected', active ? 'true' : 'false');
    });
    panels.forEach(panel => panel.classList.toggle('active', panel.id === panelId));
    localStorage.setItem('bb_active_panel', panelId);
    window.scrollTo({ top: 0, behavior: 'instant' });
  }
  tabs.forEach(btn => btn.addEventListener('click', () => switchPanel(btn.dataset.panel)));

  // Restore last panel
  const savedPanel = localStorage.getItem('bb_active_panel');
  if (savedPanel && document.getElementById(savedPanel)) switchPanel(savedPanel);

  // Sample data
  const samplePairs = [
    'mitochondrion | site of aerobic respiration and ATP production',
    'ribosome | site of protein synthesis',
    'chlorophyll | green pigment that absorbs light for photosynthesis',
    'osmosis | movement of water across a selectively permeable membrane',
    'enzyme | biological catalyst that lowers activation energy',
    'nucleus | organelle containing DNA in eukaryotic cells',
    'allele | one version of a gene',
    'active transport | movement against concentration gradient using ATP'
  ].join('\n');

  const sampleQuiz = {
    questions: [
      {
        id: 1,
        stem: 'Which organelle is primarily responsible for ATP production in eukaryotic cells?',
        options: { A: 'Nucleus', B: 'Mitochondrion', C: 'Ribosome', D: 'Golgi apparatus' },
        correct: 'B',
        rationale_correct: 'Mitochondria carry out aerobic respiration and produce most ATP in eukaryotic cells.',
        rationale_wrong: {
          A: 'The nucleus stores genetic information; it is not the main ATP source.',
          B: 'Correct.',
          C: 'Ribosomes build proteins, not ATP as a primary role.',
          D: 'Golgi modifies and packages proteins/lipids.'
        }
      }
    ]
  };

  // Generator helpers
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function parsePairs(text) {
    return text.split('\n')
      .map(s => s.trim())
      .filter(Boolean)
      .map(line => {
        const parts = line.split('|').map(x => x.trim());
        if (parts.length < 2 || !parts[0] || !parts[1]) return null;
        return { term: parts[0], definition: parts.slice(1).join(' | ') };
      })
      .filter(Boolean);
  }

  $('useSamplePairsBtn').addEventListener('click', () => {
    $('pairInput').value = samplePairs;
    setStatus($('genStatus'), 'Loaded sample pairs.', 'good');
  });

  $('sampleBtn').addEventListener('click', () => {
    $('jsonInput').value = JSON.stringify(sampleQuiz, null, 2);
    setStatus($('revStatus'), 'Sample quiz loaded. Click “Load Quiz”.', 'good');
  });

  $('generateBtn').addEventListener('click', () => {
    const pairs = parsePairs($('pairInput').value);
    const genStatus = $('genStatus');
    if (pairs.length < 4) {
      setStatus(genStatus, 'Provide at least 4 valid "term | definition" pairs.', 'bad');
      return;
    }

    const rawCount = Number($('qCount').value);
    const count = Math.max(1, Math.min(Number.isFinite(rawCount) ? rawCount : 1, pairs.length));
    $('qCount').value = String(count);

    const selected = shuffle(pairs).slice(0, count);

    const questions = selected.map((item, index) => {
      const wrongDefs = shuffle(pairs.filter(p => p.term !== item.term).map(p => p.definition)).slice(0, 3);
      const optionsArray = shuffle([item.definition, ...wrongDefs]).slice(0, 4);
      const letters = ['A','B','C','D'];

      const options = {};
      let correct = 'A';
      letters.forEach((letter, i) => {
        options[letter] = optionsArray[i] || '(missing option)';
        if (options[letter] === item.definition) correct = letter;
      });

      const wrong = {};
      letters.forEach(letter => {
        wrong[letter] = (options[letter] === item.definition) ? 'Correct option.' : 'This choice does not match the target term.';
      });

      return {
        id: index + 1,
        stem: `What is the best definition of "${item.term}"?`,
        options,
        correct,
        rationale_correct: `The correct definition for "${item.term}" is: ${item.definition}.`,
        rationale_wrong: wrong
      };
    });

    const payload = { questions };
    $('generatedJson').value = JSON.stringify(payload, null, 2);
    $('jsonDetails').open = true;

    $('jsonInput').value = $('generatedJson').value;
    setStatus($('revStatus'), `Generated ${questions.length} question(s). Click “Load Quiz” to start.`, 'good');
    setStatus(genStatus, `Generated ${questions.length} question(s) and loaded JSON into the reviewer.`, 'good');

    switchPanel('mcq');
  });

  // Reviewer
  function parseQuizData() {
    try {
      const data = JSON.parse($('jsonInput').value);
      if (!data || !Array.isArray(data.questions) || data.questions.length === 0) {
        setStatus($('revStatus'), 'JSON must include a non-empty "questions" array.', 'bad');
        return null;
      }
      setStatus($('revStatus'), `Quiz detected: ${data.questions.length} question(s).`, 'good');
      return data;
    } catch (err) {
      setStatus($('revStatus'), `Invalid JSON: ${err.message}`, 'bad');
      return null;
    }
  }

  function clearNode(node) {
    while (node.firstChild) node.removeChild(node.firstChild);
  }

  $('loadBtn').addEventListener('click', () => {
    const data = parseQuizData();
    if (!data) return;

    state.currentQuiz = data;
    const quizEl = $('quiz');

    clearNode(quizEl);
    clearNode($('results'));
    $('resultsCard').classList.add('hidden');

    data.questions.forEach((q, i) => {
      const qId = (q.id ?? (i + 1));
      const qWrap = document.createElement('div');
      qWrap.className = 'question';

      const head = document.createElement('div');
      head.className = 'question-head';
      head.textContent = `Question ${qId}`;
      qWrap.appendChild(head);

      const stem = document.createElement('div');
      stem.textContent = q.stem || 'No question text provided.';
      qWrap.appendChild(stem);

      ['A','B','C','D'].forEach(letter => {
        const optText = (q.options && q.options[letter]) ? q.options[letter] : '(missing option)';

        const label = document.createElement('label');
        label.className = 'option';

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = `q${qId}`;
        input.value = letter;

        const text = document.createElement('div');
        const strong = document.createElement('b');
        strong.textContent = `${letter}. `;
        text.appendChild(strong);
        text.appendChild(document.createTextNode(optText));

        label.appendChild(input);
        label.appendChild(text);
        qWrap.appendChild(label);
      });

      quizEl.appendChild(qWrap);
    });

    $('quizCard').classList.remove('hidden');
  });

  $('resetBtn').addEventListener('click', () => {
    $('jsonInput').value = '';
    clearNode($('quiz'));
    clearNode($('results'));
    $('quizCard').classList.add('hidden');
    $('resultsCard').classList.add('hidden');
    state.currentQuiz = null;
    setStatus($('revStatus'), 'Cleared.', null);
  });

  // Attempt log
  function renderAttemptLog() {
    const wrap = $('attemptLogWrap');
    if (!state.attemptLog.length) {
      wrap.innerHTML = '<p class="status">No attempts logged yet.</p>';
      return;
    }
    let html = '<table><thead><tr><th>Time</th><th>Question</th><th>Guess</th><th>Correct</th><th>Result</th></tr></thead><tbody>';
    state.attemptLog.slice().reverse().forEach(entry => {
      html += `<tr><td>${entry.time}</td><td>${entry.question}</td><td>${entry.guess}</td><td>${entry.correct}</td><td>${entry.result}</td></tr>`;
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;
  }

  function saveAttemptLog() {
    localStorage.setItem('berthelAttemptLog', JSON.stringify(state.attemptLog));
    renderAttemptLog();
  }

  $('clearLogBtn').addEventListener('click', () => {
    state.attemptLog = [];
    saveAttemptLog();
  });

  $('submitBtn').addEventListener('click', () => {
    if (!state.currentQuiz) {
      setStatus($('revStatus'), 'Load a quiz first.', 'bad');
      return;
    }

    const resultsEl = $('results');
    clearNode(resultsEl);

    let score = 0;
    state.currentQuiz.questions.forEach((q, i) => {
      const qId = (q.id ?? (i + 1));
      const chosen = document.querySelector(`input[name="q${qId}"]:checked`);
      const guess = chosen?.value || 'No answer';
      const correct = q.correct || '?';
      const isCorrect = (guess === correct);
      if (isCorrect) score++;

      state.attemptLog.push({
        time: new Date().toLocaleString(),
        question: String(qId),
        guess,
        correct,
        result: isCorrect ? 'Correct' : 'Incorrect'
      });

      const block = document.createElement('div');
      block.className = 'question';

      const verdict = document.createElement('div');
      verdict.className = isCorrect ? 'correct' : 'incorrect';
      verdict.textContent = `Question ${qId}: ${isCorrect ? 'Correct' : 'Incorrect'}`;
      block.appendChild(verdict);

      const yourAns = document.createElement('div');
      yourAns.innerHTML = `<b>Your answer:</b> ${guess}`;
      block.appendChild(yourAns);

      const best = document.createElement('div');
      const bestText = (q.options && q.options[correct]) ? q.options[correct] : 'Unavailable';
      best.innerHTML = `<b>Best answer:</b> ${correct} — ${bestText}`;
      block.appendChild(best);

      const expl = document.createElement('div');
      expl.innerHTML = `<b>Explanation:</b> ${q.rationale_correct || 'No explanation provided.'}`;
      block.appendChild(expl);

      resultsEl.appendChild(block);
    });

    saveAttemptLog();

    const scoreLine = document.createElement('p');
    scoreLine.className = 'score';
    scoreLine.textContent = `Score: ${score} / ${state.currentQuiz.questions.length}`;
    resultsEl.prepend(scoreLine);

    $('resultsCard').classList.remove('hidden');
    setStatus($('revStatus'), 'Submitted and graded. Review below.', 'good');
  });

  // Glossary search
  const glossaryResults = $('glossaryResults');
  function renderGlossary(lines) {
    glossaryResults.innerHTML = '';
    if (!lines.length) {
      glossaryResults.innerHTML = '<div class="result-item">No matches found.</div>';
      return;
    }
    lines.slice(0, 400).forEach(line => {
      const div = document.createElement('div');
      div.className = 'result-item';
      div.textContent = line;
      glossaryResults.appendChild(div);
    });
  }

  const txtUrl = `ib_bio_clean_index.txt?v=20260210`;
  fetch(txtUrl, { cache: 'no-store' })
    .then(resp => {
      if (!resp.ok) throw new Error(`HTTP ${resp.status} loading ${txtUrl}`);
      return resp.text();
    })
    .then(text => {
      state.glossaryLines = text.split('\n');
      $('glossaryStatus').textContent = `Loaded: ${state.glossaryLines.length} lines (showing first 400 when unfiltered).`;
      renderGlossary(state.glossaryLines);
    })
    .catch(err => {
      $('glossaryStatus').textContent =
        `Could not load ib_bio_clean_index.txt. Ensure it exists beside index.html. (${err.message})`;
    });

  $('glossarySearch').addEventListener('input', () => {
    const term = $('glossarySearch').value.trim().toLowerCase();
    if (!term) { renderGlossary(state.glossaryLines); return; }
    renderGlossary(state.glossaryLines.filter(line => line.toLowerCase().includes(term)));
  });

  renderAttemptLog();
})();
</script>
</body>
</html>
