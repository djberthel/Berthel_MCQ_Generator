<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berthel’s Biology — Testing & Review Workspace</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --serif: "Latin Modern Roman","LM Roman 10","LM Roman 12","CMU Serif","Computer Modern Serif","Times New Roman",serif;
      --mono:  "Latin Modern Mono","LM Mono 10","CMU Typewriter Text",ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono","Courier New",monospace;

      --bg:#0b0c10;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.14);
      --fg: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --ok:  #5fe1a0;
      --bad: #ff6b7a;
      --warn:#ffd166;

      --radius: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color: var(--fg);
      font: 16px/1.5 var(--serif);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding: 8px 0 14px;
      border-bottom:1px solid var(--border);
      margin-bottom: 16px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px}
    .avatar{
      width:48px;height:48px;border-radius:999px;overflow:hidden;flex:0 0 auto;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    h1{margin:0;font-size:28px;font-weight:900;letter-spacing:.2px}
    .subtitle{margin:3px 0 0;color:var(--muted);font-size:14px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--fg);
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-family: var(--serif);
      font-weight: 850;
      letter-spacing:.15px;
    }
    .tab[aria-selected="true"]{background: rgba(255,255,255,.14)}

    .card{
      border:1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.between{justify-content:space-between}
    .grow{flex:1}
    .min240{min-width:240px}
    .min200{min-width:200px}

    label{display:block;color:var(--muted);font-size:12px;font-weight:800;letter-spacing:.2px;margin:0 0 6px}
    input[type="number"], textarea, input[type="file"]{
      width:100%;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--fg);
      border-radius: 12px;
      padding: 10px 12px;
      font-family: var(--serif);
      outline: none;
    }
    textarea{
      min-height: 160px;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.55;
    }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.07);
      color: var(--fg);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-family: var(--serif);
      font-weight: 900;
      letter-spacing:.15px;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.ok{border-color: rgba(95,225,160,.40); background: rgba(95,225,160,.10)}
    .btn.danger{border-color: rgba(255,107,122,.40); background: rgba(255,107,122,.10)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing:.2px;
      color: rgba(255,255,255,.86);
      font-size: 13px;
    }
    .pill.ok{border-color: rgba(95,225,160,.45); color: rgba(95,225,160,.95); background: rgba(95,225,160,.10)}
    .pill.bad{border-color: rgba(255,107,122,.48); color: rgba(255,107,122,.95); background: rgba(255,107,122,.10)}
    .pill.warn{border-color: rgba(255,209,102,.48); color: rgba(255,209,102,.95); background: rgba(255,209,102,.10)}

    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .hide{display:none !important}

    .quizTop{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom: 12px;
    }
    .bar{
      height: 10px;
      width: 240px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      overflow:hidden;
    }
    .bar > div{height:100%;width:0%;background: rgba(255,255,255,.25)}
    .prompt{
      font-size: 20px;
      font-weight: 950;
      letter-spacing:.15px;
      margin: 10px 0 12px;
    }
    .termTag{
      display:inline-block;
      font-family: var(--mono);
      font-size: 15px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      margin: 0 6px;
    }

    .opts{display:grid;gap:10px}
    .opt{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 12px 12px;
      cursor:pointer;
      color: var(--fg);
      text-align:left;
      font-family: var(--serif);
      font-size: 15px;
      line-height: 1.35;
      display:flex;gap:10px;align-items:flex-start;
    }
    .opt .k{font-weight:900;min-width: 20px}
    .opt.correct{border-color: rgba(95,225,160,.50); background: rgba(95,225,160,.10)}
    .opt.wrong{border-color: rgba(255,107,122,.55); background: rgba(255,107,122,.10)}

    .panelTitle{
      margin:0 0 10px;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:.2px;
    }

    .notes{
      min-height: 220px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding: 12px;
      outline:none;
      white-space: pre-wrap;
    }

    .kpiGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px}
    @media (max-width: 900px){ .kpiGrid{grid-template-columns:1fr} }
    .kpi{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .kpi .lab{color:var(--muted);font-size:12px;font-weight:900;letter-spacing:.2px}
    .kpi .val{font-size:22px;font-weight:980;margin-top:6px}
    .kpi .note{color:var(--muted);font-size:12px;margin-top:6px}

    ol{padding-left:18px;margin:10px 0 0}
    li{margin:8px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="avatar"><img id="avatar" alt="Chinstrap penguin avatar"></div>
        <div>
          <h1>Berthel’s Biology</h1>
          <div class="subtitle">Professional student testing and review workspace.</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Workspace tabs">
        <button class="tab" id="tab-home" aria-selected="true" aria-controls="panel-home" role="tab">Home</button>
        <button class="tab" id="tab-ety"  aria-selected="false" aria-controls="panel-ety"  role="tab">Etymology + Vocabulary</button>
        <button class="tab" id="tab-mcq"  aria-selected="false" aria-controls="panel-mcq"  role="tab">MCQ Content</button>
      </div>
    </header>

    <!-- HOME -->
    <section class="card" id="panel-home" role="tabpanel" aria-labelledby="tab-home">
      <h2 class="panelTitle">Update notes</h2>
      <div id="notes" class="notes" contenteditable="true" spellcheck="false"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn ok" id="saveNotes">Save</button>
        <button class="btn" id="clearNotes">Clear</button>
        <span class="muted" id="notesState">—</span>
      </div>
    </section>

    <!-- ETY/VOCAB -->
    <section class="card hide" id="panel-ety" role="tabpanel" aria-labelledby="tab-ety">
      <div class="grid">
        <div class="card">
          <h2 class="panelTitle">Generate practice set</h2>
          <div class="row">
            <div class="min240">
              <label>Number of questions (1–100)</label>
              <input id="etyN" type="number" min="1" max="100" value="40">
            </div>
            <div class="grow"></div>
            <div class="row">
              <button class="btn" id="etyNew" disabled>Generate</button>
              <button class="btn" id="etyRetake" disabled>Retake</button>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <span class="pill" id="etyBankPill">Loading bank…</span>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="min240">
              <label>(If needed) Upload ib_bio_clean_index.txt</label>
              <input id="etyUpload" type="file" accept=".txt">
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="panelTitle">Session</h2>
          <div class="row">
            <span class="pill" id="etySessionPill">—</span>
          </div>
          <div class="row" style="margin-top:10px">
            <span class="muted" id="etyHint">Set a question count to begin.</span>
          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <!-- ETY QUIZ -->
      <section class="card hide" id="etyQuiz">
        <div class="quizTop">
          <div class="row">
            <span class="pill" id="etyQMeta">Q 0/0</span>
            <span class="pill" id="etyScoreMeta">Score 0</span>
          </div>
          <div class="bar" aria-label="Progress"><div id="etyBar"></div></div>
          <div class="row">
            <button class="btn" id="etyFinish">Finish</button>
          </div>
        </div>

        <div class="prompt" id="etyPrompt">—</div>
        <div class="opts" id="etyOpts"></div>

        <div class="row between" style="margin-top:12px">
          <div class="muted" id="etyFeedback">—</div>
          <div class="row">
            <button class="btn ok" id="etyNext" disabled>Next</button>
            <button class="btn danger" id="etyAbort">Abort</button>
          </div>
        </div>
      </section>

      <!-- ETY REPORT -->
      <section class="card hide" id="etyReport">
        <div class="row between">
          <h2 class="panelTitle" style="margin:0">Summary</h2>
          <div class="row">
            <button class="btn" id="etyNew2">Generate</button>
            <button class="btn" id="etyRetake2">Retake</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="etyOverall">—</span>
          <span class="pill" id="etyQuality">—</span>
        </div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="lab">Score</div>
            <div class="val" id="etyKpiScore">0/0</div>
            <div class="note" id="etyKpiPct">0%</div>
          </div>
          <div class="kpi">
            <div class="lab">Accuracy</div>
            <div class="val" id="etyKpiAcc">—</div>
            <div class="note" id="etyKpiAccNote">—</div>
          </div>
          <div class="kpi">
            <div class="lab">What to fix</div>
            <div class="val" id="etyKpiFix">—</div>
            <div class="note" id="etyKpiFixNote">—</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h2 class="panelTitle">Errors (wrong only)</h2>
          <ol id="etyWrongList"></ol>
        </div>
      </section>
    </section>

    <!-- MCQ CONTENT -->
    <section class="card hide" id="panel-mcq" role="tabpanel" aria-labelledby="tab-mcq">
      <div class="grid">
        <div class="card">
          <h2 class="panelTitle">Generate practice set</h2>

          <div class="row">
            <div class="min240">
              <label>Upload source text (.txt)</label>
              <input id="mcqFile" type="file" accept=".txt,.md,.text">
            </div>
            <div class="min200">
              <label>Number of questions (1–100)</label>
              <input id="mcqN" type="number" min="1" max="100" value="20">
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="grow">
              <label>Paste MCQ JSON (from “MCQ JSON Machine”)</label>
              <textarea id="mcqJson" placeholder='{"title":"...","questions":[{"prompt":"...","choices":["...","...","...","..."],"answer_index":0,"explanation":"..."}]}'></textarea>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn ok" id="mcqLoad">Load</button>
            <button class="btn" id="mcqGenerate" disabled>Generate</button>
            <button class="btn" id="mcqRetake" disabled>Retake</button>
            <span class="pill" id="mcqLoadPill">Not loaded</span>
          </div>
        </div>

        <div class="card">
          <h2 class="panelTitle">Session</h2>
          <div class="row">
            <span class="pill" id="mcqSessionPill">—</span>
          </div>
          <div class="row" style="margin-top:10px">
            <span class="muted" id="mcqHint">Load MCQ JSON to begin.</span>
          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <!-- MCQ QUIZ -->
      <section class="card hide" id="mcqQuiz">
        <div class="quizTop">
          <div class="row">
            <span class="pill" id="mcqQMeta">Q 0/0</span>
            <span class="pill" id="mcqScoreMeta">Score 0</span>
          </div>
          <div class="bar" aria-label="Progress"><div id="mcqBar"></div></div>
          <div class="row">
            <button class="btn" id="mcqFinish">Finish</button>
          </div>
        </div>

        <div class="prompt" id="mcqPrompt">—</div>
        <div class="opts" id="mcqOpts"></div>

        <div class="row between" style="margin-top:12px">
          <div class="muted" id="mcqFeedback">—</div>
          <div class="row">
            <button class="btn ok" id="mcqNext" disabled>Next</button>
            <button class="btn danger" id="mcqAbort">Abort</button>
          </div>
        </div>
      </section>

      <!-- MCQ REPORT -->
      <section class="card hide" id="mcqReport">
        <div class="row between">
          <h2 class="panelTitle" style="margin:0">Summary</h2>
          <div class="row">
            <button class="btn" id="mcqGenerate2">Generate</button>
            <button class="btn" id="mcqRetake2">Retake</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="mcqOverall">—</span>
          <span class="pill" id="mcqValidation">—</span>
        </div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="lab">Score</div>
            <div class="val" id="mcqKpiScore">0/0</div>
            <div class="note" id="mcqKpiPct">0%</div>
          </div>
          <div class="kpi">
            <div class="lab">Accuracy</div>
            <div class="val" id="mcqKpiAcc">—</div>
            <div class="note" id="mcqKpiAccNote">—</div>
          </div>
          <div class="kpi">
            <div class="lab">What to fix</div>
            <div class="val" id="mcqKpiFix">—</div>
            <div class="note" id="mcqKpiFixNote">—</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h2 class="panelTitle">Errors (wrong only)</h2>
          <ol id="mcqWrongList"></ol>
        </div>
      </section>
    </section>
  </div>

<script>
/* -------------------------
   Minimal engine utilities
--------------------------*/
const $ = (id)=>document.getElementById(id);

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function makeKeyLetters(N){
  const letters = ["A","B","C","D"];
  const base = Math.floor(N/4);
  let counts = {A:base,B:base,C:base,D:base};
  let rem = N % 4;
  const pick = shuffle(letters.slice());
  for(let i=0;i<rem;i++) counts[pick[i]]++;

  function build(){
    let key=[];
    for(const L of letters){
      for(let i=0;i<counts[L];i++) key.push(L);
    }
    shuffle(key);
    return key;
  }

  function ok(key){
    // no >3 run
    let run=1;
    for(let i=1;i<key.length;i++){
      if(key[i]===key[i-1]) run++;
      else run=1;
      if(run>3) return false;
    }
    // counts differ <=1 already by construction
    return true;
  }

  for(let t=0;t<5000;t++){
    const k = build();
    if(ok(k)) return {key:k, counts};
  }
  const k = build();
  return {key:k, counts};
}

function letterToIndex(L){ return ({A:0,B:1,C:2,D:3})[L]; }
function indexToLetter(i){ return ["A","B","C","D"][i]; }

function scorePill(pct){
  if(pct>=85) return {cls:"ok",  label:"GREEN", text:"Strong performance"};
  if(pct>=70) return {cls:"warn",label:"AMBER", text:"Borderline — tighten weak areas"};
  return {cls:"bad", label:"RED",  text:"Insufficient — needs rework"};
}

function explainFix(pct){
  if(pct>=85) return {head:"Maintain", note:"Generate a new set to stress-test consistency."};
  if(pct>=70) return {head:"Target errors", note:"Retake same set once, then generate new."};
  return {head:"Rebuild", note:"Retake same set until ≥70%, then rotate."};
}

function debounce(fn, ms){
  let t=null;
  return (...args)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...args), ms);
  };
}

/* -------------------------
   Tabs
--------------------------*/
const tabs = [
  {btn:$("tab-home"), panel:$("panel-home")},
  {btn:$("tab-ety"),  panel:$("panel-ety")},
  {btn:$("tab-mcq"),  panel:$("panel-mcq")}
];

function setTab(id){
  for(const t of tabs){
    const on = (t.btn.id===id);
    t.btn.setAttribute("aria-selected", on ? "true":"false");
    t.panel.classList.toggle("hide", !on);
  }
}
tabs.forEach(t=>t.btn.addEventListener("click", ()=>setTab(t.btn.id)));

/* -------------------------
   Avatar (local file)
--------------------------*/
(function initAvatar(){
  const img = $("avatar");
  img.src = "Chinstrap_LOgo.jfif";
  img.onerror = ()=>{
    // fallback: minimal inline SVG
    img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96">
         <rect width="100%" height="100%" fill="#111"/>
         <circle cx="48" cy="42" r="18" fill="#eee" opacity="0.85"/>
         <rect x="18" y="64" width="60" height="18" rx="9" fill="#eee" opacity="0.65"/>
       </svg>`
    );
  };
})();

/* -------------------------
   Home notes (local)
--------------------------*/
(function initNotes(){
  const key="bert_bio_notes_v1";
  const el=$("notes");
  const state=$("notesState");
  const saved = localStorage.getItem(key);
  if(saved) el.textContent = saved;

  function stamp(msg){
    const d = new Date();
    state.textContent = msg + " · " + d.toLocaleString();
  }

  $("saveNotes").addEventListener("click", ()=>{
    localStorage.setItem(key, el.textContent || "");
    stamp("Saved");
  });
  $("clearNotes").addEventListener("click", ()=>{
    el.textContent="";
    localStorage.setItem(key,"");
    stamp("Cleared");
  });
  stamp("Ready");
})();

/* -------------------------
   Etymology/Vocab bank
--------------------------*/
let bank = []; // {term, def}

function parseBankText(txt){
  const lines = txt.replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean);
  const out=[];
  const seen = new Set();

  for(const raw of lines){
    // tolerate headers / noise
    if(raw.length<6) continue;
    if(/^\*{0,2}glossary\*{0,2}$/i.test(raw)) continue;
    if(/^words in blue/i.test(raw)) continue;

    // common separators
    let term=null, def=null;

    // tab first
    if(raw.includes("\t")){
      const parts = raw.split("\t").map(s=>s.trim()).filter(Boolean);
      if(parts.length>=2){ term=parts[0]; def=parts.slice(1).join(" "); }
    } else {
      // em dash / dash / colon
      const m = raw.match(/^(.+?)(?:\s+—\s+|\s+-\s+|\s*:\s+)(.+)$/);
      if(m){ term=m[1].trim(); def=m[2].trim(); }
      else {
        // two-column spacing (2+ spaces)
        const m2 = raw.match(/^(.+?)\s{2,}(.+)$/);
        if(m2){ term=m2[1].trim(); def=m2[2].trim(); }
      }
    }

    if(!term || !def) continue;
    // basic cleanup
    term = term.replace(/\s+/g," ").trim();
    def  = def.replace(/\s+/g," ").trim();
    if(term.length<2 || def.length<3) continue;

    const key = term.toLowerCase();
    if(seen.has(key)) continue;
    seen.add(key);
    out.push({term, def});
  }
  return out;
}

async function loadBank(){
  try{
    const res = await fetch("ib_bio_clean_index.txt", {cache:"no-store"});
    if(!res.ok) throw new Error("fetch failed");
    const txt = await res.text();
    bank = parseBankText(txt);
  } catch(e){
    bank = [];
  }
  updateBankUI();
}
function updateBankUI(){
  const pill = $("etyBankPill");
  if(bank.length){
    pill.className = "pill ok";
    pill.textContent = `Bank loaded (${bank.length} terms)`;
    $("etyNew").disabled = false;
    $("etyHint").textContent = "Enter a number of questions to begin.";
  } else {
    pill.className = "pill bad";
    pill.textContent = "Bank not loaded";
    $("etyNew").disabled = true;
    $("etyHint").textContent = "Upload the bank file, then set a question count.";
  }
}

$("etyUpload").addEventListener("change", async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const txt = await f.text();
  bank = parseBankText(txt);
  updateBankUI();
  autoStartEty();
});

/* -------------------------
   Etymology quiz engine
--------------------------*/
let ety = {
  set: null,          // last generated set object
  idx: 0,
  score: 0,
  locked: false,
  answers: []         // {pickedIndex, correctIndex, pickedLetter, correctLetter}
};

function makeEtyQuestion(item, kind){
  // kind: "TERM->DEF" or "DEF->TERM"
  const pool = bank;
  const correct = item;
  // distractors: pick 3 others
  const d = [];
  const used = new Set([correct.term.toLowerCase()]);
  while(d.length<3 && used.size<pool.length){
    const cand = choice(pool);
    const k = cand.term.toLowerCase();
    if(used.has(k)) continue;
    used.add(k);
    d.push(cand);
  }
  if(kind==="TERM->DEF"){
    const prompt = `Meaning of ${`<span class="termTag">${escapeHtml(correct.term)}</span>`}?`;
    const correctText = correct.def;
    const opts = [correctText, d[0]?.def, d[1]?.def, d[2]?.def].filter(Boolean);
    return {kind, promptHtml: prompt, correctText, choices: opts};
  } else {
    const prompt = `Term for: ${`<span class="termTag">${escapeHtml(correct.def)}</span>`}`;
    const correctText = correct.term;
    const opts = [correctText, d[0]?.term, d[1]?.term, d[2]?.term].filter(Boolean);
    return {kind, promptHtml: prompt, correctText, choices: opts};
  }
}

function forceCorrectToLetter(q, forcedLetter){
  const forcedIndex = letterToIndex(forcedLetter);
  // q.choices currently has correct at index 0
  // shuffle distractors but keep correct as value
  const correct = q.choices[0];
  const distractors = q.choices.slice(1);
  shuffle(distractors);
  const arranged = new Array(4);
  arranged[forcedIndex] = correct;
  let di=0;
  for(let i=0;i<4;i++){
    if(i===forcedIndex) continue;
    arranged[i] = distractors[di++];
  }
  return {
    ...q,
    choices: arranged,
    correctIndex: forcedIndex,
    correctLetter: forcedLetter
  };
}

function generateEtySet(N){
  N = clamp(N,1,100);
  if(!bank.length) return null;
  N = Math.min(N, bank.length);

  // sample N unique items
  const items = shuffle(bank.slice()).slice(0, N);

  const {key, counts} = makeKeyLetters(N);

  const questions = items.map((it,i)=>{
    const kind = (Math.random()<0.5) ? "TERM->DEF" : "DEF->TERM";
    const baseQ = makeEtyQuestion(it, kind);
    return forceCorrectToLetter(baseQ, key[i]);
  });

  return {
    N,
    key,
    keyCounts: counts,
    questions,
    createdAt: new Date().toISOString(),
    id: Math.random().toString(16).slice(2)
  };
}

function startEty(setObj){
  ety.set = setObj;
  ety.idx = 0;
  ety.score = 0;
  ety.locked = false;
  ety.answers = [];

  $("etyReport").classList.add("hide");
  $("etyQuiz").classList.remove("hide");

  $("etyRetake").disabled = false;
  $("etyRetake2").disabled = false;

  $("etySessionPill").className = "pill ok";
  $("etySessionPill").textContent = `Active set (${setObj.N}Q)`;

  renderEtyQ();
}

function renderEtyQ(){
  const setObj = ety.set;
  const q = setObj.questions[ety.idx];

  $("etyQMeta").textContent = `Q ${ety.idx+1}/${setObj.N}`;
  $("etyScoreMeta").textContent = `Score ${ety.score}`;
  $("etyPrompt").innerHTML = q.promptHtml;

  const pct = (ety.idx)/setObj.N * 100;
  $("etyBar").style.width = pct.toFixed(1) + "%";

  $("etyFeedback").textContent = "—";
  $("etyNext").disabled = true;

  const opts = $("etyOpts");
  opts.innerHTML = "";
  q.choices.forEach((text,i)=>{
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.type = "button";
    btn.innerHTML = `<div class="k">${indexToLetter(i)}</div><div class="t">${escapeHtml(text)}</div>`;
    btn.addEventListener("click", ()=>answerEty(i));
    opts.appendChild(btn);
  });

  ety.locked = false;
}

function answerEty(pickedIndex){
  if(ety.locked) return;
  ety.locked = true;

  const setObj = ety.set;
  const q = setObj.questions[ety.idx];
  const correctIndex = q.correctIndex;

  const buttons = Array.from($("etyOpts").children);
  buttons.forEach((b,i)=>{
    if(i===correctIndex) b.classList.add("correct");
    if(i===pickedIndex && i!==correctIndex) b.classList.add("wrong");
    b.disabled = true;
  });

  const pickedLetter = indexToLetter(pickedIndex);
  const correctLetter = indexToLetter(correctIndex);

  const ok = (pickedIndex===correctIndex);
  if(ok) ety.score++;

  $("etyFeedback").textContent = ok
    ? `Correct (${correctLetter}).`
    : `Incorrect (you chose ${pickedLetter}; correct is ${correctLetter}).`;

  ety.answers.push({
    pickedIndex, correctIndex,
    pickedLetter, correctLetter,
    prompt: stripHtml(q.promptHtml),
    correctText: q.choices[correctIndex],
    pickedText: q.choices[pickedIndex]
  });

  $("etyNext").disabled = false;
}

function nextEty(){
  if(!ety.set) return;
  if(ety.idx < ety.set.N - 1){
    ety.idx++;
    renderEtyQ();
  } else {
    finishEty();
  }
}

function finishEty(){
  if(!ety.set) return;
  $("etyQuiz").classList.add("hide");
  $("etyReport").classList.remove("hide");

  // progress bar full
  $("etyBar").style.width = "100%";

  const total = ety.set.N;
  const pct = total ? (ety.score/total*100) : 0;

  const p = scorePill(pct);
  $("etyOverall").className = `pill ${p.cls}`;
  $("etyOverall").textContent = `${p.label}: ${p.text}`;

  // key quality pill (always enforced, but still reported)
  const qc = etyKeyQuality(ety.set.key);
  $("etyQuality").className = `pill ${qc.ok ? "ok":"warn"}`;
  $("etyQuality").textContent = qc.ok ? "Key: OK" : "Key: CHECK";

  $("etyKpiScore").textContent = `${ety.score}/${total}`;
  $("etyKpiPct").textContent = `${pct.toFixed(1)}%`;

  $("etyKpiAcc").textContent = pct>=85 ? "High" : (pct>=70 ? "Medium" : "Low");
  $("etyKpiAccNote").textContent = pct>=85 ? "Consistent recall + discrimination." :
                                  (pct>=70 ? "Some drift under distractors." : "Frequent misses; re-learn core items.");

  const fx = explainFix(pct);
  $("etyKpiFix").textContent = fx.head;
  $("etyKpiFixNote").textContent = fx.note;

  const wrong = ety.answers
    .map((a,i)=>({i:i+1,...a}))
    .filter(a=>a.pickedIndex!==a.correctIndex);

  const list = $("etyWrongList");
  list.innerHTML = "";
  if(!wrong.length){
    const li=document.createElement("li");
    li.innerHTML = `<span class="pill ok">No errors</span>`;
    list.appendChild(li);
  } else {
    wrong.forEach(w=>{
      const li=document.createElement("li");
      li.innerHTML = `
        <div><b>${escapeHtml(w.prompt)}</b></div>
        <div style="margin-top:6px">
          <span class="pill bad">Your answer: ${escapeHtml(w.pickedText)}</span>
        </div>
        <div style="margin-top:6px">
          <span class="pill ok">Correct: ${escapeHtml(w.correctText)}</span>
        </div>
      `;
      list.appendChild(li);
    });
  }

  $("etySessionPill").className = "pill";
  $("etySessionPill").textContent = `Finished (${total}Q)`;
}

function etyKeyQuality(key){
  // check: no >3 in a row; counts within 1
  let run=1;
  for(let i=1;i<key.length;i++){
    run = (key[i]===key[i-1]) ? run+1 : 1;
    if(run>3) return {ok:false};
  }
  const c={A:0,B:0,C:0,D:0};
  key.forEach(k=>c[k]++);
  const vals=Object.values(c);
  const max=Math.max(...vals), min=Math.min(...vals);
  if(max-min>1) return {ok:false};
  return {ok:true};
}

/* -------------------------
   Ety controls (auto-generate)
--------------------------*/
const autoStartEty = debounce(()=>{
  if(!bank.length) return;
  const n = clamp(parseInt($("etyN").value||"0",10),1,100);
  $("etyN").value = n;
  const setObj = generateEtySet(n);
  if(setObj) startEty(setObj);
}, 350);

$("etyN").addEventListener("input", ()=>{
  $("etyHint").textContent = "Generating…";
  autoStartEty();
});
$("etyNew").addEventListener("click", ()=>autoStartEty());
$("etyNew2").addEventListener("click", ()=>autoStartEty());

function retakeEty(){
  if(!ety.set) return;
  // restart same set
  const same = ety.set;
  startEty(same);
}
$("etyRetake").addEventListener("click", retakeEty);
$("etyRetake2").addEventListener("click", retakeEty);

$("etyNext").addEventListener("click", nextEty);
$("etyFinish").addEventListener("click", finishEty);
$("etyAbort").addEventListener("click", ()=>{
  $("etyQuiz").classList.add("hide");
  $("etyReport").classList.add("hide");
  $("etySessionPill").className="pill";
  $("etySessionPill").textContent="—";
  $("etyHint").textContent="Set a question count to begin.";
});

/* Keyboard for ETY */
window.addEventListener("keydown",(e)=>{
  if(!$("panel-ety").classList.contains("hide") && !$("etyQuiz").classList.contains("hide")){
    const k=e.key.toLowerCase();
    if(["1","2","3","4"].includes(k)){ answerEty(parseInt(k,10)-1); e.preventDefault(); }
    if(k==="enter"){ if(!$("etyNext").disabled) nextEty(); e.preventDefault(); }
  }
});

/* -------------------------
   MCQ Content: load + validate
--------------------------*/
let mcqSource = null; // {title, questions:[{prompt, choices[4], answer_index, explanation?}]}
let mcq = {
  set:null,
  idx:0,
  score:0,
  locked:false,
  answers:[],
  validation:{ok:false, issues:[]}
};

function validateMcqSource(obj){
  const issues=[];
  if(!obj || typeof obj!=="object") issues.push("JSON is not an object.");
  const qs = obj?.questions;
  if(!Array.isArray(qs) || !qs.length) issues.push("Missing or empty questions[].");
  if(qs && Array.isArray(qs)){
    qs.forEach((q, i)=>{
      if(typeof q?.prompt !== "string" || !q.prompt.trim()) issues.push(`Q${i+1}: missing prompt.`);
      if(!Array.isArray(q?.choices) || q.choices.length!==4) issues.push(`Q${i+1}: choices must be an array of 4.`);
      if(typeof q?.answer_index !== "number" || q.answer_index<0 || q.answer_index>3) issues.push(`Q${i+1}: answer_index must be 0–3.`);
      if(Array.isArray(q?.choices) && q.choices.some(c=>typeof c!=="string" || !c.trim())) issues.push(`Q${i+1}: choices must be non-empty strings.`);
    });
  }
  return {ok: issues.length===0, issues};
}

$("mcqLoad").addEventListener("click", ()=>{
  let parsed=null;
  try{
    parsed = JSON.parse($("mcqJson").value || "");
  } catch(e){
    parsed=null;
  }
  const v = validateMcqSource(parsed);
  mcq.validation = v;

  if(v.ok){
    mcqSource = parsed;
    $("mcqLoadPill").className="pill ok";
    $("mcqLoadPill").textContent = `Loaded (${mcqSource.questions.length}Q)`;
    $("mcqGenerate").disabled = false;
    $("mcqRetake").disabled = true;
    $("mcqGenerate2").disabled = false;
    $("mcqRetake2").disabled = true;
    $("mcqHint").textContent = "Set a question count to generate.";
  } else {
    mcqSource = null;
    $("mcqLoadPill").className="pill bad";
    $("mcqLoadPill").textContent = "Invalid JSON";
    $("mcqGenerate").disabled = true;
    $("mcqRetake").disabled = true;
    $("mcqHint").textContent = "Fix JSON and load again.";
  }
});

/* -------------------------
   MCQ set generation (balanced key + forced letters)
--------------------------*/
function generateMcqSet(N){
  if(!mcqSource) return null;
  N = clamp(N,1,100);
  const pool = mcqSource.questions.slice();
  if(!pool.length) return null;
  N = Math.min(N, pool.length);

  const sampled = shuffle(pool).slice(0, N);
  const {key, counts} = makeKeyLetters(N);

  const questions = sampled.map((q,i)=>{
    // normalize
    const prompt = String(q.prompt);
    const choices = q.choices.slice();
    const correctText = choices[q.answer_index];

    // move correct to index 0 temporarily
    const distractors = choices.filter((_,idx)=>idx!==q.answer_index);
    shuffle(distractors);
    const base = [correctText, ...distractors];

    const forced = forceCorrectToLetter(
      {prompt, choices: base, explanation: q.explanation || ""},
      key[i]
    );

    return forced;
  });

  return {
    N,
    key,
    keyCounts: counts,
    questions,
    createdAt: new Date().toISOString(),
    id: Math.random().toString(16).slice(2),
    title: mcqSource.title || "MCQ Set"
  };
}

function startMcq(setObj){
  mcq.set = setObj;
  mcq.idx = 0;
  mcq.score = 0;
  mcq.locked = false;
  mcq.answers = [];

  $("mcqReport").classList.add("hide");
  $("mcqQuiz").classList.remove("hide");

  $("mcqRetake").disabled = false;
  $("mcqRetake2").disabled = false;

  $("mcqSessionPill").className="pill ok";
  $("mcqSessionPill").textContent = `Active set (${setObj.N}Q)`;

  renderMcqQ();
}

function renderMcqQ(){
  const setObj = mcq.set;
  const q = setObj.questions[mcq.idx];

  $("mcqQMeta").textContent = `Q ${mcq.idx+1}/${setObj.N}`;
  $("mcqScoreMeta").textContent = `Score ${mcq.score}`;

  const pct = (mcq.idx)/setObj.N * 100;
  $("mcqBar").style.width = pct.toFixed(1) + "%";

  $("mcqPrompt").textContent = q.prompt;
  $("mcqFeedback").textContent = "—";
  $("mcqNext").disabled = true;

  const opts = $("mcqOpts");
  opts.innerHTML = "";
  q.choices.forEach((text,i)=>{
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.type="button";
    btn.innerHTML = `<div class="k">${indexToLetter(i)}</div><div class="t">${escapeHtml(text)}</div>`;
    btn.addEventListener("click", ()=>answerMcq(i));
    opts.appendChild(btn);
  });

  mcq.locked = false;
}

function answerMcq(pickedIndex){
  if(mcq.locked) return;
  mcq.locked = true;

  const setObj = mcq.set;
  const q = setObj.questions[mcq.idx];
  const correctIndex = q.correctIndex;

  const buttons = Array.from($("mcqOpts").children);
  buttons.forEach((b,i)=>{
    if(i===correctIndex) b.classList.add("correct");
    if(i===pickedIndex && i!==correctIndex) b.classList.add("wrong");
    b.disabled = true;
  });

  const ok = pickedIndex===correctIndex;
  if(ok) mcq.score++;

  const pickedLetter = indexToLetter(pickedIndex);
  const correctLetter = indexToLetter(correctIndex);

  // minimalist feedback, with explanation only if wrong (and available)
  let fb = ok ? `Correct (${correctLetter}).` : `Incorrect (you chose ${pickedLetter}; correct is ${correctLetter}).`;
  if(!ok && q.explanation){
    fb += `  ${q.explanation}`;
  }
  $("mcqFeedback").textContent = fb;

  mcq.answers.push({
    pickedIndex, correctIndex,
    pickedText: q.choices[pickedIndex],
    correctText: q.choices[correctIndex],
    prompt: q.prompt,
    explanation: q.explanation || ""
  });

  $("mcqNext").disabled = false;
}

function nextMcq(){
  if(!mcq.set) return;
  if(mcq.idx < mcq.set.N - 1){
    mcq.idx++;
    renderMcqQ();
  } else {
    finishMcq();
  }
}

function finishMcq(){
  if(!mcq.set) return;
  $("mcqQuiz").classList.add("hide");
  $("mcqReport").classList.remove("hide");
  $("mcqBar").style.width = "100%";

  const total = mcq.set.N;
  const pct = total ? (mcq.score/total*100) : 0;

  const p = scorePill(pct);
  $("mcqOverall").className = `pill ${p.cls}`;
  $("mcqOverall").textContent = `${p.label}: ${p.text}`;

  // validation pill
  if(mcq.validation.ok){
    $("mcqValidation").className = "pill ok";
    $("mcqValidation").textContent = "Input: valid";
  } else {
    $("mcqValidation").className = "pill bad";
    $("mcqValidation").textContent = "Input: invalid";
  }

  $("mcqKpiScore").textContent = `${mcq.score}/${total}`;
  $("mcqKpiPct").textContent = `${pct.toFixed(1)}%`;

  $("mcqKpiAcc").textContent = pct>=85 ? "High" : (pct>=70 ? "Medium" : "Low");
  $("mcqKpiAccNote").textContent = pct>=85 ? "Stable reasoning under distractors." :
                                  (pct>=70 ? "Some misses under pressure." : "Too many misses — revisit source material.");

  const fx = explainFix(pct);
  $("mcqKpiFix").textContent = fx.head;
  $("mcqKpiFixNote").textContent = fx.note;

  const wrong = mcq.answers.filter(a=>a.pickedIndex!==a.correctIndex);
  const list = $("mcqWrongList");
  list.innerHTML = "";
  if(!wrong.length){
    const li=document.createElement("li");
    li.innerHTML = `<span class="pill ok">No errors</span>`;
    list.appendChild(li);
  } else {
    wrong.forEach(w=>{
      const li=document.createElement("li");
      li.innerHTML = `
        <div><b>${escapeHtml(w.prompt)}</b></div>
        <div style="margin-top:6px"><span class="pill bad">Your answer: ${escapeHtml(w.pickedText)}</span></div>
        <div style="margin-top:6px"><span class="pill ok">Correct: ${escapeHtml(w.correctText)}</span></div>
        ${w.explanation ? `<div class="muted" style="margin-top:8px">${escapeHtml(w.explanation)}</div>` : ``}
      `;
      list.appendChild(li);
    });
  }

  $("mcqSessionPill").className="pill";
  $("mcqSessionPill").textContent = `Finished (${total}Q)`;
}

/* -------------------------
   MCQ controls (auto-generate)
--------------------------*/
const autoStartMcq = debounce(()=>{
  if(!mcqSource) return;
  const n = clamp(parseInt($("mcqN").value||"0",10),1,100);
  $("mcqN").value = n;
  const setObj = generateMcqSet(n);
  if(setObj) startMcq(setObj);
}, 350);

$("mcqN").addEventListener("input", ()=>{
  $("mcqHint").textContent = "Generating…";
  autoStartMcq();
});
$("mcqGenerate").addEventListener("click", ()=>autoStartMcq());
$("mcqGenerate2").addEventListener("click", ()=>autoStartMcq());

function retakeMcq(){
  if(!mcq.set) return;
  const same = mcq.set;
  startMcq(same);
}
$("mcqRetake").addEventListener("click", retakeMcq);
$("mcqRetake2").addEventListener("click", retakeMcq);

$("mcqNext").addEventListener("click", nextMcq);
$("mcqFinish").addEventListener("click", finishMcq);
$("mcqAbort").addEventListener("click", ()=>{
  $("mcqQuiz").classList.add("hide");
  $("mcqReport").classList.add("hide");
  $("mcqSessionPill").className="pill";
  $("mcqSessionPill").textContent="—";
  $("mcqHint").textContent="Load MCQ JSON to begin.";
});

/* Keyboard for MCQ */
window.addEventListener("keydown",(e)=>{
  if(!$("panel-mcq").classList.contains("hide") && !$("mcqQuiz").classList.contains("hide")){
    const k=e.key.toLowerCase();
    if(["a","b","c","d"].includes(k)){ answerMcq({a:0,b:1,c:2,d:3}[k]); e.preventDefault(); }
    if(["1","2","3","4"].includes(k)){ answerMcq(parseInt(k,10)-1); e.preventDefault(); }
    if(k==="enter"){ if(!$("mcqNext").disabled) nextMcq(); e.preventDefault(); }
  }
});

/* -------------------------
   Helpers: safe text
--------------------------*/
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function stripHtml(s){
  const tmp=document.createElement("div");
  tmp.innerHTML=s;
  return (tmp.textContent||"").trim();
}

/* -------------------------
   Boot
--------------------------*/
loadBank();
(function initEtyGenerateButton(){
  $("etyNew").addEventListener("click", ()=>autoStartEty());
  $("etyNew2").addEventListener("click", ()=>autoStartEty());
})();
</script>
</body>
</html>
