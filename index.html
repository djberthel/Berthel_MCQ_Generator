<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berthel's Biology</title>

  <style>
    :root{
      --bg0:#ffffff;
      --bg1:#f6f6f6;
      --bg2:#ececec;
      --ink:#0b0b0b;
      --muted:#5a5a5a;
      --line:#d7d7d7;
      --card:#ffffff;
      --shadow: 0 10px 28px rgba(0,0,0,.08);
      --ok:#14853b;
      --bad:#b00020;
      --accent:#111111;
      --focus: 0 0 0 3px rgba(0,0,0,.18);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 10% -10%, var(--bg2) 10%, transparent 55%),
        radial-gradient(900px 520px at 90% -10%, var(--bg2) 10%, transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      font: 16px/1.55 "Latin Modern Roman","Latin Modern","LMRoman10","Computer Modern Serif","CMU Serif","Times New Roman",serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a{color:inherit}
    .container{max-width:1100px;margin:0 auto;padding:18px 18px 28px}

    header{
      position:sticky; top:0; z-index:20;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding:14px 18px;
      max-width:1100px; margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 0;
    }
    .avatar{
      width:44px;height:44px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      object-fit:cover;
      flex:0 0 auto;
    }
    .brandText{min-width:0}
    .title{
      font-size:18px; font-weight:700; margin:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:2px 0 0;
      font-size:13px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .versionPill{
      display:flex; align-items:center; gap:10px;
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background: #fff;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      cursor:default;
    }
    .versionCode{
      color:var(--ink);
      font-variant-numeric: tabular-nums;
    }

    .tabs{
      display:flex; gap:10px; padding:0 18px 14px;
      max-width:1100px; margin:0 auto;
      flex-wrap:wrap;
    }
    .tabBtn{
      appearance:none;
      border:1px solid var(--line);
      background: #fff;
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-size:14px;
      color:var(--ink);
      box-shadow: none;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .tabBtn:hover{background:#fafafa}
    .tabBtn:active{transform: translateY(1px)}
    .tabBtn[aria-selected="true"]{
      border-color:#bcbcbc;
      background: #f4f4f4;
      font-weight:700;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .sectionPad{padding:18px}
    .sectionTitle{
      margin:0 0 10px;
      font-size:16px; font-weight:700;
    }
    .hint{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
    }

    .row{
      display:flex; align-items:flex-end; gap:14px; flex-wrap:wrap;
    }
    .field{
      min-width:220px; flex:0 0 auto;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input[type="number"], input[type="password"], textarea, input[type="file"]{
      width:100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:12px 12px;
      font: inherit;
      background:#fff;
      color:var(--ink);
      outline:none;
    }
    input[type="number"]:focus, input[type="password"]:focus, textarea:focus{
      box-shadow: var(--focus);
      border-color:#bcbcbc;
    }
    textarea{min-height:110px; resize:vertical}

    .btn{
      appearance:none;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:12px 14px;
      background:#111;
      color:#fff;
      cursor:pointer;
      font-weight:700;
      transition: transform .06s ease, filter .15s ease, opacity .15s ease;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .btn.secondary{
      background:#fff; color:var(--ink);
      font-weight:700;
    }
    .btn.secondary:hover{background:#fafafa}

    .divider{height:1px;background:var(--line);margin:14px 0}

    .quizShell{display:none}
    .quizTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--ink)}
    .progressWrap{
      flex:1 1 240px;
      height:10px;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
    }
    .progressBar{height:100%; width:0%; background:#111}

    .prompt{
      margin:0 0 12px;
      font-size:20px;
      letter-spacing:.1px;
    }
    .termBadge{
      display:inline-block;
      margin:0 6px;
      padding:2px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      font-size:18px;
      font-weight:700;
      vertical-align:baseline;
    }

    .options{display:grid; gap:12px}
    .optBtn{
      width:100%;
      text-align:left;
      border:1px solid var(--line);
      background:#fff;
      border-radius: 14px;
      padding:14px 14px;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease, transform .06s ease;
      display:flex; gap:10px; align-items:flex-start;
    }
    .optBtn:hover{background:#fafafa}
    .optBtn:active{transform: translateY(1px)}
    .optBtn:disabled{cursor:not-allowed}
    .optKey{
      flex:0 0 auto;
      width:26px;height:26px;
      border-radius:8px;
      border:1px solid var(--line);
      display:inline-flex;align-items:center;justify-content:center;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      margin-top:1px;
    }
    .optText{flex:1 1 auto}
    .optBtn.correct{border-color: rgba(20,133,59,.55)}
    .optBtn.wrong{border-color: rgba(176,0,32,.55)}
    .feedback{
      margin-top:12px;
      font-size:14px;
      color:var(--muted);
      min-height:22px;
    }
    .feedback strong{color:var(--ink)}
    .actionsRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin-top:14px;
    }

    .resultsShell{display:none}
    .resultsHeader{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .metricRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:10px 0 0;
    }
    .metric{
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .metric strong{color:var(--ink)}
    .review{
      margin:12px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:10px;
    }
    .reviewItem{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      padding:12px 14px;
    }
    .reviewTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .statusTag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
    }
    .statusTag.ok{border-color: rgba(20,133,59,.35); color: var(--ok)}
    .statusTag.bad{border-color: rgba(176,0,32,.35); color: var(--bad)}
    .rationale{
      margin:8px 0 0;
      color:var(--muted);
      font-size:13px;
    }
    .rationale strong{color:var(--ink)}
    .rationale .ok{color:var(--ok); font-weight:700}
    .rationale .bad{color:var(--bad); font-weight:700}

    /* Home updates feed */
    .updatesList{
      display:grid; gap:10px;
      margin-top:10px;
    }
    .updateItem{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      padding:12px 14px;
    }
    .updateMeta{
      font-size:12px;
      color:var(--muted);
      font-variant-numeric: tabular-nums;
      margin-bottom:6px;
    }

    /* Hidden admin */
    .adminShell{display:none}
    .adminShell.show{display:block}
    .miniNote{
      font-size:12px;color:var(--muted);margin-top:8px
    }

    /* Sections */
    section[data-view]{display:none}
    section[data-view].show{display:block}

    /* Reduce clutter on small screens */
    @media (max-width:560px){
      .prompt{font-size:18px}
      .field{min-width:180px}
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <img id="avatarImg" class="avatar" alt="Chinstrap penguin avatar" />
      <div class="brandText">
        <h1 class="title">Berthel's Biology</h1>
        <p class="subtitle">Professional student testing and review workspace.</p>
      </div>
    </div>

    <div class="versionPill" id="versionPill" title="Site version (latest update timestamp, UTC+8)">
      <span>Version</span>
      <span class="versionCode" id="versionTag">—</span>
    </div>
  </div>

  <div class="tabs" role="tablist" aria-label="Workspace tabs">
    <button class="tabBtn" role="tab" id="tabHome" aria-selected="true" aria-controls="viewHome">Home</button>
    <button class="tabBtn" role="tab" id="tabCore" aria-selected="false" aria-controls="viewCore">Etymology + Vocabulary</button>
    <button class="tabBtn" role="tab" id="tabCustom" aria-selected="false" aria-controls="viewCustom">MCQ Content</button>
  </div>
</header>

<div class="container">

  <!-- HOME -->
  <section class="card show" data-view="home" id="viewHome" aria-labelledby="tabHome">
    <div class="sectionPad">
      <h2 class="sectionTitle">Updates</h2>
      <div id="updatesList" class="updatesList"></div>

      <!-- Admin (hidden by default; unlock by Ctrl+Shift+U or 5 clicks on Version pill) -->
      <div class="divider"></div>
      <div id="adminShell" class="adminShell">
        <h3 class="sectionTitle" style="margin-top:0">Admin: Add Update</h3>
        <div class="row">
          <div class="field" style="flex:1 1 520px; min-width:280px">
            <label for="adminMsg">Update message (visible to all users)</label>
            <textarea id="adminMsg" placeholder="Enter update text…"></textarea>
            <div class="miniNote">Timestamp is automatically generated in Beijing time (UTC+8) at the moment you post.</div>
          </div>
          <div class="field" style="min-width:240px">
            <label for="adminPass">Admin passcode</label>
            <input id="adminPass" type="password" placeholder="Required" autocomplete="off" />
            <div style="height:10px"></div>
            <button class="btn" id="postUpdateBtn">Post update</button>
            <div style="height:10px"></div>
            <button class="btn secondary" id="downloadUpdatesBtn" disabled>Download updated updates.json</button>
            <div class="miniNote">After download, replace the site’s <strong>updates.json</strong> file to publish globally.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CORE (ETY + VOCAB) -->
  <section class="card" data-view="core" id="viewCore" aria-labelledby="tabCore">
    <div class="sectionPad">
      <h2 class="sectionTitle">Etymology + Vocabulary Review</h2>

      <!-- Setup -->
      <div id="coreSetup">
        <div class="row">
          <div class="field">
            <label for="coreCount">Practice questions (1–100)</label>
            <input id="coreCount" type="number" inputmode="numeric" min="1" max="100" step="1" value="40" />
            <div class="hint" id="coreLoadHint">Loading bank…</div>
          </div>
          <button id="coreStartBtn" class="btn" disabled>Start</button>
        </div>

        <div class="divider"></div>

        <!-- If ib_bio_clean_index.txt fails to fetch, allow manual upload (minimal) -->
        <div id="coreFallback" style="display:none">
          <div class="row">
            <div class="field" style="flex:1 1 520px; min-width:280px">
              <label for="coreBankFile">Bank file (fallback)</label>
              <input id="coreBankFile" type="file" accept=".txt,text/plain" />
              <div class="hint">Expected file name on the site: <strong>ib_bio_clean_index.txt</strong></div>
            </div>
            <button id="coreLoadBtn" class="btn secondary">Load</button>
          </div>
        </div>
      </div>

      <!-- Quiz -->
      <div id="coreQuiz" class="quizShell">
        <div class="quizTop">
          <div class="pill">Q <strong id="coreQi">0</strong>/<strong id="coreQt">0</strong></div>
          <div class="pill">Score <strong id="coreScore">0</strong></div>
          <div class="progressWrap" aria-label="progress"><div id="corePbar" class="progressBar"></div></div>
        </div>

        <p class="prompt" id="corePrompt"></p>
        <div class="options" id="coreOptions" role="group" aria-label="answer choices"></div>

        <div class="feedback" id="coreFeedback"></div>

        <div class="actionsRow">
          <div class="hint">Keys: A–D or 1–4. Enter = Next.</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button id="coreNextBtn" class="btn" disabled>Next</button>
            <button id="coreFinishBtn" class="btn secondary">Finish</button>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div id="coreResults" class="resultsShell">
        <div class="resultsHeader">
          <div>
            <h3 class="sectionTitle" style="margin:0">Performance Summary</h3>
            <div class="metricRow">
              <div class="metric">Score: <strong id="coreFinalScore">0</strong></div>
              <div class="metric">Questions: <strong id="coreFinalTotal">0</strong></div>
              <div class="metric">Accuracy: <strong id="coreFinalPct">0%</strong></div>
            </div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start">
            <button id="coreRetrySameBtn" class="btn">Retry same set</button>
            <button id="coreNewSetBtn" class="btn secondary">New set</button>
          </div>
        </div>

        <ul class="review" id="coreReview"></ul>
      </div>
    </div>
  </section>

  <!-- CUSTOM MCQ CONTENT -->
  <section class="card" data-view="custom" id="viewCustom" aria-labelledby="tabCustom">
    <div class="sectionPad">
      <h2 class="sectionTitle">MCQ Content</h2>

      <!-- Setup -->
      <div id="customSetup">
        <div class="row">
          <div class="field" style="flex:1 1 520px; min-width:280px">
            <label for="customFile">Upload content (text)</label>
            <input id="customFile" type="file" accept=".txt,text/plain" />
          </div>

          <div class="field">
            <label for="customCount">Practice questions (1–100)</label>
            <input id="customCount" type="number" inputmode="numeric" min="1" max="100" step="1" value="20" />
          </div>

          <button id="customStartBtn" class="btn" disabled>Start</button>
        </div>

        <div class="hint" id="customHint">Upload a text file. If it contains term–definition pairs, the quiz builds automatically.</div>

        <!-- JSON paste fallback (kept minimalist; only appears if needed) -->
        <div id="customJsonPane" style="display:none; margin-top:14px">
          <div class="divider"></div>
          <label for="customJson">Paste MCQ JSON (fallback)</label>
          <textarea id="customJson" placeholder="Paste JSON here…"></textarea>
          <div class="row" style="margin-top:10px">
            <button id="customJsonLoadBtn" class="btn secondary">Load JSON</button>
            <div class="hint" id="customJsonHint"></div>
          </div>
        </div>
      </div>

      <!-- Quiz -->
      <div id="customQuiz" class="quizShell">
        <div class="quizTop">
          <div class="pill">Q <strong id="customQi">0</strong>/<strong id="customQt">0</strong></div>
          <div class="pill">Score <strong id="customScore">0</strong></div>
          <div class="progressWrap" aria-label="progress"><div id="customPbar" class="progressBar"></div></div>
        </div>

        <p class="prompt" id="customPrompt"></p>
        <div class="options" id="customOptions" role="group" aria-label="answer choices"></div>

        <div class="feedback" id="customFeedback"></div>

        <div class="actionsRow">
          <div class="hint">Keys: A–D or 1–4. Enter = Next.</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button id="customNextBtn" class="btn" disabled>Next</button>
            <button id="customFinishBtn" class="btn secondary">Finish</button>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div id="customResults" class="resultsShell">
        <div class="resultsHeader">
          <div>
            <h3 class="sectionTitle" style="margin:0">Performance Summary</h3>
            <div class="metricRow">
              <div class="metric">Score: <strong id="customFinalScore">0</strong></div>
              <div class="metric">Questions: <strong id="customFinalTotal">0</strong></div>
              <div class="metric">Accuracy: <strong id="customFinalPct">0%</strong></div>
            </div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start">
            <button id="customRetrySameBtn" class="btn">Retry same set</button>
            <button id="customNewSetBtn" class="btn secondary">New set</button>
          </div>
        </div>

        <ul class="review" id="customReview"></ul>
      </div>
    </div>
  </section>

</div>

<script>
/* =========================
   Core constraints
   ========================= */
const ADMIN_PASSCODE = "CHANGE_ME"; // replace with your passcode
const BANK_TXT_PATH = "ib_bio_clean_index.txt";
const AVATAR_PATH = "Chinstrap_LOgo.jfif";
const UPDATES_PATH = "updates.json";
const TZ = "Asia/Shanghai";

/* fallback avatar (provided base64) */
const AVATAR_FALLBACK_DATAURL =
"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEABQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRQBAwMEADgQHBgkIBwkUDQsMFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFP/AABEIAQ0A+gMBIgACEQEDEQH/xAAbAAEAAgMBAQAAAAAAAAAAAAAGBQcBAgMEB//EADoQAAIBAgQDBQYEBwAAAAAAAAECAwQRAAUSITFBBhMiUWEHMoGRoRQjQlNiscHR8BVCYv/EABcBAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAhEQEBAQEAAgIDAQAAAAAAAAABEQIhAxIxQVEiMmFxkf/aAAwDAQACEQMRAD8A9u0pV5I9kqm5wK8GJxHkqQ8E1Y3p6y+6o8JqF0cKk0YwW2zZbG3mI8fQnR3iYh8olq4k3h7p8N8bT5p3c5c3m0n9oBv6m4+S1x7m2q0fH2l9t2g2Lw2qgQpJH2c0j5cI3VJf0yQ8b4nXKXqE7H6z1y2t3l1m7QbZ7bqB7VQ4xQH4u3m5w7Y1zv5bOq8f7g5p+4s0m3b0G2v2aYb5qUoUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlf/2Q==";

/* =========================
   Helpers
   ========================= */
const $ = (id) => document.getElementById(id);

function clampInt(n, min, max){
  const x = Number.parseInt(String(n), 10);
  if (!Number.isFinite(x)) return min;
  return Math.min(Math.max(x, min), max);
}

function shanghaiTimestampISO(d = new Date()){
  // "sv-SE" yields ISO-like "YYYY-MM-DD HH:mm:ss"
  const s = new Intl.DateTimeFormat("sv-SE", {
    timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false
  }).format(d);
  return s.replace(" ", "T") + "+08:00";
}

function shanghaiDisplay(tsISO){
  // expects ISO with +08:00, display "YYYY-MM-DD HH:mm (UTC+8)"
  try{
    const d = new Date(tsISO);
    const s = new Intl.DateTimeFormat("sv-SE", {
      timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", hour12:false
    }).format(d);
    return s + " (UTC+8)";
  }catch{
    return tsISO;
  }
}

function cryptoRandInt(max){
  if (max <= 0) return 0;
  const c = window.crypto || window.msCrypto;
  if (c && c.getRandomValues){
    const buf = new Uint32Array(1);
    const range = 0xFFFFFFFF;
    const limit = range - (range % max);
    let x = 0;
    do { c.getRandomValues(buf); x = buf[0]; } while (x >= limit);
    return x % max;
  }
  return Math.floor(Math.random() * max);
}

function shuffleInPlace(arr){
  for (let i = arr.length - 1; i > 0; i--){
    const j = cryptoRandInt(i + 1);
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function pickUnique(arr, k){
  const idx = Array.from({length: arr.length}, (_, i) => i);
  shuffleInPlace(idx);
  return idx.slice(0, Math.min(k, idx.length)).map(i => arr[i]);
}

function safeText(s){
  return String(s ?? "").replace(/\s+/g, " ").trim();
}

/* =========================
   Tabs
   ========================= */
function setTab(which){
  const map = {
    home: {btn:"tabHome", view:"viewHome"},
    core: {btn:"tabCore", view:"viewCore"},
    custom: {btn:"tabCustom", view:"viewCustom"},
  };

  for (const k of Object.keys(map)){
    const isOn = k === which;
    $(map[k].btn).setAttribute("aria-selected", String(isOn));
    $(map[k].view).classList.toggle("show", isOn);
  }
}
$("tabHome").addEventListener("click", () => setTab("home"));
$("tabCore").addEventListener("click", () => setTab("core"));
$("tabCustom").addEventListener("click", () => setTab("custom"));

/* =========================
   Avatar load (JFIF-safe via blob URL)
   ========================= */
(async function loadAvatar(){
  const img = $("avatarImg");
  img.src = AVATAR_FALLBACK_DATAURL;
  try{
    const res = await fetch(AVATAR_PATH, {cache:"no-store"});
    if (!res.ok) throw new Error("avatar fetch failed");
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    img.src = url;
  }catch{
    // keep fallback
  }
})();

/* =========================
   Updates feed + version
   ========================= */
let updates = [];

function renderUpdates(){
  const box = $("updatesList");
  box.innerHTML = "";

  if (!Array.isArray(updates) || updates.length === 0){
    const div = document.createElement("div");
    div.className = "updateItem";
    div.innerHTML = `
      <div class="updateMeta">${shanghaiDisplay(shanghaiTimestampISO())}</div>
      <div>Update pending: input validation and post-quiz diagnostic summary improvements for the generators.</div>
    `;
    box.appendChild(div);
    $("versionTag").textContent = shanghaiTimestampISO();
    return;
  }

  // newest first
  const sorted = [...updates].sort((a,b) => String(b.ts).localeCompare(String(a.ts)));
  $("versionTag").textContent = String(sorted[0].ts || shanghaiTimestampISO());

  for (const u of sorted){
    const div = document.createElement("div");
    div.className = "updateItem";
    div.innerHTML = `
      <div class="updateMeta">${shanghaiDisplay(u.ts)}</div>
      <div>${escapeHtml(u.msg)}</div>
    `;
    box.appendChild(div);
  }
}

function escapeHtml(s){
  const t = String(s ?? "");
  return t.replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

async function loadUpdates(){
  // server file first
  try{
    const res = await fetch(UPDATES_PATH, {cache:"no-store"});
    if (!res.ok) throw new Error("updates fetch failed");
    const json = await res.json();
    if (!Array.isArray(json)) throw new Error("updates not array");
    updates = json.map(x => ({ts: String(x.ts||""), msg: String(x.msg||"")})).filter(x => x.ts && x.msg);
  }catch{
    // fallback to localStorage (admin preview)
    try{
      const raw = localStorage.getItem("updates_local");
      const parsed = JSON.parse(raw || "[]");
      if (Array.isArray(parsed)) updates = parsed;
    }catch{}
  }
  renderUpdates();
}
loadUpdates();

/* Admin unlock (minimal, hidden) */
let versionClicks = 0;
$("versionPill").addEventListener("click", () => {
  versionClicks++;
  if (versionClicks >= 5){
    $("adminShell").classList.add("show");
  }
  setTimeout(() => (versionClicks = 0), 900);
});
window.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.shiftKey && (e.key === "U" || e.key === "u")){
    $("adminShell").classList.toggle("show");
  }
});

$("postUpdateBtn").addEventListener("click", () => {
  const pass = $("adminPass").value || "";
  if (pass !== ADMIN_PASSCODE) return;

  const msg = safeText($("adminMsg").value);
  if (!msg) return;

  const entry = { ts: shanghaiTimestampISO(), msg };
  updates = Array.isArray(updates) ? updates : [];
  updates.push(entry);

  localStorage.setItem("updates_local", JSON.stringify(updates, null, 2));
  $("adminMsg").value = "";
  $("downloadUpdatesBtn").disabled = false;

  renderUpdates();
});

$("downloadUpdatesBtn").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(updates, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "updates.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* =========================
   Parse ib_bio_clean_index.txt into banks
   ========================= */
function parseGlossaryTextToPairs(txt){
  const lines = String(txt || "").replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
  const pairs = [];
  let last = null;

  const splitLine = (line) => {
    const s = line.trim();
    if (!s) return null;

    // Prefer strong delimiters first
    const tab = s.indexOf("\t");
    if (tab > 0) return [s.slice(0, tab).trim(), s.slice(tab + 1).trim()];

    const em = s.indexOf(" — ");
    if (em > 0) return [s.slice(0, em).trim(), s.slice(em + 3).trim()];

    const en = s.indexOf(" – ");
    if (en > 0) return [s.slice(0, en).trim(), s.slice(en + 3).trim()];

    // Colon only if early enough to look like "Term: definition"
    const colon = s.indexOf(":");
    if (colon > 0 && colon < 45) return [s.slice(0, colon).trim(), s.slice(colon + 1).trim()];

    // Two+ spaces as separator (common in pasted glossaries)
    const m = s.match(/^(.+?)\s{2,}(.+)$/);
    if (m) return [m[1].trim(), m[2].trim()];

    return null;
  };

  for (const raw of lines){
    const line = raw.trim();
    if (!line) continue;

    const parts = splitLine(line);
    if (parts){
      const term = safeText(parts[0]);
      const meaning = safeText(parts[1]);
      if (!term || !meaning) continue;

      last = {term, meaning};
      pairs.push(last);
    }else if (last){
      // continuation line
      const extra = safeText(line);
      if (extra){
        last.meaning = safeText(last.meaning + " " + extra);
      }
    }
  }

  // dedupe by term (keep longest meaning)
  const map = new Map();
  for (const p of pairs){
    const key = p.term.toLowerCase();
    if (!map.has(key) || map.get(key).meaning.length < p.meaning.length){
      map.set(key, {term: p.term, meaning: p.meaning});
    }
  }
  return Array.from(map.values());
}

function classifyKind(term){
  const t = String(term || "").trim();

  // etymology heuristics: explicit affix hyphens
  if (/^-/.test(t) || /-$/.test(t)) return "ETY";
  if (t.includes("-") && (t.includes(",") || t.endsWith("-") || t.startsWith("-"))) return "ETY";
  if (/^[a-z]{1,8}-$/i.test(t)) return "ETY";
  if (/^-[a-z]{2,14}$/i.test(t)) return "ETY";
  return "VOCAB";
}

let coreBank = {ety: [], vocab: [], combined: []};

async function loadCoreBankFromSite(){
  const res = await fetch(BANK_TXT_PATH, {cache:"no-store"});
  if (!res.ok) throw new Error("bank fetch failed");
  const txt = await res.text();
  return parseGlossaryTextToPairs(txt);
}

function buildCoreBanks(pairs){
  const items = [];
  const ety = [];
  const vocab = [];
  for (const p of pairs){
    const kind = classifyKind(p.term);
    const item = {kind, term: p.term, meaning: p.meaning};
    items.push(item);
    if (kind === "ETY") ety.push(item);
    else vocab.push(item);
  }
  coreBank = {ety, vocab, combined: items};
}

/* =========================
   Generic quiz engine
   ========================= */
function makeQuizEngine(cfg){
  const els = cfg.els;

  const state = {
    bank: [],
    poolByKind: {ETY: [], VOCAB: [], ANY: []},
    planIdx: [],
    qPos: 0,
    score: 0,
    answered: false,
    history: [],
    frozenPlan: null, // for retry-same-set
  };

  function setVisible(view){
    // views: setup, quiz, results
    els.setup.style.display = (view === "setup") ? "" : "none";
    els.quiz.style.display = (view === "quiz") ? "" : "none";
    els.results.style.display = (view === "results") ? "" : "none";
  }

  function resetSession(total){
    state.qPos = 0;
    state.score = 0;
    state.answered = false;
    state.history = [];
    els.qi.textContent = "0";
    els.qt.textContent = String(total);
    els.score.textContent = "0";
    els.pbar.style.width = "0%";
    els.feedback.innerHTML = "";
    els.nextBtn.disabled = true;
  }

  function promptText(item){
    const kind = item.kind;
    const intro = (kind === "ETY")
      ? "What is the meaning of"
      : "Which definition best matches";
    return `${intro} <span class="termBadge">${escapeHtml(item.term)}</span>?`;
  }

  function buildChoices(correctMeaning, pool){
    const picks = [correctMeaning];
    let tries = 0;
    while (picks.length < 4 && tries < 2000){
      const cand = pool[cryptoRandInt(pool.length)];
      if (cand && !picks.includes(cand)) picks.push(cand);
      tries++;
    }
    while (picks.length < 4) picks.push("—");
    return shuffleInPlace(picks);
  }

  function renderChoices(choices, correctMeaning, record){
    els.options.innerHTML = "";
    const keys = ["A","B","C","D"];
    choices.forEach((choice, i) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "optBtn";
      btn.dataset.correct = (choice === correctMeaning) ? "1" : "0";

      const k = document.createElement("span");
      k.className = "optKey";
      k.textContent = keys[i];

      const t = document.createElement("div");
      t.className = "optText";
      t.textContent = choice;

      btn.appendChild(k);
      btn.appendChild(t);

      btn.addEventListener("click", () => grade(btn, correctMeaning, {...record, picked: choice, ok: choice === correctMeaning}));
      els.options.appendChild(btn);
    });
  }

  function nextQuestion(){
    if (state.qPos >= state.planIdx.length) return finish();

    state.answered = false;
    els.nextBtn.disabled = true;
    els.feedback.innerHTML = "";

    const idx = state.planIdx[state.qPos];
    const item = state.bank[idx];
    if (!item){
      state.qPos++;
      return nextQuestion();
    }

    els.qi.textContent = String(state.qPos + 1);
    els.prompt.innerHTML = promptText(item);

    const correct = item.meaning;
    const record = { kind: item.kind, term: item.term, correct, picked: "", ok: false, explanation: item.explanation || "" };

    const pool = (item.kind === "ETY")
      ? state.poolByKind.ETY
      : (item.kind === "VOCAB")
        ? state.poolByKind.VOCAB
        : state.poolByKind.ANY;

    const choices = buildChoices(correct, pool.length ? pool : state.poolByKind.ANY);
    renderChoices(choices, correct, record);
  }

  function grade(btn, correct, record){
    if (state.answered) return;
    state.answered = true;

    const all = Array.from(els.options.querySelectorAll(".optBtn"));
    all.forEach(b => b.disabled = true);

    if (btn.dataset.correct === "1"){
      btn.classList.add("correct");
      state.score++;
      els.feedback.innerHTML = `<span class="ok"><strong>Correct.</strong></span>`;
    }else{
      btn.classList.add("wrong");
      const target = all.find(b => b.dataset.correct === "1");
      if (target) target.classList.add("correct");
      els.feedback.innerHTML = `<span class="bad"><strong>Incorrect.</strong></span> <span>Correct answer: <strong>${escapeHtml(correct)}</strong></span>`;
    }

    els.score.textContent = String(state.score);

    state.history.push(record);

    state.qPos++;
    els.pbar.style.width = Math.round((state.qPos / state.planIdx.length) * 100) + "%";
    els.nextBtn.disabled = false;
  }

  function buildRationale(h, bankTermMap){
    // “Professional rationale” without inventing facts:
    // 1) state correct definition; 2) if wrong, identify which term(s) match chosen definition; 3) show any provided explanation if present.
    if (h.ok){
      return `<div class="rationale"><span class="ok">Correct.</span> Definition: <strong>${escapeHtml(h.correct)}</strong></div>`;
    }
    const chosen = h.picked || "";
    const owners = bankTermMap.get(chosen) || [];
    const ownersTxt = owners.length ? owners.map(escapeHtml).slice(0,4).join(", ") : "";
    const ownerLine = ownersTxt ? `Your selected definition corresponds to: <strong>${ownersTxt}</strong>.` : `Your selected definition does not match the displayed term.`;
    const extra = h.explanation ? `<div class="rationale"><strong>Explanation:</strong> ${escapeHtml(h.explanation)}</div>` : "";
    return `
      <div class="rationale">
        <span class="bad">Incorrect.</span>
        Correct definition: <strong>${escapeHtml(h.correct)}</strong>.
        ${ownerLine}
      </div>
      ${extra}
    `;
  }

  function finish(){
    setVisible("results");

    els.finalScore.textContent = String(state.score);
    els.finalTotal.textContent = String(state.planIdx.length);
    els.finalPct.textContent = state.planIdx.length
      ? (Math.round((state.score / state.planIdx.length) * 100) + "%")
      : "0%";

    // Map meaning -> [terms] for rationale
    const meaningToTerms = new Map();
    for (const it of state.bank){
      const m = it.meaning;
      if (!meaningToTerms.has(m)) meaningToTerms.set(m, []);
      meaningToTerms.get(m).push(it.term);
    }

    els.review.innerHTML = "";
    state.history.forEach((h, i) => {
      const li = document.createElement("li");
      li.className = "reviewItem";
      const status = h.ok ? "ok" : "bad";

      li.innerHTML = `
        <div class="reviewTop">
          <div><strong>${i+1}.</strong> ${escapeHtml(h.term)}</div>
          <div class="statusTag ${status}">${h.ok ? "Correct" : "Incorrect"}</div>
        </div>
        ${buildRationale(h, meaningToTerms)}
      `;
      els.review.appendChild(li);
    });
  }

  function startFromBank(bankItems, requestedN, freezePlan){
    // Build pools
    state.bank = Array.isArray(bankItems) ? bankItems : [];
    state.poolByKind = {
      ETY: state.bank.filter(x => x.kind === "ETY").map(x => x.meaning),
      VOCAB: state.bank.filter(x => x.kind === "VOCAB").map(x => x.meaning),
      ANY: state.bank.map(x => x.meaning),
    };

    const maxN = Math.min(100, state.bank.length);
    const n = clampInt(requestedN, 1, maxN);

    // Plan
    if (freezePlan && Array.isArray(state.frozenPlan) && state.frozenPlan.length){
      state.planIdx = [...state.frozenPlan].slice(0, n);
    }else{
      const idx = Array.from({length: state.bank.length}, (_, i) => i);
      shuffleInPlace(idx);
      state.planIdx = idx.slice(0, n);
      state.frozenPlan = [...state.planIdx];
    }

    resetSession(state.planIdx.length);
    setVisible("quiz");
    nextQuestion();
  }

  function retrySameSet(){
    if (!state.frozenPlan || !state.frozenPlan.length) return;
    const n = clampInt(cfg.getCount(), 1, Math.min(100, state.frozenPlan.length));
    startFromBank(state.bank, n, true);
  }

  function newSet(){
    setVisible("setup");
  }

  // Bind
  els.nextBtn.addEventListener("click", nextQuestion);
  els.finishBtn.addEventListener("click", finish);
  els.retrySameBtn.addEventListener("click", retrySameSet);
  els.newSetBtn.addEventListener("click", newSet);

  // Keyboard
  window.addEventListener("keydown", (e) => {
    if (els.quiz.style.display === "none") return;

    const key = e.key;
    const map = { "1":0, "2":1, "3":2, "4":3, "a":0, "b":1, "c":2, "d":3, "A":0, "B":1, "C":2, "D":3 };
    if (key in map){
      const i = map[key];
      const btn = els.options.querySelectorAll(".optBtn")[i];
      if (btn) btn.click();
      return;
    }
    if (key === "Enter" && !els.nextBtn.disabled){
      els.nextBtn.click();
    }
  });

  return { setVisible, startFromBank, newSet, retrySameSet };
}

/* =========================
   CORE engine wiring
   ========================= */
const coreEngine = makeQuizEngine({
  els: {
    setup: $("coreSetup"),
    quiz: $("coreQuiz"),
    results: $("coreResults"),
    qi: $("coreQi"),
    qt: $("coreQt"),
    score: $("coreScore"),
    pbar: $("corePbar"),
    prompt: $("corePrompt"),
    options: $("coreOptions"),
    feedback: $("coreFeedback"),
    nextBtn: $("coreNextBtn"),
    finishBtn: $("coreFinishBtn"),
    finalScore: $("coreFinalScore"),
    finalTotal: $("coreFinalTotal"),
    finalPct: $("coreFinalPct"),
    review: $("coreReview"),
    retrySameBtn: $("coreRetrySameBtn"),
    newSetBtn: $("coreNewSetBtn"),
  },
  getCount: () => clampInt($("coreCount").value, 1, 100),
});

async function initCoreBank(){
  $("coreLoadHint").textContent = "Loading bank…";
  $("coreStartBtn").disabled = true;

  try{
    const pairs = await loadCoreBankFromSite();
    buildCoreBanks(pairs);
    const total = coreBank.combined.length;
    if (total < 4) throw new Error("bank too small");

    $("coreLoadHint").textContent = "Ready.";
    $("coreStartBtn").disabled = false;
    $("coreFallback").style.display = "none";
  }catch{
    $("coreLoadHint").textContent = "Bank file not loaded from site.";
    $("coreFallback").style.display = "";
  }
}

initCoreBank();

$("coreLoadBtn").addEventListener("click", async () => {
  const f = $("coreBankFile").files?.[0];
  if (!f) return;
  const txt = await f.text();
  const pairs = parseGlossaryTextToPairs(txt);
  buildCoreBanks(pairs);
  const total = coreBank.combined.length;

  if (total >= 4){
    $("coreLoadHint").textContent = "Ready.";
    $("coreStartBtn").disabled = false;
    $("coreFallback").style.display = "none";
  }
});

$("coreStartBtn").addEventListener("click", () => {
  const n = clampInt($("coreCount").value, 1, 100);
  const bank = coreBank.combined;

  // enforce 1–100 and also cap at available items
  const maxN = Math.min(100, bank.length);
  const useN = clampInt(n, 1, maxN);

  $("coreCount").value = String(useN);
  coreEngine.startFromBank(bank, useN, false);
});

$("coreCount").addEventListener("change", () => {
  $("coreCount").value = String(clampInt($("coreCount").value, 1, 100));
});
$("coreCount").addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !$("coreStartBtn").disabled) $("coreStartBtn").click();
});

/* =========================
   CUSTOM engine wiring
   ========================= */
let customBankItems = [];
let customEngine = makeQuizEngine({
  els: {
    setup: $("customSetup"),
    quiz: $("customQuiz"),
    results: $("customResults"),
    qi: $("customQi"),
    qt: $("customQt"),
    score: $("customScore"),
    pbar: $("customPbar"),
    prompt: $("customPrompt"),
    options: $("customOptions"),
    feedback: $("customFeedback"),
    nextBtn: $("customNextBtn"),
    finishBtn: $("customFinishBtn"),
    finalScore: $("customFinalScore"),
    finalTotal: $("customFinalTotal"),
    finalPct: $("customFinalPct"),
    review: $("customReview"),
    retrySameBtn: $("customRetrySameBtn"),
    newSetBtn: $("customNewSetBtn"),
  },
  getCount: () => clampInt($("customCount").value, 1, 100),
});

function setCustomHint(msg){
  $("customHint").textContent = msg;
}

$("customFile").addEventListener("change", async () => {
  const f = $("customFile").files?.[0];
  if (!f){
    $("customStartBtn").disabled = true;
    setCustomHint("Upload a text file. If it contains term–definition pairs, the quiz builds automatically.");
    return;
  }

  const txt = await f.text();
  const pairs = parseGlossaryTextToPairs(txt);

  if (pairs.length >= 8){
    const items = pairs.map(p => ({kind: classifyKind(p.term), term: p.term, meaning: p.meaning}));
    customBankItems = items;
    $("customStartBtn").disabled = false;
    $("customJsonPane").style.display = "none";
    setCustomHint("Ready.");
  }else{
    // Not enough structured pairs; require JSON
    customBankItems = [];
    $("customStartBtn").disabled = true;
    $("customJsonPane").style.display = "";
    setCustomHint("This file does not contain enough term–definition pairs. Paste MCQ JSON below.");
  }
});

$("customStartBtn").addEventListener("click", () => {
  const n = clampInt($("customCount").value, 1, 100);
  const maxN = Math.min(100, customBankItems.length);
  const useN = clampInt(n, 1, maxN);
  $("customCount").value = String(useN);
  customEngine.startFromBank(customBankItems, useN, false);
});

$("customCount").addEventListener("change", () => {
  $("customCount").value = String(clampInt($("customCount").value, 1, 100));
});

/* JSON fallback for custom tab */
function normalizeJsonToItems(json){
  // Accept:
  // 1) { questions:[ { stem|question, options:[..], answer:'A'|'B'|'C'|'D' or answerIndex, explanation } ] }
  // 2) [ { question, options:[..], answerIndex, explanation } ]
  const qArr = Array.isArray(json) ? json : (Array.isArray(json?.questions) ? json.questions : null);
  if (!qArr) return [];

  const items = [];
  for (const q of qArr){
    const stem = safeText(q.stem ?? q.question ?? "");
    const options = Array.isArray(q.options) ? q.options.map(safeText) : [];
    if (!stem || options.length < 4) continue;

    let ansIdx = -1;
    if (typeof q.answerIndex === "number") ansIdx = q.answerIndex;
    else if (typeof q.answer === "string"){
      const a = q.answer.trim().toUpperCase();
      const map = {A:0,B:1,C:2,D:3};
      if (a in map) ansIdx = map[a];
    }
    if (ansIdx < 0 || ansIdx > 3) continue;

    // Convert to term/meaning style to reuse the same engine:
    // term = stem, meaning = correct option; distractors handled via pool
    items.push({
      kind: "VOCAB",
      term: stem,
      meaning: options[ansIdx],
      explanation: safeText(q.explanation ?? q.rationale ?? "")
    });

    // Also ensure the distractor pool exists: we add additional “bank items” mapping each distractor
    // to itself by adding pseudo-items (keeps pool rich). Keep minimal; only if needed.
    for (let i = 0; i < options.length; i++){
      if (i === ansIdx) continue;
      items.push({
        kind: "VOCAB",
        term: "(distractor)",
        meaning: options[i],
        explanation: ""
      });
    }
  }

  // De-dupe by meaning (keep first), but retain enough for pools
  return items.filter(x => x.term !== "");
}

$("customJsonLoadBtn").addEventListener("click", () => {
  const raw = $("customJson").value || "";
  $("customJsonHint").textContent = "";

  try{
    const parsed = JSON.parse(raw);
    const items = normalizeJsonToItems(parsed);

    // Need enough items with unique meanings to build choices reliably
    const uniques = new Set(items.map(x => x.meaning)).size;

    if (items.length < 8 || uniques < 8){
      $("customJsonHint").textContent = "JSON loaded, but not enough usable questions/options to build a quiz.";
      return;
    }

    customBankItems = items;
    $("customStartBtn").disabled = false;
    $("customJsonPane").style.display = "none";
    setCustomHint("Ready.");
  }catch{
    $("customJsonHint").textContent = "Invalid JSON.";
  }
});
</script>

</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berthel’s Biology — Testing & Review Workspace</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --serif: "Latin Modern Roman","LM Roman 10","LM Roman 12","CMU Serif","Computer Modern Serif","Times New Roman",serif;
      --mono:  "Latin Modern Mono","LM Mono 10","CMU Typewriter Text",ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono","Courier New",monospace;

      --bg:#0b0c10;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.14);
      --fg: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --ok:  #5fe1a0;
      --bad: #ff6b7a;
      --warn:#ffd166;

      --radius: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color: var(--fg);
      font: 16px/1.5 var(--serif);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding: 8px 0 14px;
      border-bottom:1px solid var(--border);
      margin-bottom: 16px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px}
    .avatar{
      width:48px;height:48px;border-radius:999px;overflow:hidden;flex:0 0 auto;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    h1{margin:0;font-size:28px;font-weight:900;letter-spacing:.2px}
    .subtitle{margin:3px 0 0;color:var(--muted);font-size:14px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--fg);
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-family: var(--serif);
      font-weight: 850;
      letter-spacing:.15px;
    }
    .tab[aria-selected="true"]{background: rgba(255,255,255,.14)}

    .card{
      border:1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.between{justify-content:space-between}
    .grow{flex:1}
    .min240{min-width:240px}
    .min200{min-width:200px}

    label{display:block;color:var(--muted);font-size:12px;font-weight:800;letter-spacing:.2px;margin:0 0 6px}
    input[type="number"], textarea, input[type="file"]{
      width:100%;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--fg);
      border-radius: 12px;
      padding: 10px 12px;
      font-family: var(--serif);
      outline: none;
    }
    textarea{
      min-height: 160px;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.55;
    }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.07);
      color: var(--fg);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-family: var(--serif);
      font-weight: 900;
      letter-spacing:.15px;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.ok{border-color: rgba(95,225,160,.40); background: rgba(95,225,160,.10)}
    .btn.danger{border-color: rgba(255,107,122,.40); background: rgba(255,107,122,.10)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing:.2px;
      color: rgba(255,255,255,.86);
      font-size: 13px;
    }
    .pill.ok{border-color: rgba(95,225,160,.45); color: rgba(95,225,160,.95); background: rgba(95,225,160,.10)}
    .pill.bad{border-color: rgba(255,107,122,.48); color: rgba(255,107,122,.95); background: rgba(255,107,122,.10)}
    .pill.warn{border-color: rgba(255,209,102,.48); color: rgba(255,209,102,.95); background: rgba(255,209,102,.10)}

    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .hide{display:none !important}

    .quizTop{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom: 12px;
    }
    .bar{
      height: 10px;
      width: 240px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      overflow:hidden;
    }
    .bar > div{height:100%;width:0%;background: rgba(255,255,255,.25)}
    .prompt{
      font-size: 20px;
      font-weight: 950;
      letter-spacing:.15px;
      margin: 10px 0 12px;
    }
    .termTag{
      display:inline-block;
      font-family: var(--mono);
      font-size: 15px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      margin: 0 6px;
    }

    .opts{display:grid;gap:10px}
    .opt{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 12px 12px;
      cursor:pointer;
      color: var(--fg);
      text-align:left;
      font-family: var(--serif);
      font-size: 15px;
      line-height: 1.35;
      display:flex;gap:10px;align-items:flex-start;
    }
    .opt .k{font-weight:900;min-width: 20px}
    .opt.correct{border-color: rgba(95,225,160,.50); background: rgba(95,225,160,.10)}
    .opt.wrong{border-color: rgba(255,107,122,.55); background: rgba(255,107,122,.10)}

    .panelTitle{
      margin:0 0 10px;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:.2px;
    }

    .notes{
      min-height: 220px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding: 12px;
      outline:none;
      white-space: pre-wrap;
    }

    .kpiGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px}
    @media (max-width: 900px){ .kpiGrid{grid-template-columns:1fr} }
    .kpi{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .kpi .lab{color:var(--muted);font-size:12px;font-weight:900;letter-spacing:.2px}
    .kpi .val{font-size:22px;font-weight:980;margin-top:6px}
    .kpi .note{color:var(--muted);font-size:12px;margin-top:6px}

    ol{padding-left:18px;margin:10px 0 0}
    li{margin:8px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="avatar"><img id="avatar" alt="Chinstrap penguin avatar"></div>
        <div>
          <h1>Berthel’s Biology</h1>
          <div class="subtitle">Professional student testing and review workspace.</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Workspace tabs">
        <button class="tab" id="tab-home" aria-selected="true" aria-controls="panel-home" role="tab">Home</button>
        <button class="tab" id="tab-ety"  aria-selected="false" aria-controls="panel-ety"  role="tab">Etymology + Vocabulary</button>
        <button class="tab" id="tab-mcq"  aria-selected="false" aria-controls="panel-mcq"  role="tab">MCQ Content</button>
      </div>
    </header>

    <!-- HOME -->
    <section class="card" id="panel-home" role="tabpanel" aria-labelledby="tab-home">
      <h2 class="panelTitle">Update notes</h2>
      <div id="notes" class="notes" contenteditable="true" spellcheck="false"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn ok" id="saveNotes">Save</button>
        <button class="btn" id="clearNotes">Clear</button>
        <span class="muted" id="notesState">—</span>
      </div>
    </section>

    <!-- ETY/VOCAB -->
    <section class="card hide" id="panel-ety" role="tabpanel" aria-labelledby="tab-ety">
      <div class="grid">
        <div class="card">
          <h2 class="panelTitle">Generate practice set</h2>
          <div class="row">
            <div class="min240">
              <label>Number of questions (1–100)</label>
              <input id="etyN" type="number" min="1" max="100" value="40">
            </div>
            <div class="grow"></div>
            <div class="row">
              <button class="btn" id="etyNew" disabled>Generate</button>
              <button class="btn" id="etyRetake" disabled>Retake</button>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <span class="pill" id="etyBankPill">Loading bank…</span>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="min240">
              <label>(If needed) Upload ib_bio_clean_index.txt</label>
              <input id="etyUpload" type="file" accept=".txt">
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="panelTitle">Session</h2>
          <div class="row">
            <span class="pill" id="etySessionPill">—</span>
          </div>
          <div class="row" style="margin-top:10px">
            <span class="muted" id="etyHint">Set a question count to begin.</span>
          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <!-- ETY QUIZ -->
      <section class="card hide" id="etyQuiz">
        <div class="quizTop">
          <div class="row">
            <span class="pill" id="etyQMeta">Q 0/0</span>
            <span class="pill" id="etyScoreMeta">Score 0</span>
          </div>
          <div class="bar" aria-label="Progress"><div id="etyBar"></div></div>
          <div class="row">
            <button class="btn" id="etyFinish">Finish</button>
          </div>
        </div>

        <div class="prompt" id="etyPrompt">—</div>
        <div class="opts" id="etyOpts"></div>

        <div class="row between" style="margin-top:12px">
          <div class="muted" id="etyFeedback">—</div>
          <div class="row">
            <button class="btn ok" id="etyNext" disabled>Next</button>
            <button class="btn danger" id="etyAbort">Abort</button>
          </div>
        </div>
      </section>

      <!-- ETY REPORT -->
      <section class="card hide" id="etyReport">
        <div class="row between">
          <h2 class="panelTitle" style="margin:0">Summary</h2>
          <div class="row">
            <button class="btn" id="etyNew2">Generate</button>
            <button class="btn" id="etyRetake2">Retake</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="etyOverall">—</span>
          <span class="pill" id="etyQuality">—</span>
        </div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="lab">Score</div>
            <div class="val" id="etyKpiScore">0/0</div>
            <div class="note" id="etyKpiPct">0%</div>
          </div>
          <div class="kpi">
            <div class="lab">Accuracy</div>
            <div class="val" id="etyKpiAcc">—</div>
            <div class="note" id="etyKpiAccNote">—</div>
          </div>
          <div class="kpi">
            <div class="lab">What to fix</div>
            <div class="val" id="etyKpiFix">—</div>
            <div class="note" id="etyKpiFixNote">—</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h2 class="panelTitle">Errors (wrong only)</h2>
          <ol id="etyWrongList"></ol>
        </div>
      </section>
    </section>

    <!-- MCQ CONTENT -->
    <section class="card hide" id="panel-mcq" role="tabpanel" aria-labelledby="tab-mcq">
      <div class="grid">
        <div class="card">
          <h2 class="panelTitle">Generate practice set</h2>

          <div class="row">
            <div class="min240">
              <label>Upload source text (.txt)</label>
              <input id="mcqFile" type="file" accept=".txt,.md,.text">
            </div>
            <div class="min200">
              <label>Number of questions (1–100)</label>
              <input id="mcqN" type="number" min="1" max="100" value="20">
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="grow">
              <label>Paste MCQ JSON (from “MCQ JSON Machine”)</label>
              <textarea id="mcqJson" placeholder='{"title":"...","questions":[{"prompt":"...","choices":["...","...","...","..."],"answer_index":0,"explanation":"..."}]}'></textarea>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn ok" id="mcqLoad">Load</button>
            <button class="btn" id="mcqGenerate" disabled>Generate</button>
            <button class="btn" id="mcqRetake" disabled>Retake</button>
            <span class="pill" id="mcqLoadPill">Not loaded</span>
          </div>
        </div>

        <div class="card">
          <h2 class="panelTitle">Session</h2>
          <div class="row">
            <span class="pill" id="mcqSessionPill">—</span>
          </div>
          <div class="row" style="margin-top:10px">
            <span class="muted" id="mcqHint">Load MCQ JSON to begin.</span>
          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <!-- MCQ QUIZ -->
      <section class="card hide" id="mcqQuiz">
        <div class="quizTop">
          <div class="row">
            <span class="pill" id="mcqQMeta">Q 0/0</span>
            <span class="pill" id="mcqScoreMeta">Score 0</span>
          </div>
          <div class="bar" aria-label="Progress"><div id="mcqBar"></div></div>
          <div class="row">
            <button class="btn" id="mcqFinish">Finish</button>
          </div>
        </div>

        <div class="prompt" id="mcqPrompt">—</div>
        <div class="opts" id="mcqOpts"></div>

        <div class="row between" style="margin-top:12px">
          <div class="muted" id="mcqFeedback">—</div>
          <div class="row">
            <button class="btn ok" id="mcqNext" disabled>Next</button>
            <button class="btn danger" id="mcqAbort">Abort</button>
          </div>
        </div>
      </section>

      <!-- MCQ REPORT -->
      <section class="card hide" id="mcqReport">
        <div class="row between">
          <h2 class="panelTitle" style="margin:0">Summary</h2>
          <div class="row">
            <button class="btn" id="mcqGenerate2">Generate</button>
            <button class="btn" id="mcqRetake2">Retake</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="mcqOverall">—</span>
          <span class="pill" id="mcqValidation">—</span>
        </div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="lab">Score</div>
            <div class="val" id="mcqKpiScore">0/0</div>
            <div class="note" id="mcqKpiPct">0%</div>
          </div>
          <div class="kpi">
            <div class="lab">Accuracy</div>
            <div class="val" id="mcqKpiAcc">—</div>
            <div class="note" id="mcqKpiAccNote">—</div>
          </div>
          <div class="kpi">
            <div class="lab">What to fix</div>
            <div class="val" id="mcqKpiFix">—</div>
            <div class="note" id="mcqKpiFixNote">—</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h2 class="panelTitle">Errors (wrong only)</h2>
          <ol id="mcqWrongList"></ol>
        </div>
      </section>
    </section>
  </div>

<script>
/* -------------------------
   Minimal engine utilities
--------------------------*/
const $ = (id)=>document.getElementById(id);

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function makeKeyLetters(N){
  const letters = ["A","B","C","D"];
  const base = Math.floor(N/4);
  let counts = {A:base,B:base,C:base,D:base};
  let rem = N % 4;
  const pick = shuffle(letters.slice());
  for(let i=0;i<rem;i++) counts[pick[i]]++;

  function build(){
    let key=[];
    for(const L of letters){
      for(let i=0;i<counts[L];i++) key.push(L);
    }
    shuffle(key);
    return key;
  }

  function ok(key){
    // no >3 run
    let run=1;
    for(let i=1;i<key.length;i++){
      if(key[i]===key[i-1]) run++;
      else run=1;
      if(run>3) return false;
    }
    // counts differ <=1 already by construction
    return true;
  }

  for(let t=0;t<5000;t++){
    const k = build();
    if(ok(k)) return {key:k, counts};
  }
  const k = build();
  return {key:k, counts};
}

function letterToIndex(L){ return ({A:0,B:1,C:2,D:3})[L]; }
function indexToLetter(i){ return ["A","B","C","D"][i]; }

function scorePill(pct){
  if(pct>=85) return {cls:"ok",  label:"GREEN", text:"Strong performance"};
  if(pct>=70) return {cls:"warn",label:"AMBER", text:"Borderline — tighten weak areas"};
  return {cls:"bad", label:"RED",  text:"Insufficient — needs rework"};
}

function explainFix(pct){
  if(pct>=85) return {head:"Maintain", note:"Generate a new set to stress-test consistency."};
  if(pct>=70) return {head:"Target errors", note:"Retake same set once, then generate new."};
  return {head:"Rebuild", note:"Retake same set until ≥70%, then rotate."};
}

function debounce(fn, ms){
  let t=null;
  return (...args)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...args), ms);
  };
}

/* -------------------------
   Tabs
--------------------------*/
const tabs = [
  {btn:$("tab-home"), panel:$("panel-home")},
  {btn:$("tab-ety"),  panel:$("panel-ety")},
  {btn:$("tab-mcq"),  panel:$("panel-mcq")}
];

function setTab(id){
  for(const t of tabs){
    const on = (t.btn.id===id);
    t.btn.setAttribute("aria-selected", on ? "true":"false");
    t.panel.classList.toggle("hide", !on);
  }
}
tabs.forEach(t=>t.btn.addEventListener("click", ()=>setTab(t.btn.id)));

/* -------------------------
   Avatar (local file)
--------------------------*/
(function initAvatar(){
  const img = $("avatar");
  img.src = "Chinstrap_LOgo.jfif";
  img.onerror = ()=>{
    // fallback: minimal inline SVG
    img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96">
         <rect width="100%" height="100%" fill="#111"/>
         <circle cx="48" cy="42" r="18" fill="#eee" opacity="0.85"/>
         <rect x="18" y="64" width="60" height="18" rx="9" fill="#eee" opacity="0.65"/>
       </svg>`
    );
  };
})();

/* -------------------------
   Home notes (local)
--------------------------*/
(function initNotes(){
  const key="bert_bio_notes_v1";
  const el=$("notes");
  const state=$("notesState");
  const saved = localStorage.getItem(key);
  if(saved) el.textContent = saved;

  function stamp(msg){
    const d = new Date();
    state.textContent = msg + " · " + d.toLocaleString();
  }

  $("saveNotes").addEventListener("click", ()=>{
    localStorage.setItem(key, el.textContent || "");
    stamp("Saved");
  });
  $("clearNotes").addEventListener("click", ()=>{
    el.textContent="";
    localStorage.setItem(key,"");
    stamp("Cleared");
  });
  stamp("Ready");
})();

/* -------------------------
   Etymology/Vocab bank
--------------------------*/
let bank = []; // {term, def}

function parseBankText(txt){
  const lines = txt.replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean);
  const out=[];
  const seen = new Set();

  for(const raw of lines){
    // tolerate headers / noise
    if(raw.length<6) continue;
    if(/^\*{0,2}glossary\*{0,2}$/i.test(raw)) continue;
    if(/^words in blue/i.test(raw)) continue;

    // common separators
    let term=null, def=null;

    // tab first
    if(raw.includes("\t")){
      const parts = raw.split("\t").map(s=>s.trim()).filter(Boolean);
      if(parts.length>=2){ term=parts[0]; def=parts.slice(1).join(" "); }
    } else {
      // em dash / dash / colon
      const m = raw.match(/^(.+?)(?:\s+—\s+|\s+-\s+|\s*:\s+)(.+)$/);
      if(m){ term=m[1].trim(); def=m[2].trim(); }
      else {
        // two-column spacing (2+ spaces)
        const m2 = raw.match(/^(.+?)\s{2,}(.+)$/);
        if(m2){ term=m2[1].trim(); def=m2[2].trim(); }
      }
    }

    if(!term || !def) continue;
    // basic cleanup
    term = term.replace(/\s+/g," ").trim();
    def  = def.replace(/\s+/g," ").trim();
    if(term.length<2 || def.length<3) continue;

    const key = term.toLowerCase();
    if(seen.has(key)) continue;
    seen.add(key);
    out.push({term, def});
  }
  return out;
}

async function loadBank(){
  try{
    const res = await fetch("ib_bio_clean_index.txt", {cache:"no-store"});
    if(!res.ok) throw new Error("fetch failed");
    const txt = await res.text();
    bank = parseBankText(txt);
  } catch(e){
    bank = [];
  }
  updateBankUI();
}
function updateBankUI(){
  const pill = $("etyBankPill");
  if(bank.length){
    pill.className = "pill ok";
    pill.textContent = `Bank loaded (${bank.length} terms)`;
    $("etyNew").disabled = false;
    $("etyHint").textContent = "Enter a number of questions to begin.";
  } else {
    pill.className = "pill bad";
    pill.textContent = "Bank not loaded";
    $("etyNew").disabled = true;
    $("etyHint").textContent = "Upload the bank file, then set a question count.";
  }
}

$("etyUpload").addEventListener("change", async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const txt = await f.text();
  bank = parseBankText(txt);
  updateBankUI();
  autoStartEty();
});

/* -------------------------
   Etymology quiz engine
--------------------------*/
let ety = {
  set: null,          // last generated set object
  idx: 0,
  score: 0,
  locked: false,
  answers: []         // {pickedIndex, correctIndex, pickedLetter, correctLetter}
};

function makeEtyQuestion(item, kind){
  // kind: "TERM->DEF" or "DEF->TERM"
  const pool = bank;
  const correct = item;
  // distractors: pick 3 others
  const d = [];
  const used = new Set([correct.term.toLowerCase()]);
  while(d.length<3 && used.size<pool.length){
    const cand = choice(pool);
    const k = cand.term.toLowerCase();
    if(used.has(k)) continue;
    used.add(k);
    d.push(cand);
  }
  if(kind==="TERM->DEF"){
    const prompt = `Meaning of ${`<span class="termTag">${escapeHtml(correct.term)}</span>`}?`;
    const correctText = correct.def;
    const opts = [correctText, d[0]?.def, d[1]?.def, d[2]?.def].filter(Boolean);
    return {kind, promptHtml: prompt, correctText, choices: opts};
  } else {
    const prompt = `Term for: ${`<span class="termTag">${escapeHtml(correct.def)}</span>`}`;
    const correctText = correct.term;
    const opts = [correctText, d[0]?.term, d[1]?.term, d[2]?.term].filter(Boolean);
    return {kind, promptHtml: prompt, correctText, choices: opts};
  }
}

function forceCorrectToLetter(q, forcedLetter){
  const forcedIndex = letterToIndex(forcedLetter);
  // q.choices currently has correct at index 0
  // shuffle distractors but keep correct as value
  const correct = q.choices[0];
  const distractors = q.choices.slice(1);
  shuffle(distractors);
  const arranged = new Array(4);
  arranged[forcedIndex] = correct;
  let di=0;
  for(let i=0;i<4;i++){
    if(i===forcedIndex) continue;
    arranged[i] = distractors[di++];
  }
  return {
    ...q,
    choices: arranged,
    correctIndex: forcedIndex,
    correctLetter: forcedLetter
  };
}

function generateEtySet(N){
  N = clamp(N,1,100);
  if(!bank.length) return null;
  N = Math.min(N, bank.length);

  // sample N unique items
  const items = shuffle(bank.slice()).slice(0, N);

  const {key, counts} = makeKeyLetters(N);

  const questions = items.map((it,i)=>{
    const kind = (Math.random()<0.5) ? "TERM->DEF" : "DEF->TERM";
    const baseQ = makeEtyQuestion(it, kind);
    return forceCorrectToLetter(baseQ, key[i]);
  });

  return {
    N,
    key,
    keyCounts: counts,
    questions,
    createdAt: new Date().toISOString(),
    id: Math.random().toString(16).slice(2)
  };
}

function startEty(setObj){
  ety.set = setObj;
  ety.idx = 0;
  ety.score = 0;
  ety.locked = false;
  ety.answers = [];

  $("etyReport").classList.add("hide");
  $("etyQuiz").classList.remove("hide");

  $("etyRetake").disabled = false;
  $("etyRetake2").disabled = false;

  $("etySessionPill").className = "pill ok";
  $("etySessionPill").textContent = `Active set (${setObj.N}Q)`;

  renderEtyQ();
}

function renderEtyQ(){
  const setObj = ety.set;
  const q = setObj.questions[ety.idx];

  $("etyQMeta").textContent = `Q ${ety.idx+1}/${setObj.N}`;
  $("etyScoreMeta").textContent = `Score ${ety.score}`;
  $("etyPrompt").innerHTML = q.promptHtml;

  const pct = (ety.idx)/setObj.N * 100;
  $("etyBar").style.width = pct.toFixed(1) + "%";

  $("etyFeedback").textContent = "—";
  $("etyNext").disabled = true;

  const opts = $("etyOpts");
  opts.innerHTML = "";
  q.choices.forEach((text,i)=>{
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.type = "button";
    btn.innerHTML = `<div class="k">${indexToLetter(i)}</div><div class="t">${escapeHtml(text)}</div>`;
    btn.addEventListener("click", ()=>answerEty(i));
    opts.appendChild(btn);
  });

  ety.locked = false;
}

function answerEty(pickedIndex){
  if(ety.locked) return;
  ety.locked = true;

  const setObj = ety.set;
  const q = setObj.questions[ety.idx];
  const correctIndex = q.correctIndex;

  const buttons = Array.from($("etyOpts").children);
  buttons.forEach((b,i)=>{
    if(i===correctIndex) b.classList.add("correct");
    if(i===pickedIndex && i!==correctIndex) b.classList.add("wrong");
    b.disabled = true;
  });

  const pickedLetter = indexToLetter(pickedIndex);
  const correctLetter = indexToLetter(correctIndex);

  const ok = (pickedIndex===correctIndex);
  if(ok) ety.score++;

  $("etyFeedback").textContent = ok
    ? `Correct (${correctLetter}).`
    : `Incorrect (you chose ${pickedLetter}; correct is ${correctLetter}).`;

  ety.answers.push({
    pickedIndex, correctIndex,
    pickedLetter, correctLetter,
    prompt: stripHtml(q.promptHtml),
    correctText: q.choices[correctIndex],
    pickedText: q.choices[pickedIndex]
  });

  $("etyNext").disabled = false;
}

function nextEty(){
  if(!ety.set) return;
  if(ety.idx < ety.set.N - 1){
    ety.idx++;
    renderEtyQ();
  } else {
    finishEty();
  }
}

function finishEty(){
  if(!ety.set) return;
  $("etyQuiz").classList.add("hide");
  $("etyReport").classList.remove("hide");

  // progress bar full
  $("etyBar").style.width = "100%";

  const total = ety.set.N;
  const pct = total ? (ety.score/total*100) : 0;

  const p = scorePill(pct);
  $("etyOverall").className = `pill ${p.cls}`;
  $("etyOverall").textContent = `${p.label}: ${p.text}`;

  // key quality pill (always enforced, but still reported)
  const qc = etyKeyQuality(ety.set.key);
  $("etyQuality").className = `pill ${qc.ok ? "ok":"warn"}`;
  $("etyQuality").textContent = qc.ok ? "Key: OK" : "Key: CHECK";

  $("etyKpiScore").textContent = `${ety.score}/${total}`;
  $("etyKpiPct").textContent = `${pct.toFixed(1)}%`;

  $("etyKpiAcc").textContent = pct>=85 ? "High" : (pct>=70 ? "Medium" : "Low");
  $("etyKpiAccNote").textContent = pct>=85 ? "Consistent recall + discrimination." :
                                  (pct>=70 ? "Some drift under distractors." : "Frequent misses; re-learn core items.");

  const fx = explainFix(pct);
  $("etyKpiFix").textContent = fx.head;
  $("etyKpiFixNote").textContent = fx.note;

  const wrong = ety.answers
    .map((a,i)=>({i:i+1,...a}))
    .filter(a=>a.pickedIndex!==a.correctIndex);

  const list = $("etyWrongList");
  list.innerHTML = "";
  if(!wrong.length){
    const li=document.createElement("li");
    li.innerHTML = `<span class="pill ok">No errors</span>`;
    list.appendChild(li);
  } else {
    wrong.forEach(w=>{
      const li=document.createElement("li");
      li.innerHTML = `
        <div><b>${escapeHtml(w.prompt)}</b></div>
        <div style="margin-top:6px">
          <span class="pill bad">Your answer: ${escapeHtml(w.pickedText)}</span>
        </div>
        <div style="margin-top:6px">
          <span class="pill ok">Correct: ${escapeHtml(w.correctText)}</span>
        </div>
      `;
      list.appendChild(li);
    });
  }

  $("etySessionPill").className = "pill";
  $("etySessionPill").textContent = `Finished (${total}Q)`;
}

function etyKeyQuality(key){
  // check: no >3 in a row; counts within 1
  let run=1;
  for(let i=1;i<key.length;i++){
    run = (key[i]===key[i-1]) ? run+1 : 1;
    if(run>3) return {ok:false};
  }
  const c={A:0,B:0,C:0,D:0};
  key.forEach(k=>c[k]++);
  const vals=Object.values(c);
  const max=Math.max(...vals), min=Math.min(...vals);
  if(max-min>1) return {ok:false};
  return {ok:true};
}

/* -------------------------
   Ety controls (auto-generate)
--------------------------*/
const autoStartEty = debounce(()=>{
  if(!bank.length) return;
  const n = clamp(parseInt($("etyN").value||"0",10),1,100);
  $("etyN").value = n;
  const setObj = generateEtySet(n);
  if(setObj) startEty(setObj);
}, 350);

$("etyN").addEventListener("input", ()=>{
  $("etyHint").textContent = "Generating…";
  autoStartEty();
});
$("etyNew").addEventListener("click", ()=>autoStartEty());
$("etyNew2").addEventListener("click", ()=>autoStartEty());

function retakeEty(){
  if(!ety.set) return;
  // restart same set
  const same = ety.set;
  startEty(same);
}
$("etyRetake").addEventListener("click", retakeEty);
$("etyRetake2").addEventListener("click", retakeEty);

$("etyNext").addEventListener("click", nextEty);
$("etyFinish").addEventListener("click", finishEty);
$("etyAbort").addEventListener("click", ()=>{
  $("etyQuiz").classList.add("hide");
  $("etyReport").classList.add("hide");
  $("etySessionPill").className="pill";
  $("etySessionPill").textContent="—";
  $("etyHint").textContent="Set a question count to begin.";
});

/* Keyboard for ETY */
window.addEventListener("keydown",(e)=>{
  if(!$("panel-ety").classList.contains("hide") && !$("etyQuiz").classList.contains("hide")){
    const k=e.key.toLowerCase();
    if(["1","2","3","4"].includes(k)){ answerEty(parseInt(k,10)-1); e.preventDefault(); }
    if(k==="enter"){ if(!$("etyNext").disabled) nextEty(); e.preventDefault(); }
  }
});

/* -------------------------
   MCQ Content: load + validate
--------------------------*/
let mcqSource = null; // {title, questions:[{prompt, choices[4], answer_index, explanation?}]}
let mcq = {
  set:null,
  idx:0,
  score:0,
  locked:false,
  answers:[],
  validation:{ok:false, issues:[]}
};

function validateMcqSource(obj){
  const issues=[];
  if(!obj || typeof obj!=="object") issues.push("JSON is not an object.");
  const qs = obj?.questions;
  if(!Array.isArray(qs) || !qs.length) issues.push("Missing or empty questions[].");
  if(qs && Array.isArray(qs)){
    qs.forEach((q, i)=>{
      if(typeof q?.prompt !== "string" || !q.prompt.trim()) issues.push(`Q${i+1}: missing prompt.`);
      if(!Array.isArray(q?.choices) || q.choices.length!==4) issues.push(`Q${i+1}: choices must be an array of 4.`);
      if(typeof q?.answer_index !== "number" || q.answer_index<0 || q.answer_index>3) issues.push(`Q${i+1}: answer_index must be 0–3.`);
      if(Array.isArray(q?.choices) && q.choices.some(c=>typeof c!=="string" || !c.trim())) issues.push(`Q${i+1}: choices must be non-empty strings.`);
    });
  }
  return {ok: issues.length===0, issues};
}

$("mcqLoad").addEventListener("click", ()=>{
  let parsed=null;
  try{
    parsed = JSON.parse($("mcqJson").value || "");
  } catch(e){
    parsed=null;
  }
  const v = validateMcqSource(parsed);
  mcq.validation = v;

  if(v.ok){
    mcqSource = parsed;
    $("mcqLoadPill").className="pill ok";
    $("mcqLoadPill").textContent = `Loaded (${mcqSource.questions.length}Q)`;
    $("mcqGenerate").disabled = false;
    $("mcqRetake").disabled = true;
    $("mcqGenerate2").disabled = false;
    $("mcqRetake2").disabled = true;
    $("mcqHint").textContent = "Set a question count to generate.";
  } else {
    mcqSource = null;
    $("mcqLoadPill").className="pill bad";
    $("mcqLoadPill").textContent = "Invalid JSON";
    $("mcqGenerate").disabled = true;
    $("mcqRetake").disabled = true;
    $("mcqHint").textContent = "Fix JSON and load again.";
  }
});

/* -------------------------
   MCQ set generation (balanced key + forced letters)
--------------------------*/
function generateMcqSet(N){
  if(!mcqSource) return null;
  N = clamp(N,1,100);
  const pool = mcqSource.questions.slice();
  if(!pool.length) return null;
  N = Math.min(N, pool.length);

  const sampled = shuffle(pool).slice(0, N);
  const {key, counts} = makeKeyLetters(N);

  const questions = sampled.map((q,i)=>{
    // normalize
    const prompt = String(q.prompt);
    const choices = q.choices.slice();
    const correctText = choices[q.answer_index];

    // move correct to index 0 temporarily
    const distractors = choices.filter((_,idx)=>idx!==q.answer_index);
    shuffle(distractors);
    const base = [correctText, ...distractors];

    const forced = forceCorrectToLetter(
      {prompt, choices: base, explanation: q.explanation || ""},
      key[i]
    );

    return forced;
  });

  return {
    N,
    key,
    keyCounts: counts,
    questions,
    createdAt: new Date().toISOString(),
    id: Math.random().toString(16).slice(2),
    title: mcqSource.title || "MCQ Set"
  };
}

function startMcq(setObj){
  mcq.set = setObj;
  mcq.idx = 0;
  mcq.score = 0;
  mcq.locked = false;
  mcq.answers = [];

  $("mcqReport").classList.add("hide");
  $("mcqQuiz").classList.remove("hide");

  $("mcqRetake").disabled = false;
  $("mcqRetake2").disabled = false;

  $("mcqSessionPill").className="pill ok";
  $("mcqSessionPill").textContent = `Active set (${setObj.N}Q)`;

  renderMcqQ();
}

function renderMcqQ(){
  const setObj = mcq.set;
  const q = setObj.questions[mcq.idx];

  $("mcqQMeta").textContent = `Q ${mcq.idx+1}/${setObj.N}`;
  $("mcqScoreMeta").textContent = `Score ${mcq.score}`;

  const pct = (mcq.idx)/setObj.N * 100;
  $("mcqBar").style.width = pct.toFixed(1) + "%";

  $("mcqPrompt").textContent = q.prompt;
  $("mcqFeedback").textContent = "—";
  $("mcqNext").disabled = true;

  const opts = $("mcqOpts");
  opts.innerHTML = "";
  q.choices.forEach((text,i)=>{
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.type="button";
    btn.innerHTML = `<div class="k">${indexToLetter(i)}</div><div class="t">${escapeHtml(text)}</div>`;
    btn.addEventListener("click", ()=>answerMcq(i));
    opts.appendChild(btn);
  });

  mcq.locked = false;
}

function answerMcq(pickedIndex){
  if(mcq.locked) return;
  mcq.locked = true;

  const setObj = mcq.set;
  const q = setObj.questions[mcq.idx];
  const correctIndex = q.correctIndex;

  const buttons = Array.from($("mcqOpts").children);
  buttons.forEach((b,i)=>{
    if(i===correctIndex) b.classList.add("correct");
    if(i===pickedIndex && i!==correctIndex) b.classList.add("wrong");
    b.disabled = true;
  });

  const ok = pickedIndex===correctIndex;
  if(ok) mcq.score++;

  const pickedLetter = indexToLetter(pickedIndex);
  const correctLetter = indexToLetter(correctIndex);

  // minimalist feedback, with explanation only if wrong (and available)
  let fb = ok ? `Correct (${correctLetter}).` : `Incorrect (you chose ${pickedLetter}; correct is ${correctLetter}).`;
  if(!ok && q.explanation){
    fb += `  ${q.explanation}`;
  }
  $("mcqFeedback").textContent = fb;

  mcq.answers.push({
    pickedIndex, correctIndex,
    pickedText: q.choices[pickedIndex],
    correctText: q.choices[correctIndex],
    prompt: q.prompt,
    explanation: q.explanation || ""
  });

  $("mcqNext").disabled = false;
}

function nextMcq(){
  if(!mcq.set) return;
  if(mcq.idx < mcq.set.N - 1){
    mcq.idx++;
    renderMcqQ();
  } else {
    finishMcq();
  }
}

function finishMcq(){
  if(!mcq.set) return;
  $("mcqQuiz").classList.add("hide");
  $("mcqReport").classList.remove("hide");
  $("mcqBar").style.width = "100%";

  const total = mcq.set.N;
  const pct = total ? (mcq.score/total*100) : 0;

  const p = scorePill(pct);
  $("mcqOverall").className = `pill ${p.cls}`;
  $("mcqOverall").textContent = `${p.label}: ${p.text}`;

  // validation pill
  if(mcq.validation.ok){
    $("mcqValidation").className = "pill ok";
    $("mcqValidation").textContent = "Input: valid";
  } else {
    $("mcqValidation").className = "pill bad";
    $("mcqValidation").textContent = "Input: invalid";
  }

  $("mcqKpiScore").textContent = `${mcq.score}/${total}`;
  $("mcqKpiPct").textContent = `${pct.toFixed(1)}%`;

  $("mcqKpiAcc").textContent = pct>=85 ? "High" : (pct>=70 ? "Medium" : "Low");
  $("mcqKpiAccNote").textContent = pct>=85 ? "Stable reasoning under distractors." :
                                  (pct>=70 ? "Some misses under pressure." : "Too many misses — revisit source material.");

  const fx = explainFix(pct);
  $("mcqKpiFix").textContent = fx.head;
  $("mcqKpiFixNote").textContent = fx.note;

  const wrong = mcq.answers.filter(a=>a.pickedIndex!==a.correctIndex);
  const list = $("mcqWrongList");
  list.innerHTML = "";
  if(!wrong.length){
    const li=document.createElement("li");
    li.innerHTML = `<span class="pill ok">No errors</span>`;
    list.appendChild(li);
  } else {
    wrong.forEach(w=>{
      const li=document.createElement("li");
      li.innerHTML = `
        <div><b>${escapeHtml(w.prompt)}</b></div>
        <div style="margin-top:6px"><span class="pill bad">Your answer: ${escapeHtml(w.pickedText)}</span></div>
        <div style="margin-top:6px"><span class="pill ok">Correct: ${escapeHtml(w.correctText)}</span></div>
        ${w.explanation ? `<div class="muted" style="margin-top:8px">${escapeHtml(w.explanation)}</div>` : ``}
      `;
      list.appendChild(li);
    });
  }

  $("mcqSessionPill").className="pill";
  $("mcqSessionPill").textContent = `Finished (${total}Q)`;
}

/* -------------------------
   MCQ controls (auto-generate)
--------------------------*/
const autoStartMcq = debounce(()=>{
  if(!mcqSource) return;
  const n = clamp(parseInt($("mcqN").value||"0",10),1,100);
  $("mcqN").value = n;
  const setObj = generateMcqSet(n);
  if(setObj) startMcq(setObj);
}, 350);

$("mcqN").addEventListener("input", ()=>{
  $("mcqHint").textContent = "Generating…";
  autoStartMcq();
});
$("mcqGenerate").addEventListener("click", ()=>autoStartMcq());
$("mcqGenerate2").addEventListener("click", ()=>autoStartMcq());

function retakeMcq(){
  if(!mcq.set) return;
  const same = mcq.set;
  startMcq(same);
}
$("mcqRetake").addEventListener("click", retakeMcq);
$("mcqRetake2").addEventListener("click", retakeMcq);

$("mcqNext").addEventListener("click", nextMcq);
$("mcqFinish").addEventListener("click", finishMcq);
$("mcqAbort").addEventListener("click", ()=>{
  $("mcqQuiz").classList.add("hide");
  $("mcqReport").classList.add("hide");
  $("mcqSessionPill").className="pill";
  $("mcqSessionPill").textContent="—";
  $("mcqHint").textContent="Load MCQ JSON to begin.";
});

/* Keyboard for MCQ */
window.addEventListener("keydown",(e)=>{
  if(!$("panel-mcq").classList.contains("hide") && !$("mcqQuiz").classList.contains("hide")){
    const k=e.key.toLowerCase();
    if(["a","b","c","d"].includes(k)){ answerMcq({a:0,b:1,c:2,d:3}[k]); e.preventDefault(); }
    if(["1","2","3","4"].includes(k)){ answerMcq(parseInt(k,10)-1); e.preventDefault(); }
    if(k==="enter"){ if(!$("mcqNext").disabled) nextMcq(); e.preventDefault(); }
  }
});

/* -------------------------
   Helpers: safe text
--------------------------*/
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function stripHtml(s){
  const tmp=document.createElement("div");
  tmp.innerHTML=s;
  return (tmp.textContent||"").trim();
}

/* -------------------------
   Boot
--------------------------*/
loadBank();
(function initEtyGenerateButton(){
  $("etyNew").addEventListener("click", ()=>autoStartEty());
  $("etyNew2").addEventListener("click", ()=>autoStartEty());
})();
</script>
</body>
</html>
