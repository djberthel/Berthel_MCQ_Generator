<section id="etyEngine" class="etyEngine">
  <header class="etyEngine__header">
    <div class="etyEngine__brand">
      <img
        class="etyEngine__avatar"
        src="assets/penguin.webp"
        alt="Penguin avatar"
        width="36"
        height="36"
        decoding="async"
        loading="eager"
        onerror="this.onerror=null; this.src='assets/penguin.png';"
      />
      <div class="etyEngine__title">
        <div class="etyEngine__h1">Berthel’s Etymology + Vocabulary Engine</div>
        <div class="etyEngine__sub">Black/White build · Auto-loaded banks</div>
      </div>
    </div>
  </header>

  <div class="etyEngine__wrap">
    <!-- Directory -->
    <section class="etyEngine__card" id="dirCard">
      <div class="etyEngine__pad">
        <div class="etyEngine__row">
          <div>
            <div class="etyEngine__label">Directory search</div>
            <input id="dirSearch" class="etyEngine__input" type="text" placeholder="Type to filter terms…" />
          </div>
          <div class="etyEngine__pill" id="loadedSummary">Loading…</div>
        </div>

        <div class="etyEngine__dir">
          <ol id="dirList" class="etyEngine__dirList"></ol>
          <div class="etyEngine__def">
            <div class="etyEngine__label">Selected</div>
            <div id="dirSelected" class="etyEngine__selected">(click a term)</div>
            <div id="dirMeaning" class="etyEngine__meaning"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Quiz Loader -->
    <section class="etyEngine__card" id="loaderCard">
      <div class="etyEngine__pad">
        <div class="etyEngine__row">
          <div style="min-width:220px">
            <div class="etyEngine__label">Questions</div>
            <input id="qCount" class="etyEngine__input" type="number" min="1" value="40" />
            <div class="etyEngine__muted" id="maxHint" style="margin-top:6px"></div>
          </div>
          <div class="etyEngine__pill">Mixed · 4 choices · Keyboard 1–4, Enter</div>
          <div style="flex:1"></div>
          <button id="startBtn" class="etyEngine__btn">Start</button>
        </div>
        <div class="etyEngine__muted" id="loadError" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Quiz -->
    <section class="etyEngine__card" id="quizCard" style="display:none">
      <div class="etyEngine__pad">
        <div class="etyEngine__row" style="margin-bottom:10px">
          <div class="etyEngine__pill">Q <span id="qi">0</span>/<span id="qt">0</span></div>
          <div class="etyEngine__pill">Score <span id="score">0</span></div>
          <div style="flex:1;min-width:40%;margin-left:8px">
            <div class="etyEngine__bar"><div id="pbar"></div></div>
          </div>
        </div>

        <div class="etyEngine__q" id="prompt"></div>
        <div class="etyEngine__opts" id="opts" role="group" aria-label="options"></div>

        <div class="etyEngine__row" style="margin-top:14px">
          <div class="etyEngine__muted" id="feedback"></div>
          <div style="display:flex; gap:10px">
            <button id="nextBtn" class="etyEngine__btn" disabled>Next</button>
            <button id="finishNowBtn" class="etyEngine__btn etyEngine__btn--ghost">Finish</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="etyEngine__card" id="resultCard" style="display:none">
      <div class="etyEngine__pad">
        <div class="etyEngine__h2">Results</div>
        <div class="etyEngine__row" style="margin-top:10px">
          <div class="etyEngine__pill">Score: <strong id="finalScore">0</strong></div>
          <div class="etyEngine__pill">Questions: <strong id="finalTotal">0</strong></div>
          <div class="etyEngine__pill">Accuracy: <strong id="finalPct">0%</strong></div>
        </div>

        <details open class="etyEngine__details" style="margin-top:14px">
          <summary class="etyEngine__muted">Review</summary>
          <ol id="review" class="etyEngine__review"></ol>
        </details>

        <div class="etyEngine__row" style="margin-top:14px">
          <button class="etyEngine__btn" id="retryBtn">Try again</button>
          <button class="etyEngine__btn etyEngine__btn--ghost" id="exitBtn">Exit</button>
        </div>
      </div>
    </section>
  </div>
</section>

<style>
  /* Scoped black/white theme */
  .etyEngine{ color:#111; background:transparent; font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .etyEngine__header{ border-bottom:1px solid #111; background:#fff; }
  .etyEngine__wrap{ max-width:1100px; margin:0 auto; padding:18px; display:grid; gap:16px; }
  .etyEngine__brand{ display:flex; align-items:center; gap:12px; padding:12px 18px; max-width:1100px; margin:0 auto; }
  .etyEngine__avatar{ width:36px; height:36px; object-fit:contain; display:block; }
  .etyEngine__h1{ font-weight:800; letter-spacing:.2px; }
  .etyEngine__sub{ color:#555; font-size:13px; margin-top:2px; }
  .etyEngine__h2{ font-weight:800; font-size:18px; }

  .etyEngine__card{ border:1px solid #111; background:#fff; }
  .etyEngine__pad{ padding:16px; }
  .etyEngine__row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .etyEngine__label{ font-size:12px; color:#555; margin-bottom:6px; }
  .etyEngine__muted{ color:#555; font-size:13px; }

  .etyEngine__pill{ border:1px solid #111; background:#fff; padding:6px 10px; font-weight:700; font-size:13px; }
  .etyEngine__input{ width:100%; border:1px solid #111; padding:10px 12px; font-size:15px; background:#fff; color:#111; }
  .etyEngine__btn{ border:1px solid #111; background:#111; color:#fff; padding:10px 14px; font-weight:800; cursor:pointer; }
  .etyEngine__btn:disabled{ opacity:.45; cursor:not-allowed; }
  .etyEngine__btn--ghost{ background:#fff; color:#111; }

  .etyEngine__bar{ height:10px; border:1px solid #111; background:#fff; }
  .etyEngine__bar > div{ height:100%; width:0%; background:#111; }

  .etyEngine__q{ font-size:20px; font-weight:800; margin:8px 0 12px; }
  .etyEngine__opts{ display:grid; gap:10px; }
  .etyEngine__opt{
    display:flex; gap:10px; align-items:flex-start;
    border:1px solid #111; background:#fff; color:#111;
    padding:12px 12px; cursor:pointer; text-align:left;
  }
  .etyEngine__kbd{
    min-width:28px;
    border:1px solid #111; padding:2px 6px; font-weight:800; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  }
  /* “Correct/Wrong” without color: border + glyph */
  .etyEngine__opt.correct{ outline:2px solid #111; }
  .etyEngine__opt.correct::after{ content:"✓"; margin-left:auto; font-weight:900; }
  .etyEngine__opt.wrong{ border-style:dashed; }
  .etyEngine__opt.wrong::after{ content:"✕"; margin-left:auto; font-weight:900; }

  .etyEngine__details{ border:1px solid #111; padding:10px; }
  .etyEngine__review{ margin-top:10px; display:grid; gap:6px; padding-left:18px; }

  .etyEngine__dir{
    display:grid;
    grid-template-columns: 1.2fr 1fr;
    gap:12px;
    margin-top:12px;
  }
  .etyEngine__dirList{
    margin:0; padding-left:18px; max-height:320px; overflow:auto;
    border:1px solid #111; padding:10px 14px;
  }
  .etyEngine__dirList li{ margin:0; padding:4px 0; cursor:pointer; }
  .etyEngine__dirList li:hover{ text-decoration:underline; }
  .etyEngine__def{ border:1px solid #111; padding:10px 12px; }
  .etyEngine__selected{ font-weight:800; margin-top:4px; }
  .etyEngine__meaning{ margin-top:8px; }
  @media (max-width: 900px){
    .etyEngine__dir{ grid-template-columns: 1fr; }
  }
</style>

<script type="module">
  const CHOICES = 4;
  const BANK_URL = "data/bank.txt"; // <-- set this to your real text file path

  const $ = (id) => document.getElementById(id);
  const show = (el, on) => el.style.display = on ? "" : "none";

  function randomInt(max){
    if (max <= 0) return 0;
    const c = window.crypto;
    if (c?.getRandomValues){
      const buf = new Uint32Array(1);
      const range = 0xFFFFFFFF;
      const limit = range - (range % max);
      let x = 0;
      do { c.getRandomValues(buf); x = buf[0]; } while (x >= limit);
      return x % max;
    }
    return Math.floor(Math.random() * max);
  }

  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = randomInt(i + 1);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function dedupe(pairs){
    const seen = new Map();
    for (const p of (pairs || [])){
      const term = (p?.term || "").trim();
      const meaning = (p?.meaning || "").trim();
      if (!term || !meaning) continue;
      // keep the longer meaning if duplicates
      if (!seen.has(term) || (seen.get(term).length < meaning.length)) seen.set(term, meaning);
    }
    return Array.from(seen, ([term, meaning]) => ({ term, meaning }));
  }

  function inferKind(term){
    const t = (term || "").trim();
    // Heuristic: word-part markers
    if (/^-|-$/.test(t)) return "ETY";
    if (/[a-z]-$/.test(t)) return "ETY";
    if (/^-[a-z]/i.test(t)) return "ETY";
    if (t.includes("-")) return "ETY";        // e.g., bio-, -itis, a-, an-
    if (t.includes("/")) return "ETY";        // e.g., hemato-/hemo-
    return "VOCAB";
  }

  function parseTextBank(raw){
    const out = [];
    const lines = raw.replace(/\r\n/g, "\n").split("\n");

    for (const line0 of lines){
      const line = line0.trim();
      if (!line || line.startsWith("#")) continue;

      // TSV: [KIND] \t term \t meaning  OR  term \t meaning
      if (line.includes("\t")){
        const parts = line.split("\t").map(s => s.trim()).filter(Boolean);
        if (parts.length >= 2){
          let kind = null, term = "", meaning = "";
          const tag = (parts[0] || "").toUpperCase();
          if (tag === "ETY" || tag === "VOCAB"){
            kind = tag;
            term = parts[1] || "";
            meaning = parts.slice(2).join(" ").trim();
          } else {
            term = parts[0] || "";
            meaning = parts.slice(1).join(" ").trim();
          }
          if (term && meaning) out.push({ kind: kind || inferKind(term), term, meaning });
          continue;
        }
      }

      // Em dash / colon delimiter with surrounding spaces (avoids splitting inside “a-, an-”)
      const m = line.match(/^(?:\[(ETY|VOCAB)\]\s*)?(.+?)\s+(?:—|–|:)\s+(.+)$/);
      if (m){
        const kind = (m[1] || "").toUpperCase() || inferKind(m[2]);
        out.push({ kind, term: m[2].trim(), meaning: m[3].trim() });
        continue;
      }

      // Hyphen delimiter only if surrounded by spaces: "Term - Meaning"
      const m2 = line.match(/^(?:\[(ETY|VOCAB)\]\s*)?(.+?)\s+-\s+(.+)$/);
      if (m2){
        const kind = (m2[1] || "").toUpperCase() || inferKind(m2[2]);
        out.push({ kind, term: m2[2].trim(), meaning: m2[3].trim() });
        continue;
      }
    }

    return dedupe(out);
  }

  async function loadBank(){
    const res = await fetch(BANK_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`Bank fetch failed (${res.status}) for ${BANK_URL}`);
    const raw = await res.text();
    return parseTextBank(raw);
  }

  // State
  let combined = [];
  let poolEty = [];
  let poolVocab = [];

  let plan = [];
  let qIndex = 0, score = 0, answered = false, history = [];

  function buildDirectory(items){
    const list = $("dirList");
    const selected = $("dirSelected");
    const meaning = $("dirMeaning");
    list.innerHTML = "";

    const render = (arr) => {
      list.innerHTML = "";
      for (const it of arr){
        const li = document.createElement("li");
        li.textContent = it.term;
        li.title = it.kind;
        li.addEventListener("click", () => {
          selected.textContent = `${it.term} (${it.kind})`;
          meaning.textContent = it.meaning;
        });
        list.appendChild(li);
      }
    };

    render(items);

    $("dirSearch").addEventListener("input", (e) => {
      const q = (e.target.value || "").trim().toLowerCase();
      if (!q) return render(items);
      render(items.filter(x => x.term.toLowerCase().includes(q) || x.meaning.toLowerCase().includes(q)));
    });
  }

  function setPrompt(kind, term){
    const p = $("prompt");
    const prefix = (kind === "ETY")
      ? "What is the meaning of "
      : "Which definition best matches ";
    p.textContent = prefix + term + "?";
  }

  function buildChoices(correct, pool){
    const picks = [correct];
    let tries = 0;
    while (picks.length < CHOICES && tries < 2000){
      const c = pool[randomInt(pool.length)];
      if (c && !picks.includes(c)) picks.push(c);
      tries++;
    }
    while (picks.length < CHOICES) picks.push("—");
    return shuffle(picks);
  }

  function renderChoices(choices, correct, record){
    const box = $("opts");
    box.innerHTML = "";
    choices.forEach((choice, i) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "etyEngine__opt";
      btn.dataset.correct = (choice === correct) ? "1" : "0";

      const k = document.createElement("span");
      k.className = "etyEngine__kbd";
      k.textContent = String(i + 1);

      const t = document.createElement("span");
      t.textContent = choice;

      btn.appendChild(k);
      btn.appendChild(t);

      btn.addEventListener("click", () => grade(btn, correct, { ...record, picked: choice, ok: choice === correct }));
      box.appendChild(btn);
    });
  }

  function resetSession(total){
    qIndex = 0; score = 0; answered = false; history = [];
    $("qi").textContent = "0";
    $("qt").textContent = String(total);
    $("score").textContent = "0";
    $("pbar").style.width = "0%";
    $("feedback").textContent = "";
    $("nextBtn").disabled = true;
  }

  function nextQuestion(){
    if (qIndex >= plan.length) return finish();
    answered = false;
    $("nextBtn").disabled = true;
    $("feedback").textContent = "";

    const item = combined[plan[qIndex]];
    if (!item){ qIndex++; return nextQuestion(); }

    $("qi").textContent = String(qIndex + 1);
    setPrompt(item.kind, item.term);

    const correct = item.meaning;
    const record = { kind: item.kind, term: item.term, correct, picked: "", ok: false };

    const pool = (item.kind === "ETY") ? poolEty : poolVocab;
    const choices = buildChoices(correct, pool.length ? pool : combined.map(x => x.meaning));
    renderChoices(choices, correct, record);
  }

  function grade(btn, correct, record){
    if (answered) return;
    answered = true;

    const all = Array.from(document.querySelectorAll("#etyEngine .etyEngine__opt"));
    all.forEach(el => el.disabled = true);

    if (btn.dataset.correct === "1"){
      btn.classList.add("correct");
      score++;
      $("feedback").textContent = "Correct";
    } else {
      btn.classList.add("wrong");
      $("feedback").textContent = "Correct: " + correct;
      const target = all.find(el => el.dataset.correct === "1");
      if (target) target.classList.add("correct");
    }

    $("score").textContent = String(score);
    history.push(record);
    qIndex++;
    $("pbar").style.width = Math.round((qIndex / plan.length) * 100) + "%";
    $("nextBtn").disabled = false;
  }

  function finish(){
    show($("quizCard"), false);
    show($("resultCard"), true);

    $("finalScore").textContent = String(score);
    $("finalTotal").textContent = String(plan.length);
    $("finalPct").textContent = plan.length ? (Math.round((score / plan.length) * 100) + "%") : "0%";

    const ol = $("review");
    ol.innerHTML = "";
    for (const h of history){
      const li = document.createElement("li");
      li.textContent = `${h.kind} · ${h.term} → ${h.correct}` + (h.ok ? "" : ` · you chose: ${h.picked}`);
      ol.appendChild(li);
    }

    $("retryBtn").onclick = () => {
      show($("resultCard"), false);
      show($("loaderCard"), true);
    };
  }

  function start(){
    if (!combined.length){
      $("loadError").textContent = "Banks failed to load.";
      return;
    }
    const requested = Math.min(Math.max(parseInt($("qCount").value || 40, 10), 1), combined.length);
    const indices = Array.from({ length: combined.length }, (_, i) => i);
    shuffle(indices);
    plan = indices.slice(0, requested);

    resetSession(plan.length);

    show($("loaderCard"), false);
    show($("resultCard"), false);
    show($("quizCard"), true);

    nextQuestion();
  }

  // Init
  (async function init(){
    try{
      const bank = await loadBank();
      combined = bank.map(x => ({ kind: x.kind || inferKind(x.term), term: x.term, meaning: x.meaning }));

      poolEty = combined.filter(x => x.kind === "ETY").map(x => x.meaning);
      poolVocab = combined.filter(x => x.kind === "VOCAB").map(x => x.meaning);

      $("loadedSummary").textContent = `Loaded ${combined.length} items (${poolEty.length} ETY, ${poolVocab.length} VOCAB)`;
      $("maxHint").textContent = "Max questions this run: " + combined.length;
      $("qCount").max = String(combined.length);

      buildDirectory(combined);

      $("startBtn").addEventListener("click", start);
      $("nextBtn").addEventListener("click", nextQuestion);
      $("finishNowBtn").addEventListener("click", finish);
      $("exitBtn").addEventListener("click", () => {
        show($("resultCard"), false);
        show($("quizCard"), false);
        show($("loaderCard"), true);
        // optional: scroll back to top of the component
        document.getElementById("etyEngine")?.scrollIntoView({ behavior: "smooth", block: "start" });
      });

      window.addEventListener("keydown", (e) => {
        if ($("quizCard").style.display === "none") return;
        if (/^[1-4]$/.test(e.key)){
          const i = Number(e.key) - 1;
          document.querySelectorAll("#etyEngine .etyEngine__opt")[i]?.click();
        } else if (e.key === "Enter"){
          if (!$("nextBtn").disabled) $("nextBtn").click();
        }
      });

    } catch (err){
      $("loadedSummary").textContent = "Load failed";
      $("loadError").textContent =
        String(err?.message || err) +
        " — If you opened the page by double-clicking (file://), run a local server instead.";
      console.error(err);
    }
  })();
</script>
