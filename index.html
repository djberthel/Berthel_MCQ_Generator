<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Berthel’s Biology</title>

  <!-- Latin Modern Roman -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/latin-modern-roman@5.0.20/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/latin-modern-roman@5.0.20/700.css">

  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#05060a;
      --panel:#0a0d13;
      --panel2:#0d111a;
      --ink:#f3f5f7;
      --muted:#aab3c2;
      --faint:#6f7786;
      --line:#1a2230;
      --line2:#232c3c;

      --ok:#2fe06f;
      --bad:#ff4b4b;
      --warn:#ffd36a;

      --btn:#f4f6f8;
      --btnInk:#0a0c10;

      --radius:18px;
      --radius2:14px;

      --shadow:0 12px 42px rgba(0,0,0,.45);
      --shadow2:0 10px 28px rgba(0,0,0,.35);

      --base:20px;
      --lh:1.35;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, #0b0f17 0%, var(--bg) 60%) fixed;
      color:var(--ink);
      font-family:"Latin Modern Roman","Times New Roman",serif;
      font-size:var(--base);
      line-height:var(--lh);
    }

    .wrap{max-width:1080px;margin:0 auto;padding:24px 18px 44px}

    /* Visible by default; JS hides it. If you see it, scripts are blocked/not running. */
    .jsBanner{
      border:1px solid rgba(255,211,106,.35);
      background:rgba(255,211,106,.08);
      color:#fff3c9;
      padding:12px 14px;
      border-radius:14px;
      margin:0 0 14px;
      box-shadow:var(--shadow2);
    }
    body[data-js="on"] .jsBanner{display:none}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:18px 18px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:14px;min-width:0}
    .avatar{
      width:54px;height:54px;border-radius:16px;
      border:1px solid var(--line2);
      background:#0b0e13;
      object-fit:cover;
      flex:0 0 auto;
      box-shadow:var(--shadow2);
    }
    .titleblock{min-width:0}
    .title{
      font-size:30px;font-weight:700;letter-spacing:.2px;
      margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .subtitle{
      margin:2px 0 0;
      color:var(--muted);
      font-size:18px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .versionPill{
      border:1px solid var(--line2);
      background:rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:999px;
      font-size:16px;
      color:var(--muted);
      white-space:nowrap;
      box-shadow:var(--shadow2);
    }

    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      margin:14px 0 0;
    }
    .tabBtn{
      appearance:none;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--ink);
      padding:12px 14px;
      border-radius:14px;
      font-size:18px;
      cursor:pointer;
      box-shadow:var(--shadow2);
      user-select:none;
    }
    .tabBtn[aria-selected="true"]{
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.16);
    }

    .panel{
      margin-top:16px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .panelHeader h2{margin:0;font-size:20px;font-weight:700;color:var(--muted)}
    .panelBody{padding:18px}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    label{display:block;color:var(--muted);font-size:16px;margin-bottom:6px}
    input[type="text"], input[type="number"], textarea{
      width:100%;
      background:rgba(0,0,0,.35);
      color:var(--ink);
      border:1px solid var(--line2);
      border-radius:14px;
      padding:14px 14px;
      font-size:20px;
      outline:none;
    }
    textarea{min-height:140px;resize:vertical}
    input[type="number"]{max-width:240px}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      padding:12px 14px;
      border-radius:14px;
      font-size:18px;
      cursor:pointer;
      box-shadow:var(--shadow2);
      user-select:none;
    }
    .btnPrimary{
      background:var(--btn);
      color:var(--btnInk);
      border-color:transparent;
      font-weight:700;
    }
    .btnDanger{
      background:rgba(255,75,75,.14);
      border-color:rgba(255,75,75,.35);
      color:#ffd0d0;
      font-weight:700;
    }
    .btnGhost{
      background:transparent;
      border-color:var(--line2);
      color:var(--muted);
    }
    .hint{color:var(--faint);font-size:16px;margin:8px 0 0}
    .statusLine{
      margin-top:10px;
      padding:10px 12px;
      border:1px solid var(--line2);
      border-radius:14px;
      background:rgba(0,0,0,.22);
      color:var(--muted);
      font-size:16px;
    }

    .pillRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{
      border:1px solid var(--line2);
      background:rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:999px;
      font-size:16px;
      color:var(--muted);
    }

    .split{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width:900px){
      .split{grid-template-columns:1fr}
    }

    /* Quiz */
    .quizTop{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:12px;
    }
    .qMeta{
      color:var(--muted);
      font-size:16px;
    }
    .qStem{
      font-size:30px;
      font-weight:700;
      margin:4px 0 0;
      line-height:1.15;
    }
    .qPrompt{
      color:var(--muted);
      margin:10px 0 0;
      font-size:18px;
    }
    .optList{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .opt{
      display:flex;gap:12px;align-items:flex-start;
      border:1px solid var(--line2);
      border-radius:16px;
      background:rgba(0,0,0,.20);
      padding:14px 14px;
      cursor:pointer;
    }
    .opt:hover{background:rgba(255,255,255,.03)}
    .opt input{margin-top:6px;transform:scale(1.15);cursor:pointer}
    .optLabel{
      display:flex;gap:10px;align-items:flex-start;
      cursor:pointer;
      width:100%;
    }
    .optLetter{
      font-weight:800;
      width:28px;flex:0 0 auto;
    }
    .optText{
      color:var(--ink);
      font-size:19px;
      line-height:1.35;
      margin-top:-1px;
    }

    .quizNav{
      margin-top:16px;
      display:flex;gap:10px;flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    .quizNavLeft,.quizNavRight{display:flex;gap:10px;flex-wrap:wrap}
    .centerActions{display:flex;gap:10px;flex-wrap:wrap}

    /* Summary */
    .scoreBox{
      border:1px solid var(--line2);
      border-radius:18px;
      padding:14px 14px;
      background:rgba(0,0,0,.22);
      margin-bottom:14px;
    }
    .scoreBig{
      font-size:34px;
      font-weight:800;
      margin:0;
    }
    .scoreSub{
      margin:4px 0 0;
      color:var(--muted);
      font-size:18px;
    }
    .tagOK{color:var(--ok);font-weight:800}
    .tagBAD{color:var(--bad);font-weight:800}
    .tagWARN{color:var(--warn);font-weight:800}

    .reviewList{
      margin-top:14px;
      display:flex;flex-direction:column;gap:10px;
    }
    .reviewItem{
      border:1px solid var(--line2);
      border-radius:16px;
      background:rgba(0,0,0,.18);
      padding:12px 12px;
    }
    .reviewHead{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:8px;
      color:var(--muted);
      font-size:16px;
    }
    .reviewStem{font-size:20px;font-weight:800;margin:0 0 6px}
    .reviewLine{margin:4px 0;color:var(--ink);font-size:18px}
    .mono{font-variant-numeric:tabular-nums}

    /* Modal */
    .modalBackdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(560px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;gap:12px;
    }
    .modalHead strong{color:var(--muted)}
    .modalBody{padding:16px}
    .xBtn{cursor:pointer;border:1px solid var(--line2);background:transparent;color:var(--muted);border-radius:12px;padding:8px 10px;font-size:16px}
    .show{display:flex !important}

    /* Hidden sections */
    .hidden{display:none !important}

    /* Noscript */
    noscript{
      display:block;
      border:1px solid rgba(255,75,75,.35);
      background:rgba(255,75,75,.10);
      padding:12px 14px;
      border-radius:14px;
      margin-bottom:14px;
      color:#ffd0d0;
      box-shadow:var(--shadow2);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <noscript>
      JavaScript is disabled. This site requires JavaScript to run quizzes and load the spreadsheet.
    </noscript>

    <div class="jsBanner">
      JavaScript did not run. If you’re seeing this, your page is being opened in a script-blocking previewer (or JS is disabled).
      Open the HTML as a normal page (not an embedded preview), or serve it from a local server/host.
    </div>

    <header class="topbar">
      <div class="brand">
        <img class="avatar" id="avatarImg" src="Chinstrap_LOgo.jfif" alt="Berthel's Biology avatar">
        <div class="titleblock">
          <h1 class="title">Berthel’s Biology</h1>
          <div class="subtitle">Professional student testing and review workspace.</div>
        </div>
      </div>
      <div class="versionPill mono" id="versionPill">—</div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Primary">
      <button type="button" class="tabBtn" id="tabHome" aria-selected="true">Home</button>
      <button type="button" class="tabBtn" id="tabEV" aria-selected="false">Etymology &amp; Vocabulary</button>
      <button type="button" class="tabBtn" id="tabCustom" aria-selected="false">Custom Content</button>
    </nav>

    <!-- HOME -->
    <section class="panel" id="viewHome">
      <div class="panelHeader">
        <h2>Update notes</h2>
        <button type="button" class="btn btnGhost" id="adminBtn">Admin</button>
      </div>
      <div class="panelBody">
        <div class="hint">Updates are timestamped (Beijing time).</div>
        <div id="updatesList" class="reviewList" style="margin-top:12px;"></div>
        <div class="hint" style="margin-top:12px;">
          Note: static sites can’t write to the server. Use Admin → Export, then upload <span class="mono">updates.json</span> to broadcast changes to all users.
        </div>
      </div>
    </section>

    <!-- ETY / VOCAB -->
    <section class="panel hidden" id="viewEV">
      <div class="panelHeader">
        <h2>Etymology &amp; Vocabulary</h2>
        <button type="button" class="btn btnGhost" id="evReloadBtn">Reload</button>
      </div>

      <div class="panelBody">
        <div class="split">
          <div>
            <label for="evCount">Number of questions (1–100)</label>
            <div class="row">
              <input id="evCount" type="number" min="1" max="100" step="1" placeholder="e.g., 25" />
              <button type="button" class="btn btnPrimary" id="evStartBtn">Start</button>
              <button type="button" class="btn btnGhost" id="evChangeBtn">Change number</button>
            </div>

            <div class="pillRow">
              <span class="pill">Mode:
                <select id="evMode" style="margin-left:8px;background:transparent;color:var(--ink);border:1px solid var(--line2);border-radius:12px;padding:8px 10px;font-size:16px;">
                  <option value="mixed" selected>Mixed</option>
                  <option value="vocab">Vocabulary only</option>
                  <option value="ety">Etymology only</option>
                </select>
              </span>
              <span class="pill" id="evDataStatus">Loading dataset…</span>
            </div>

            <div class="hint" style="margin-top:10px;">
              Auto-loads <span class="mono">Vocab_Ety_Master_List.xlsx</span> from the same folder.
              If it doesn’t load, you are likely opening via <span class="mono">file://</span>. Serve the folder or host it.
            </div>

          </div>

          <div>
            <div class="statusLine" id="evTechStatus">Waiting for dataset…</div>
            <div class="hint" style="margin-top:10px;">
              Finish early any time — your summary will still be generated (attempted + unattempted).
            </div>
          </div>
        </div>

        <div id="evQuizArea" class="hidden" style="margin-top:18px;"></div>
        <div id="evSummaryArea" class="hidden" style="margin-top:18px;"></div>
      </div>
    </section>

    <!-- CUSTOM CONTENT -->
    <section class="panel hidden" id="viewCustom">
      <div class="panelHeader">
        <h2>Custom Content</h2>
        <button type="button" class="btn btnGhost" id="customResetBtn">Reset</button>
      </div>
      <div class="panelBody">

        <div class="split">
          <div>
            <label for="customFile">Upload text content</label>
            <input id="customFile" type="file" accept=".txt,.md,.text" />

            <div class="hint">Optional: paste content below instead (upload or paste, not both).</div>

            <label for="customText" style="margin-top:12px;">Paste content</label>
            <textarea id="customText" placeholder="Paste content here…"></textarea>

            <label for="customN" style="margin-top:12px;">Number of questions (1–100)</label>
            <div class="row">
              <input id="customN" type="number" min="1" max="100" step="1" placeholder="e.g., 20" />
              <button type="button" class="btn btnPrimary" id="customMakePromptBtn">Make prompt</button>
            </div>

            <div class="hint" style="margin-top:10px;">
              This tab is designed to work with your separate GPT (“MCQ JSON Machine”).
              Generate JSON there, then paste it below.
            </div>
          </div>

          <div>
            <div class="statusLine" id="customStatus">Awaiting content.</div>

            <label for="customPrompt" style="margin-top:12px;">Prompt to copy into MCQ JSON Machine</label>
            <textarea id="customPrompt" readonly placeholder="Click “Make prompt”…"></textarea>
            <div class="row" style="margin-top:10px;">
              <button type="button" class="btn btnGhost" id="copyPromptBtn">Copy prompt</button>
            </div>

            <label for="customJson" style="margin-top:12px;">Paste JSON returned by MCQ JSON Machine</label>
            <textarea id="customJson" placeholder='Expected shape: {"title":"...","questions":[{"stem":"...","options":{"A":"...","B":"...","C":"...","D":"..."},"answer":"A","rationale":"..."}]}'></textarea>

            <div class="row" style="margin-top:10px;">
              <button type="button" class="btn btnPrimary" id="customLoadQuizBtn">Load quiz</button>
            </div>
          </div>
        </div>

        <div id="customQuizArea" class="hidden" style="margin-top:18px;"></div>
        <div id="customSummaryArea" class="hidden" style="margin-top:18px;"></div>
      </div>
    </section>
  </div>

  <!-- ADMIN MODAL -->
  <div class="modalBackdrop" id="adminModal">
    <div class="modal">
      <div class="modalHead">
        <strong>Admin</strong>
        <button type="button" class="xBtn" id="adminCloseBtn">Close</button>
      </div>
      <div class="modalBody">
        <div id="adminLocked">
          <label for="adminPass">Password</label>
          <div class="row">
            <input id="adminPass" type="text" placeholder="Enter password" />
            <button type="button" class="btn btnPrimary" id="adminUnlockBtn">Unlock</button>
          </div>
          <div class="hint" id="adminPassHint" style="margin-top:10px;"></div>
        </div>

        <div id="adminEditor" class="hidden">
          <label for="updateText">Post an update (will be timestamped in Beijing time)</label>
          <textarea id="updateText" placeholder="Write the update note…"></textarea>

          <div class="row" style="margin-top:10px;">
            <button type="button" class="btn btnPrimary" id="postUpdateBtn">Post update</button>
            <button type="button" class="btn btnGhost" id="exportUpdatesBtn">Export updates.json</button>
            <button type="button" class="btn btnDanger" id="clearLocalUpdatesBtn">Clear local</button>
          </div>

          <div class="hint" style="margin-top:10px;">
            Export downloads <span class="mono">updates.json</span>. Upload/replace it on your host to broadcast updates to all users.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   Configuration
=========================== */
const SPREADSHEET_FILE = "Vocab_Ety_Master_List.xlsx";
const UPDATES_FILE = "updates.json";
const ADMIN_PASSWORD = "temetnosce"; // as requested

/* Avatar fallback (only used if Chinstrap_LOgo.jfif fails) */
const AVATAR_FALLBACK_DATA_URL = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQE%0ABQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRQBAwME%0ADgQHBgkIBwkUDQsMFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU%0AFBQUFBQUFBQUFBQUFBQUFP/AABEIAQ0A+gMBIgACEQEDEQH/xAAbAAEAAgMBAQAA%0AAAAAAAAAAAAGBQcBAgMEB//EADoQAAIBAgQDBQYEBwAAAAAAAAECAwQRAAUSITFB%0ABhMiUWEHMoGRoRQjQlNiscHR8BVCYv/EABcBAQEBAQAAAAAAAAAAAAAAAAABAgP/%0AxAAhEQEBAQEAAgIDAQAAAAAAAAABEQIhAxIxQVEiMmFxkf/aAAwDAQACEQMRAD8A%0A9u0pV5I9kqm5wK8GJxHkqQ8E1Y3p6y+6o8JqF0cKk0YwW2zZbG3mI8fQnR3iYh8o%0Alq4k3h7p8N8bT5p3c5c3m0n9oBv6m4+S1x7m2q0fH2l9t2g2Lw2qgQpJH2c0j5cI%0A3VJf0yQ8b4nXKXqE7H6z1y2t3l1m7QbZ7bqB7VQ4xQH4u3m5w7Y1zv5bOq8f7g5%0Ap+4s0m3b0G2v2aYb5qUoUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpU%0AqVKlSpUqVKlSpUqVKlf/2Q==";

/* ===========================
   State
=========================== */
const STATE = {
  data: { vocab: [], ety: [] },
  evQuiz: null,
  customQuiz: null,
  updates: [],
  updatesSource: "local"
};

/* ===========================
   Utilities
=========================== */
function beijingNow(){
  // Asia/Shanghai is Beijing time (UTC+8), no DST.
  const d = new Date();
  const fmt = new Intl.DateTimeFormat("sv-SE", {
    timeZone:"Asia/Shanghai",
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit",
    hour12:false
  });
  // sv-SE gives "YYYY-MM-DD HH:mm:ss"
  return fmt.format(d).replace(" ", " ");
}

function clampInt(n, min, max){
  const x = Number(n);
  if(!Number.isFinite(x)) return null;
  const i = Math.trunc(x);
  if(String(i) !== String(x) && !Number.isInteger(x)) return null;
  if(i < min || i > max) return null;
  return i;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function stripExamples(text){
  let t = String(text || "").trim();
  // Remove explicit "Examples:" and anything after it.
  t = t.replace(/\bExamples?:\s*.*$/i, "").trim();
  // Remove inline e.g. trails (lightly)
  t = t.replace(/\s*\(e\.g\..*?\)\s*$/i, "").trim();
  return t;
}

function tokenize(s){
  return String(s || "")
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g," ")
    .split(/\s+/)
    .filter(Boolean)
    .filter(w => !STOPWORDS.has(w));
}

const STOPWORDS = new Set([
  "the","a","an","and","or","to","of","in","on","for","with","by","from","into","at",
  "is","are","was","were","be","being","been","as","that","this","these","those",
  "it","its","their","there","within","between","over","under","including","includes",
  "when","while","during","through","via","can","may","might","often","usually","most",
  "used","use","using","make","makes","made"
]);

function jaccard(aTokens, bTokens){
  const A = new Set(aTokens), B = new Set(bTokens);
  if(A.size === 0 || B.size === 0) return 0;
  let inter = 0;
  for(const x of A) if(B.has(x)) inter++;
  const union = A.size + B.size - inter;
  return union ? inter/union : 0;
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===========================
   Tabs
=========================== */
const viewHome = document.getElementById("viewHome");
const viewEV = document.getElementById("viewEV");
const viewCustom = document.getElementById("viewCustom");

const tabHome = document.getElementById("tabHome");
const tabEV = document.getElementById("tabEV");
const tabCustom = document.getElementById("tabCustom");

function setTab(which){
  const all = [
    {btn:tabHome, view:viewHome, key:"home"},
    {btn:tabEV, view:viewEV, key:"ev"},
    {btn:tabCustom, view:viewCustom, key:"custom"}
  ];
  for(const t of all){
    const active = (t.key === which);
    t.btn.setAttribute("aria-selected", active ? "true" : "false");
    t.view.classList.toggle("hidden", !active);
  }
}

tabHome.addEventListener("click", ()=>setTab("home"));
tabEV.addEventListener("click", ()=>setTab("ev"));
tabCustom.addEventListener("click", ()=>setTab("custom"));

/* ===========================
   Startup signals
=========================== */
document.body.dataset.js = "on";
document.getElementById("versionPill").textContent = beijingNow();

/* Avatar fallback */
const avatarImg = document.getElementById("avatarImg");
avatarImg.addEventListener("error", () => { avatarImg.src = AVATAR_FALLBACK_DATA_URL; });

/* ===========================
   Updates (Home)
=========================== */
const updatesList = document.getElementById("updatesList");

function renderUpdates(){
  updatesList.innerHTML = "";
  if(!STATE.updates.length){
    updatesList.innerHTML = `
      <div class="reviewItem">
        <div class="reviewHead"><span class="mono">—</span><span class="tagWARN">No updates yet</span></div>
        <div class="reviewLine">Admin can post the first update.</div>
      </div>`;
    return;
  }
  for(const u of STATE.updates){
    const item = document.createElement("div");
    item.className = "reviewItem";
    item.innerHTML = `
      <div class="reviewHead">
        <span class="mono">${escapeHtml(u.ts || "—")}</span>
        <span class="mono">${STATE.updatesSource === "server" ? "server" : "local"}</span>
      </div>
      <div class="reviewLine">${escapeHtml(u.text || "")}</div>
    `;
    updatesList.appendChild(item);
  }
}

function loadLocalUpdates(){
  try{
    const raw = localStorage.getItem("bb_updates_v1");
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}

function saveLocalUpdates(){
  localStorage.setItem("bb_updates_v1", JSON.stringify(STATE.updates));
}

async function tryLoadServerUpdates(){
  try{
    const res = await fetch(UPDATES_FILE, {cache:"no-store"});
    if(!res.ok) return false;
    const data = await res.json();
    if(Array.isArray(data)){
      STATE.updates = data;
      STATE.updatesSource = "server";
      return true;
    }
    return false;
  }catch{
    return false;
  }
}

async function initUpdates(){
  const serverOk = await tryLoadServerUpdates();
  if(!serverOk){
    STATE.updates = loadLocalUpdates();
    STATE.updatesSource = "local";
  }
  renderUpdates();
}

/* Admin modal */
const adminModal = document.getElementById("adminModal");
const adminBtn = document.getElementById("adminBtn");
const adminCloseBtn = document.getElementById("adminCloseBtn");
const adminUnlockBtn = document.getElementById("adminUnlockBtn");
const adminPass = document.getElementById("adminPass");
const adminLocked = document.getElementById("adminLocked");
const adminEditor = document.getElementById("adminEditor");
const adminPassHint = document.getElementById("adminPassHint");
const updateText = document.getElementById("updateText");
const postUpdateBtn = document.getElementById("postUpdateBtn");
const exportUpdatesBtn = document.getElementById("exportUpdatesBtn");
const clearLocalUpdatesBtn = document.getElementById("clearLocalUpdatesBtn");

function openAdmin(){
  adminModal.classList.add("show");
  adminLocked.classList.remove("hidden");
  adminEditor.classList.add("hidden");
  adminPass.value = "";
  adminPassHint.textContent = "";
}
function closeAdmin(){
  adminModal.classList.remove("show");
}

adminBtn.addEventListener("click", openAdmin);
adminCloseBtn.addEventListener("click", closeAdmin);
adminModal.addEventListener("click", (e)=>{ if(e.target === adminModal) closeAdmin(); });

adminUnlockBtn.addEventListener("click", ()=>{
  const p = (adminPass.value || "").trim();
  if(p === ADMIN_PASSWORD){
    adminLocked.classList.add("hidden");
    adminEditor.classList.remove("hidden");
    adminPassHint.textContent = "";
  }else{
    adminPassHint.textContent = "Incorrect password.";
  }
});

postUpdateBtn.addEventListener("click", ()=>{
  const txt = (updateText.value || "").trim();
  if(!txt) return;
  const entry = { ts: beijingNow(), text: txt };
  STATE.updates.unshift(entry);
  STATE.updatesSource = "local";
  saveLocalUpdates();
  renderUpdates();
  updateText.value = "";
});

exportUpdatesBtn.addEventListener("click", ()=>{
  downloadJson("updates.json", STATE.updates);
});

clearLocalUpdatesBtn.addEventListener("click", ()=>{
  localStorage.removeItem("bb_updates_v1");
  STATE.updates = [];
  STATE.updatesSource = "local";
  renderUpdates();
});

/* ===========================
   XLSX loading + parsing
=========================== */
const evDataStatus = document.getElementById("evDataStatus");
const evTechStatus = document.getElementById("evTechStatus");
const evReloadBtn = document.getElementById("evReloadBtn");

function setDataStatus(msg){
  evDataStatus.textContent = msg;
}
function setTechStatus(msg){
  evTechStatus.textContent = msg;
}

function normKey(k){ return String(k||"").toLowerCase().replace(/\s+/g," ").trim(); }

function findKey(keys, patterns){
  const lk = keys.map(normKey);
  for(const pat of patterns){
    const idx = lk.findIndex(x => pat.every(p => x.includes(p)));
    if(idx >= 0) return keys[idx];
  }
  return null;
}

function coerceText(v){
  if(v === null || v === undefined) return "";
  return String(v).trim();
}

function parseRowsToData(rows){
  const vocab = [];
  const ety = [];

  if(!rows.length) return {vocab, ety};

  const keys = Object.keys(rows[0] || {});
  const typeKey = findKey(keys, [["type"],["category"]]);

  // Vocab mapping
  const vTermKey = findKey(keys, [
    ["vocab","term"],["vocabulary","term"],["term"],["word"],["vocab"]
  ]);
  const vDefKey = findKey(keys, [
    ["vocab","def"],["vocabulary","def"],["definition"],["def"]
  ]);

  // Etymology mapping
  const ePartKey = findKey(keys, [
    ["ety","part"],["etym","part"],["word","part"],["part"],["morpheme"],["root"],["prefix"],["suffix"]
  ]);
  const eMeanKey = findKey(keys, [
    ["ety","meaning"],["etym","meaning"],["meaning"],["gloss"]
  ]);

  for(const r of rows){
    const tVal = typeKey ? coerceText(r[typeKey]).toLowerCase() : "";
    const vTerm = vTermKey ? coerceText(r[vTermKey]) : "";
    const vDef  = vDefKey  ? coerceText(r[vDefKey])  : "";
    const ePart = ePartKey ? coerceText(r[ePartKey]) : "";
    const eMean = eMeanKey ? stripExamples(coerceText(r[eMeanKey])) : "";

    const isV = tVal.includes("vocab") || tVal.includes("glossary") || tVal.includes("definition");
    const isE = tVal.includes("ety") || tVal.includes("etym") || tVal.includes("word part") || tVal.includes("morpheme");

    // If explicit type: respect it
    if(typeKey && tVal){
      if(isV && vTerm && vDef) vocab.push({term:vTerm, def:vDef});
      if(isE && ePart && eMean) ety.push({part:ePart, meaning:eMean});
      continue;
    }

    // Otherwise: infer by presence
    if(vTerm && vDef) vocab.push({term:vTerm, def:vDef});
    if(ePart && eMean) ety.push({part:ePart, meaning:eMean});
  }

  // de-dup + clean
  const seenV = new Set();
  const cleanV = [];
  for(const it of vocab){
    const k = (it.term+"||"+it.def).toLowerCase();
    if(seenV.has(k)) continue;
    if(!it.term || !it.def) continue;
    seenV.add(k);
    cleanV.push(it);
  }

  const seenE = new Set();
  const cleanE = [];
  for(const it of ety){
    const k = (it.part+"||"+it.meaning).toLowerCase();
    if(seenE.has(k)) continue;
    if(!it.part || !it.meaning) continue;
    seenE.add(k);
    cleanE.push(it);
  }

  return {vocab:cleanV, ety:cleanE};
}

function parseWorkbook(wb){
  // Try to find dedicated sheets by name
  const names = wb.SheetNames || [];
  const lower = names.map(n => n.toLowerCase());

  const vocabSheetName =
    names[lower.findIndex(n => n.includes("vocab"))] ||
    names[lower.findIndex(n => n.includes("gloss"))] ||
    names[0];

  const etySheetName =
    names[lower.findIndex(n => n.includes("ety"))] ||
    names[lower.findIndex(n => n.includes("etym"))] ||
    names[0];

  let vocabRows = [];
  let etyRows = [];

  // Read vocab candidate sheet
  try{
    const wsV = wb.Sheets[vocabSheetName];
    vocabRows = XLSX.utils.sheet_to_json(wsV, {defval:"", raw:false});
  }catch{}

  // Read ety candidate sheet (may be same as vocab sheet)
  try{
    const wsE = wb.Sheets[etySheetName];
    etyRows = XLSX.utils.sheet_to_json(wsE, {defval:"", raw:false});
  }catch{}

  // If both sheets are same, parse once
  if(vocabSheetName === etySheetName){
    const merged = parseRowsToData(vocabRows);
    return merged;
  }

  // Parse separately, then merge
  const v = parseRowsToData(vocabRows);
  const e = parseRowsToData(etyRows);
  return {
    vocab: v.vocab.length ? v.vocab : e.vocab,
    ety:   e.ety.length   ? e.ety   : v.ety
  };
}

async function loadSpreadsheet(){
  setDataStatus("Loading dataset…");
  setTechStatus("Fetching spreadsheet…");

  if(!window.XLSX){
    setDataStatus("XLSX library missing");
    setTechStatus("SheetJS failed to load (CDN blocked). Host xlsx.full.min.js locally or allow CDN.");
    return;
  }

  try{
    const res = await fetch(SPREADSHEET_FILE, {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, {type:"array"});
    const parsed = parseWorkbook(wb);

    STATE.data.vocab = parsed.vocab;
    STATE.data.ety = parsed.ety;

    const vN = STATE.data.vocab.length;
    const eN = STATE.data.ety.length;

    setDataStatus(`Loaded: Vocabulary ${vN} | Etymology ${eN}`);
    setTechStatus(vN || eN ? "Ready." : "No usable rows found. Check spreadsheet headers/columns.");
  }catch(err){
    setDataStatus("Dataset not loaded");
    setTechStatus("Failed to load XLSX. If you opened via file://, fetch is blocked. Serve/host the folder. ("+err.message+")");
  }
}

evReloadBtn.addEventListener("click", loadSpreadsheet);

/* ===========================
   EV Quiz engine (ABCD)
=========================== */
const evCount = document.getElementById("evCount");
const evStartBtn = document.getElementById("evStartBtn");
const evChangeBtn = document.getElementById("evChangeBtn");
const evMode = document.getElementById("evMode");

const evQuizArea = document.getElementById("evQuizArea");
const evSummaryArea = document.getElementById("evSummaryArea");

function buildLogicalDistractors(pool, correctIdx, textField, k=3){
  const correctText = pool[correctIdx][textField];
  const cTok = tokenize(correctText);
  const scores = [];

  for(let i=0;i<pool.length;i++){
    if(i === correctIdx) continue;
    const t = pool[i][textField];
    const s = jaccard(cTok, tokenize(t));
    scores.push({i, s});
  }

  // Prefer high similarity but not identical; then fall back.
  scores.sort((a,b)=>b.s - a.s);

  const picked = [];
  for(const cand of scores){
    if(picked.length >= k) break;
    if(cand.s >= 0.95) continue; // too close; risk duplicate-ish
    picked.push(cand.i);
  }
  // If not enough, fill randomly
  if(picked.length < k){
    const remaining = scores.map(x=>x.i).filter(i => !picked.includes(i));
    shuffle(remaining);
    while(picked.length < k && remaining.length) picked.push(remaining.pop());
  }
  return picked.slice(0,k);
}

function makeEVQuiz(mode, N){
  const vocab = STATE.data.vocab;
  const ety = STATE.data.ety;

  const questions = [];
  const wantV = (mode === "vocab" || mode === "mixed");
  const wantE = (mode === "ety" || mode === "mixed");

  const vIdx = [...vocab.keys()];
  const eIdx = [...ety.keys()];
  shuffle(vIdx); shuffle(eIdx);

  // Determine composition
  let vTake = 0, eTake = 0;
  if(mode === "vocab"){
    vTake = Math.min(N, vIdx.length);
  }else if(mode === "ety"){
    eTake = Math.min(N, eIdx.length);
  }else{
    // mixed: approximate half-half but respect availability
    const half = Math.floor(N/2);
    vTake = Math.min(half + (N%2), vIdx.length);
    eTake = Math.min(half, eIdx.length);

    if(vTake + eTake < N){
      // fill remaining from whichever has more available
      const remaining = N - (vTake + eTake);
      const vAvail = vIdx.length - vTake;
      const eAvail = eIdx.length - eTake;
      if(vAvail >= eAvail) vTake += Math.min(remaining, vAvail);
      else eTake += Math.min(remaining, eAvail);
    }
  }

  if((wantV && vTake < 1) && (wantE && eTake < 1)){
    return null;
  }

  // Build vocab questions
  for(let n=0;n<vTake;n++){
    const idx = vIdx[n];
    const corr = vocab[idx];

    // Options are definitions only (same type), logical distractors based on definition similarity
    const distractIdx = buildLogicalDistractors(vocab, idx, "def", 3);
    const options = [
      {text:corr.def, isCorrect:true},
      ...distractIdx.map(di => ({text:vocab[di].def, isCorrect:false}))
    ];
    shuffle(options);

    const letters = ["A","B","C","D"];
    const optMap = {};
    let answer = "A";
    options.forEach((o,i)=>{
      optMap[letters[i]] = o.text;
      if(o.isCorrect) answer = letters[i];
    });

    questions.push({
      kind:"Vocabulary",
      stem:corr.term,
      prompt:"Choose the best definition.",
      options:optMap,
      answer,
      rationale: "" // optional
    });
  }

  // Build etymology questions
  for(let n=0;n<eTake;n++){
    const idx = eIdx[n];
    const corr = ety[idx];
    const distractIdx = buildLogicalDistractors(ety, idx, "meaning", 3);
    const options = [
      {text:stripExamples(corr.meaning), isCorrect:true},
      ...distractIdx.map(di => ({text:stripExamples(ety[di].meaning), isCorrect:false}))
    ];
    shuffle(options);

    const letters = ["A","B","C","D"];
    const optMap = {};
    let answer = "A";
    options.forEach((o,i)=>{
      optMap[letters[i]] = o.text;
      if(o.isCorrect) answer = letters[i];
    });

    questions.push({
      kind:"Etymology",
      stem:corr.part,
      prompt:"Choose the best meaning.",
      options:optMap,
      answer,
      rationale:""
    });
  }

  shuffle(questions);

  // Trim to N if overfilled due to availability adjustments
  const finalQ = questions.slice(0, Math.min(N, questions.length));

  return {
    title: "Etymology & Vocabulary Practice",
    questions: finalQ,
    answers: new Array(finalQ.length).fill(null),
    startedAt: beijingNow()
  };
}

/* Render quiz */
function renderQuiz(container, quiz, onFinish){
  const qn = quiz.questions.length;

  let idx = 0;

  function currentAnswer(){
    return quiz.answers[idx];
  }

  function setAnswer(letter){
    quiz.answers[idx] = letter;
    render();
  }

  function render(){
    const q = quiz.questions[idx];
    const letters = ["A","B","C","D"];

    container.innerHTML = `
      <div class="quizTop">
        <div>
          <div class="qMeta mono">Question ${idx+1} of ${qn} · ${escapeHtml(q.kind)}</div>
          <div class="qStem">${escapeHtml(q.stem)}</div>
          <div class="qPrompt">${escapeHtml(q.prompt)}</div>
        </div>
        <div class="pill mono">Change number anytime</div>
      </div>

      <div class="optList">
        ${letters.map(L => {
          const text = q.options[L] ?? "";
          const checked = currentAnswer() === L ? "checked" : "";
          return `
            <label class="opt">
              <input type="radio" name="opt" value="${L}" ${checked} />
              <span class="optLabel">
                <span class="optLetter">${L}.</span>
                <span class="optText">${escapeHtml(text)}</span>
              </span>
            </label>
          `;
        }).join("")}
      </div>

      <div class="quizNav">
        <div class="quizNavLeft">
          <button type="button" class="btn btnGhost" id="btnBack" ${idx===0?"disabled":""}>Back</button>
        </div>

        <div class="centerActions">
          <button type="button" class="btn btnDanger" id="btnFinish">Finish now</button>
        </div>

        <div class="quizNavRight">
          <button type="button" class="btn btnPrimary" id="btnNext">${idx===qn-1?"Finish":"Next"}</button>
        </div>
      </div>
    `;

    container.querySelectorAll('input[name="opt"]').forEach(r=>{
      r.addEventListener("change", (e)=>setAnswer(e.target.value));
    });

    container.querySelector("#btnBack").addEventListener("click", ()=>{
      if(idx>0){ idx--; render(); }
    });

    container.querySelector("#btnNext").addEventListener("click", ()=>{
      if(idx < qn-1){
        idx++; render();
      }else{
        onFinish();
      }
    });

    container.querySelector("#btnFinish").addEventListener("click", onFinish);
  }

  render();
}

/* Summary */
function buildSummary(quiz){
  const letters = ["A","B","C","D"];
  const total = quiz.questions.length;

  let correct = 0, attempted = 0;
  const wrong = [];

  for(let i=0;i<total;i++){
    const q = quiz.questions[i];
    const ans = quiz.answers[i];
    const isAttempted = !!ans;
    if(isAttempted) attempted++;
    const isCorrect = ans === q.answer;
    if(isCorrect) correct++;
    else wrong.push({i, q, ans});
  }

  const percent = Math.round((correct/total)*100);
  let band = "tagWARN";
  if(percent >= 80) band = "tagOK";
  else if(percent < 50) band = "tagBAD";

  // Breakdown by kind
  const kindStats = {};
  for(let i=0;i<total;i++){
    const k = quiz.questions[i].kind;
    kindStats[k] ||= {total:0, correct:0, attempted:0};
    kindStats[k].total++;
    if(quiz.answers[i]) kindStats[k].attempted++;
    if(quiz.answers[i] === quiz.questions[i].answer) kindStats[k].correct++;
  }

  // Professional rationale (minimalist but concrete)
  const rationaleLines = [];
  rationaleLines.push(`Attempted: ${attempted}/${total}. Unattempted questions are scored as incorrect (by design).`);
  rationaleLines.push(`Distractors were selected from the same question type and biased toward semantic similarity for plausibility.`);
  rationaleLines.push(`If you missed many, reduce N and retake until accuracy is stable — then increase N.`);

  return {correct, total, attempted, percent, band, wrong, kindStats, rationaleLines};
}

function renderSummary(container, quiz, onRetakeSame, onNewSet, onChangeNumber){
  const s = buildSummary(quiz);

  const kindBits = Object.entries(s.kindStats).map(([k,st])=>{
    const p = st.total ? Math.round((st.correct/st.total)*100) : 0;
    const cls = p >= 80 ? "tagOK" : (p < 50 ? "tagBAD" : "tagWARN");
    return `<div class="pill mono">${escapeHtml(k)}: <span class="${cls}">${st.correct}/${st.total} (${p}%)</span></div>`;
  }).join("");

  container.innerHTML = `
    <div class="scoreBox">
      <p class="scoreBig"><span class="${s.band}">${s.correct}/${s.total} (${s.percent}%)</span></p>
      <p class="scoreSub mono">Started: ${escapeHtml(quiz.startedAt)} · Finished: ${escapeHtml(beijingNow())}</p>
      <div class="pillRow" style="margin-top:10px;">${kindBits}</div>
    </div>

    <div class="reviewItem">
      <div class="reviewHead"><span class="mono">Summary rationale</span><span class="mono">Beijing time</span></div>
      ${s.rationaleLines.map(x=>`<div class="reviewLine">${escapeHtml(x)}</div>`).join("")}
    </div>

    <div class="row" style="margin-top:14px;">
      <button type="button" class="btn btnPrimary" id="retakeSame">Retake same quiz</button>
      <button type="button" class="btn btnGhost" id="newSet">Generate new quiz</button>
      <button type="button" class="btn btnGhost" id="changeN">Change number</button>
    </div>

    <div class="reviewList">
      ${s.wrong.slice(0, 60).map(w=>{
        const q = w.q;
        const your = w.ans ? w.ans : "—";
        const yourTxt = w.ans ? q.options[w.ans] : "";
        const corrTxt = q.options[q.answer] || "";
        const headTag = (w.ans ? `<span class="tagBAD">Incorrect</span>` : `<span class="tagWARN">Unanswered</span>`);
        return `
          <div class="reviewItem">
            <div class="reviewHead">
              <span class="mono">Q${w.i+1} · ${escapeHtml(q.kind)}</span>
              ${headTag}
            </div>
            <div class="reviewStem">${escapeHtml(q.stem)}</div>
            <div class="reviewLine"><span class="tagBAD">Your answer:</span> <span class="mono">${escapeHtml(your)}</span> ${escapeHtml(yourTxt)}</div>
            <div class="reviewLine"><span class="tagOK">Correct:</span> <span class="mono">${escapeHtml(q.answer)}</span> ${escapeHtml(corrTxt)}</div>
          </div>
        `;
      }).join("")}
    </div>
  `;

  container.querySelector("#retakeSame").addEventListener("click", onRetakeSame);
  container.querySelector("#newSet").addEventListener("click", onNewSet);
  container.querySelector("#changeN").addEventListener("click", onChangeNumber);
}

/* EV controls */
function evResetViews(){
  evQuizArea.classList.add("hidden");
  evSummaryArea.classList.add("hidden");
  evQuizArea.innerHTML = "";
  evSummaryArea.innerHTML = "";
}

evChangeBtn.addEventListener("click", ()=>{
  evResetViews();
  evCount.focus();
});

evStartBtn.addEventListener("click", ()=>{
  const N = clampInt(evCount.value, 1, 100);
  if(!N){
    setTechStatus("Enter an integer from 1 to 100.");
    return;
  }
  const mode = evMode.value;
  const quiz = makeEVQuiz(mode, N);
  if(!quiz || !quiz.questions.length){
    setTechStatus("No questions available for that mode. Check dataset load.");
    return;
  }

  STATE.evQuiz = quiz;
  evResetViews();
  evQuizArea.classList.remove("hidden");
  renderQuiz(evQuizArea, quiz, ()=>{
    evQuizArea.classList.add("hidden");
    evSummaryArea.classList.remove("hidden");
    renderSummary(evSummaryArea, quiz,
      // Retake same
      ()=>{
        quiz.answers = new Array(quiz.questions.length).fill(null);
        quiz.startedAt = beijingNow();
        evSummaryArea.classList.add("hidden");
        evQuizArea.classList.remove("hidden");
        renderQuiz(evQuizArea, quiz, ()=>evStartBtn.click()); // will route to summary
      },
      // New set
      ()=>evStartBtn.click(),
      // Change number
      ()=>evChangeBtn.click()
    );
  });

  setTechStatus("Quiz running.");
});

/* ===========================
   Custom Content: Prompt -> Paste JSON -> Quiz
=========================== */
const customFile = document.getElementById("customFile");
const customText = document.getElementById("customText");
const customN = document.getElementById("customN");
const customMakePromptBtn = document.getElementById("customMakePromptBtn");
const customPrompt = document.getElementById("customPrompt");
const copyPromptBtn = document.getElementById("copyPromptBtn");
const customJson = document.getElementById("customJson");
const customLoadQuizBtn = document.getElementById("customLoadQuizBtn");
const customStatus = document.getElementById("customStatus");
const customQuizArea = document.getElementById("customQuizArea");
const customSummaryArea = document.getElementById("customSummaryArea");
const customResetBtn = document.getElementById("customResetBtn");

async function readFileAsText(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(String(r.result||""));
    r.onerror = ()=>reject(new Error("Failed to read file."));
    r.readAsText(file);
  });
}

function customReset(){
  customFile.value = "";
  customText.value = "";
  customN.value = "";
  customPrompt.value = "";
  customJson.value = "";
  customStatus.textContent = "Awaiting content.";
  customQuizArea.classList.add("hidden");
  customSummaryArea.classList.add("hidden");
  customQuizArea.innerHTML = "";
  customSummaryArea.innerHTML = "";
  STATE.customQuiz = null;
}

customResetBtn.addEventListener("click", customReset);

customMakePromptBtn.addEventListener("click", async ()=>{
  const N = clampInt(customN.value, 1, 100);
  if(!N){
    customStatus.textContent = "Enter an integer from 1 to 100.";
    return;
  }

  let content = (customText.value || "").trim();
  if(!content && customFile.files && customFile.files[0]){
    try{
      content = (await readFileAsText(customFile.files[0])).trim();
    }catch(e){
      customStatus.textContent = e.message;
      return;
    }
  }
  if(!content){
    customStatus.textContent = "Provide content (upload or paste).";
    return;
  }

  const prompt = [
    "You are MCQ JSON Machine. Generate high-quality MCQs strictly from the content below.",
    `Number of MCQs: ${N}`,
    "",
    "Return JSON only with this shape:",
    '{"title":"<inferred>","questions":[{"stem":"...","options":{"A":"...","B":"...","C":"...","D":"..."},"answer":"A","rationale":"<brief>"}]}',
    "",
    "CONTENT:",
    content
  ].join("\n");

  customPrompt.value = prompt;
  customStatus.textContent = "Prompt generated. Paste it into your MCQ JSON Machine, then paste returned JSON below.";
});

copyPromptBtn.addEventListener("click", async ()=>{
  if(!customPrompt.value.trim()) return;
  try{
    await navigator.clipboard.writeText(customPrompt.value);
    customStatus.textContent = "Prompt copied.";
  }catch{
    customStatus.textContent = "Clipboard blocked by browser. Select and copy manually.";
  }
});

function validateCustomQuiz(obj){
  if(!obj || typeof obj !== "object") return "JSON must be an object.";
  if(!Array.isArray(obj.questions) || !obj.questions.length) return "JSON must include questions[].";
  for(let i=0;i<obj.questions.length;i++){
    const q = obj.questions[i];
    if(!q || typeof q !== "object") return `Question ${i+1} invalid.`;
    if(typeof q.stem !== "string" || !q.stem.trim()) return `Question ${i+1} missing stem.`;
    if(!q.options || typeof q.options !== "object") return `Question ${i+1} missing options.`;
    for(const L of ["A","B","C","D"]){
      if(typeof q.options[L] !== "string" || !q.options[L].trim()) return `Question ${i+1} missing option ${L}.`;
    }
    if(!["A","B","C","D"].includes(q.answer)) return `Question ${i+1} answer must be A/B/C/D.`;
  }
  return null;
}

customLoadQuizBtn.addEventListener("click", ()=>{
  let obj;
  try{
    obj = JSON.parse(customJson.value || "");
  }catch{
    customStatus.textContent = "Invalid JSON.";
    return;
  }
  const err = validateCustomQuiz(obj);
  if(err){
    customStatus.textContent = err;
    return;
  }

  // Normalize into our quiz shape
  const quiz = {
    title: obj.title || "Custom Content Practice",
    questions: obj.questions.map(q => ({
      kind: "Custom",
      stem: q.stem,
      prompt: "Choose the best option.",
      options: q.options,
      answer: q.answer,
      rationale: q.rationale || ""
    })),
    answers: new Array(obj.questions.length).fill(null),
    startedAt: beijingNow()
  };
  STATE.customQuiz = quiz;

  customQuizArea.classList.remove("hidden");
  customSummaryArea.classList.add("hidden");
  customQuizArea.innerHTML = "";
  customSummaryArea.innerHTML = "";

  renderQuiz(customQuizArea, quiz, ()=>{
    customQuizArea.classList.add("hidden");
    customSummaryArea.classList.remove("hidden");
    renderSummary(customSummaryArea, quiz,
      ()=>{
        quiz.answers = new Array(quiz.questions.length).fill(null);
        quiz.startedAt = beijingNow();
        customSummaryArea.classList.add("hidden");
        customQuizArea.classList.remove("hidden");
        renderQuiz(customQuizArea, quiz, ()=>customLoadQuizBtn.click());
      },
      ()=>{
        // "new set" for custom means: user must paste new JSON
        customStatus.textContent = "Paste a new JSON set to generate a new quiz.";
        customSummaryArea.classList.add("hidden");
        customQuizArea.classList.add("hidden");
      },
      ()=>{
        // change number is handled in their JSON machine; keep minimal
        customStatus.textContent = "Change N, regenerate prompt, then paste a new JSON set.";
        customSummaryArea.classList.add("hidden");
        customQuizArea.classList.add("hidden");
      }
    );
  });

  customStatus.textContent = "Quiz loaded.";
});

/* ===========================
   Init
=========================== */
(async function init(){
  await initUpdates();
  await loadSpreadsheet();
})();
</script>
</body>
</html>
