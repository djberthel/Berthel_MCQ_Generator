<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Berthel's Biology</title>

  <style>
    :root{
      --bg:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --panel:#ffffff;
      --soft:#f9fafb;

      --ok:#15803d;   /* green */
      --bad:#b91c1c;  /* red */

      --radius:16px;
    }

    html,body{
      height:100%;
      background:var(--bg);
      color:var(--ink);

      /* Latin Modern first; graceful fallbacks */
      font-family:
        "Latin Modern Roman",
        "LatinModernRoman",
        "LM Roman 10",
        "Computer Modern Serif",
        "Times New Roman",
        serif;

      font-size:18px;         /* larger */
      line-height:1.45;
    }
    *{ box-sizing:border-box; }
    a{ color:inherit; text-decoration:none; }
    button,input,textarea{ font:inherit; }

    .wrap{
      max-width: 1040px;
      margin: 0 auto;
      padding: 18px 14px 44px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }
    .avatar{
      width:48px;
      height:48px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--soft);
      object-fit:cover;
      flex:0 0 auto;
    }
    .titlebox{ min-width: 0; }
    .title{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      margin:2px 0 0;
      color:var(--muted);
      font-size: 15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .version{
      color:var(--muted);
      font-size: 14px;
      white-space:nowrap;
      padding-left:10px;
      border-left:1px solid var(--line);
      font-weight:700;
    }

    nav{
      margin-top: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding: 10px 10px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
    }
    .tabbtn{
      border:1px solid var(--line);
      background: var(--bg);
      padding: 9px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:800;
      color: var(--ink);
      font-size: 15px;
    }
    .tabbtn[aria-selected="true"]{
      background: var(--ink);
      color: var(--bg);
      border-color: var(--ink);
    }

    main{ margin-top: 12px; }
    section{
      display:none;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      padding: 14px;
    }
    section.active{ display:block; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--bg);
      padding: 12px;
    }

    .label{
      display:block;
      color:var(--muted);
      font-size: 14px;
      margin-bottom: 6px;
      font-weight:800;
    }

    .num{
      width: 170px;
      padding: 11px 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: var(--bg);
      outline:none;
      font-weight:800;
    }
    .num:focus{ border-color:#cbd5e1; }

    .btn{
      border:1px solid var(--line);
      background: var(--bg);
      padding: 11px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:900;
    }
    .btn.primary{
      background: var(--ink);
      border-color: var(--ink);
      color: var(--bg);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .quiet{
      color:var(--muted);
      font-size: 14px;
      margin: 8px 0 0;
      font-weight:700;
    }

    .bar{
      display:none;
      margin-top: 10px;
      padding: 10px;
      border:1px solid rgba(185,28,28,.25);
      background: rgba(185,28,28,.06);
      border-radius: var(--radius);
      color: var(--bad);
      font-weight:900;
      font-size: 14px;
    }
    .bar.show{ display:block; }

    /* Quiz */
    .quizTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 10px;
    }
    .progress{
      color:var(--muted);
      font-size: 14px;
      font-weight:900;
    }
    .qstem{
      font-size: 22px;
      font-weight: 900;
      margin: 8px 0 12px;
      line-height:1.25;
    }
    .options{
      display:flex;
      flex-direction:column;
      gap:9px;
    }
    .opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 11px 11px;
      background: var(--bg);
      cursor:pointer;
    }
    .opt input{ margin-top:4px; transform: scale(1.15); }
    .opt .otxt{
      flex:1;
      color: var(--ink);
      font-size: 16px;
      font-weight:700;
    }
    .quizActions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .hintBad{
      color: var(--bad);
      font-size: 14px;
      font-weight:900;
    }

    /* Summary */
    .summaryHeader{
      display:flex;
      gap:12px;
      align-items:baseline;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .scoreBig{
      font-size: 22px;
      font-weight: 950;
      margin:0;
    }
    .scoreMeta{
      color:var(--muted);
      font-size: 14px;
      font-weight:900;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding: 7px 11px;
      font-size: 14px;
      font-weight:950;
      background: var(--soft);
    }
    .pill.ok{ color: var(--ok); border-color: rgba(21,128,61,.25); background: rgba(21,128,61,.06); }
    .pill.bad{ color: var(--bad); border-color: rgba(185,28,28,.25); background: rgba(185,28,28,.06); }

    .reviewList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .reviewItem{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      background: var(--bg);
    }
    .reviewItem.ok{ border-color: rgba(21,128,61,.25); background: rgba(21,128,61,.04); }
    .reviewItem.bad{ border-color: rgba(185,28,28,.25); background: rgba(185,28,28,.04); }
    .reviewTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom: 6px;
    }
    .reviewQ{
      font-weight:950;
      font-size: 15px;
    }
    .mark{
      font-weight:950;
      font-size: 14px;
      white-space:nowrap;
    }
    .mark.ok{ color: var(--ok); }
    .mark.bad{ color: var(--bad); }
    .reviewLine{
      color: var(--ink);
      font-size: 14.5px;
      margin: 4px 0;
      font-weight:700;
    }
    .reviewLine .k{ color: var(--muted); font-weight:950; }
    .reviewLine .v{ color: var(--ink); }

    /* Home updates */
    .updates{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .update{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      background: var(--bg);
    }
    .updateTime{
      color:var(--muted);
      font-size: 13.5px;
      font-weight:950;
      margin-bottom: 6px;
    }
    .updateMsg{
      margin:0;
      font-size: 15px;
      font-weight:750;
    }

    /* Admin panel (hidden by default; unlock via Ctrl+Shift+U) */
    .admin{
      display:none;
      margin-top: 12px;
    }
    .admin.show{ display:block; }
    textarea{
      width:100%;
      min-height:130px;
      padding:12px;
      border:1px solid var(--line);
      border-radius: 14px;
      outline:none;
      resize:vertical;
      background: var(--bg);
      font-weight:700;
      font-size: 16px;
    }

    @media (max-width:520px){
      .version{ border-left:none; padding-left:0; }
      header{ align-items:flex-start; }
      html,body{ font-size:17px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img id="avatar" class="avatar" src="Chinstrap_LOgo.jfif" alt="Avatar" />
        <div class="titlebox">
          <p class="title">Berthel's Biology</p>
          <p class="subtitle">Professional student testing and review workspace.</p>
        </div>
      </div>
      <div class="version" id="version"></div>
    </header>

    <nav role="tablist" aria-label="Sections">
      <button class="tabbtn" id="tab-home" role="tab" aria-selected="true" aria-controls="home">Home</button>
      <button class="tabbtn" id="tab-ety" role="tab" aria-selected="false" aria-controls="ety">Etymology & Vocabulary</button>
      <button class="tabbtn" id="tab-custom" role="tab" aria-selected="false" aria-controls="custom">MCQ Content</button>
    </nav>

    <main>
      <!-- HOME -->
      <section id="home" class="active" role="tabpanel" aria-labelledby="tab-home">
        <div class="card">
          <div class="label">Update notes</div>
          <div id="updates" class="updates"></div>

          <div id="adminPanel" class="admin">
            <div style="height:10px"></div>
            <div class="label">Add update (admin)</div>
            <textarea id="adminMsg" placeholder="Write an update note."></textarea>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="postUpdate">Post update</button>
              <button class="btn" id="downloadUpdates">Download updates.json</button>
              <input type="file" id="importUpdatesFile" accept="application/json" style="display:none" />
              <button class="btn" id="importUpdates">Import updates.json</button>
            </div>
            <p class="quiet">Updates are timestamped (UTC+8) at posting time.</p>
          </div>
        </div>
      </section>

      <!-- ETY/VOCAB -->
      <section id="ety" role="tabpanel" aria-labelledby="tab-ety">
        <div class="card">
          <div class="row">
            <div style="min-width:240px">
              <span class="label">Number of questions (1–100)</span>
              <input id="etyN" class="num" type="number" inputmode="numeric" min="1" max="100" step="1" placeholder="e.g., 20" />
            </div>
            <div style="flex:1; min-width:260px">
              <div class="label">Status</div>
              <div id="etyStatus" class="quiet">Loading question bank…</div>
            </div>
            <div>
              <div class="label" style="visibility:hidden">Generate</div>
              <button class="btn primary" id="etyGenerate" disabled>Generate quiz</button>
            </div>
          </div>

          <div id="bankBar" class="bar">
            The bank could not be auto-loaded. If you are opening this as a local file, use a local web server, or select the bank file once below.
            <div class="row" style="margin-top:8px">
              <input type="file" id="bankFile" accept=".txt,text/plain" />
            </div>
          </div>

          <div style="height:12px"></div>
          <div id="etyView"></div>
        </div>
      </section>

      <!-- CUSTOM MCQ -->
      <section id="custom" role="tabpanel" aria-labelledby="tab-custom">
        <div class="card">
          <div class="row">
            <div style="flex:1; min-width:300px">
              <span class="label">Paste MCQ JSON</span>
              <textarea id="customJson" placeholder=""></textarea>
            </div>
            <div style="min-width:260px">
              <span class="label">Or upload JSON file</span>
              <input type="file" id="customFile" accept="application/json,.json" />
              <div style="height:12px"></div>
              <span class="label">Number of questions (1–100)</span>
              <input id="customN" class="num" type="number" inputmode="numeric" min="1" max="100" step="1" placeholder="e.g., 20" />
              <div style="height:12px"></div>
              <button class="btn primary" id="customGenerate" disabled>Generate quiz</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn" id="customLoad">Load JSON</button>
            <div id="customStatus" class="quiet">Awaiting JSON…</div>
          </div>

          <div style="height:12px"></div>
          <div id="customView"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    /********************
     * Version (stable-per-build for each visitor):
     * - BUILD_ID changes when you deploy new code
     * - version timestamp is set once per BUILD_ID in localStorage (UTC+8)
     ********************/
    const BUILD_ID = "2026-02-10_update_002"; // change this on each deployment
    const VERSION_KEY = "bertBio_buildVersion_" + BUILD_ID;

    function beijingStamp(){
      const d = new Date();
      const s = d.toLocaleString("sv-SE", {
        timeZone: "Asia/Shanghai",
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit",
        hour12:false
      });
      return s.replace(",", "");
    }

    let buildVersion = localStorage.getItem(VERSION_KEY);
    if (!buildVersion){
      buildVersion = beijingStamp() + " (UTC+8)";
      localStorage.setItem(VERSION_KEY, buildVersion);
    }
    document.getElementById("version").textContent = "v" + buildVersion;

    /********************
     * Avatar fallback
     ********************/
    const AVATAR_FALLBACK_DATA_URL = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQE%0ABQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRQBAwME%0ADgQHBgkIBwkUDQsMFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU%0AFBQUFBQUFBQUFBQUFBQUFP/AABEIAQ0A+gMBIgACEQEDEQH/xAAbAAEAAgMBAQAA%0AAAAAAAAAAAAGBQcBAgMEB//EADoQAAIBAgQDBQYEBwAAAAAAAAECAwQRAAUSITFB%0ABhMiUWEHMoGRoRQjQlNiscHR8BVCYv/EABcBAQEBAQAAAAAAAAAAAAAAAAABAgP/%0AxAAhEQEBAQEAAgIDAQAAAAAAAAABEQIhAxIxQVEiMmFxkf/aAAwDAQACEQMRAD8A%0A9u0pV5I9kqm5wK8GJxHkqQ8E1Y3p6y+6o8JqF0cKk0YwW2zZbG3mI8fQnR3iYh8o%0Alq4k3h7p8N8bT5p3c5c3m0n9oBv6m4+S1x7m2q0fH2l9t2g2Lw2qgQpJH2c0j5cI%0A3VJf0yQ8b4nXKXqE7H6z1y2t3l1m7QbZ7bqB7VQ4xQH4u3m5w7Y1zv5bOq8f7g5%0Ap+4s0m3b0G2v2aYb5qUoUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpU%0AqVKlSpUqVKlSpUqVKlf/2Q==";

    const avatar = document.getElementById("avatar");
    avatar.addEventListener("error", () => { avatar.src = AVATAR_FALLBACK_DATA_URL; }, { once:true });

    /********************
     * Tabs
     ********************/
    const tabs = [
      {btn:"tab-home", panel:"home"},
      {btn:"tab-ety", panel:"ety"},
      {btn:"tab-custom", panel:"custom"},
    ];
    function setTab(panelId){
      for (const t of tabs){
        const b = document.getElementById(t.btn);
        const p = document.getElementById(t.panel);
        const on = (t.panel === panelId);
        b.setAttribute("aria-selected", on ? "true" : "false");
        p.classList.toggle("active", on);
      }
    }
    for (const t of tabs){
      document.getElementById(t.btn).addEventListener("click", () => setTab(t.panel));
    }

    /********************
     * Home updates
     ********************/
    const UPDATES_KEY = "bertBio_updates_v2";
    const UPDATES_JSON_PATH = "updates.json";
    const DEFAULT_UPDATES = [
      {
        ts: "2026-02-10 15:06:41",
        msg: "Next update: repaired numeric input handling (all integers 1–100), improved submission flow, and a clearer results summary with red/green indicators plus retry/new-quiz options."
      }
    ];

    function renderUpdates(list){
      const box = document.getElementById("updates");
      box.innerHTML = "";
      if (!list.length){
        const empty = document.createElement("div");
        empty.className = "quiet";
        empty.textContent = "No updates posted.";
        box.appendChild(empty);
        return;
      }
      for (const u of list.slice().sort((a,b)=> (a.ts < b.ts ? 1 : -1))){
        const el = document.createElement("div");
        el.className = "update";
        const t = document.createElement("div");
        t.className = "updateTime";
        t.textContent = u.ts + " (UTC+8)";
        const p = document.createElement("p");
        p.className = "updateMsg";
        p.textContent = u.msg;
        el.appendChild(t);
        el.appendChild(p);
        box.appendChild(el);
      }
    }

    async function loadUpdates(){
      let fromServer = null;
      try{
        const r = await fetch(UPDATES_JSON_PATH, { cache:"no-store" });
        if (r.ok){
          const j = await r.json();
          if (Array.isArray(j)) fromServer = j;
          else if (j && Array.isArray(j.updates)) fromServer = j.updates;
        }
      }catch(_){}
      if (fromServer && fromServer.length){
        renderUpdates(fromServer);
        return fromServer;
      }
      const raw = localStorage.getItem(UPDATES_KEY);
      if (raw){
        try{
          const list = JSON.parse(raw);
          if (Array.isArray(list)){
            renderUpdates(list);
            return list;
          }
        }catch(_){}
      }
      renderUpdates(DEFAULT_UPDATES);
      return DEFAULT_UPDATES.slice();
    }

    let updatesState = [];
    loadUpdates().then(list => updatesState = list);

    const ADMIN_PANEL = document.getElementById("adminPanel");
    const ADMIN_KEY = "BERTHEL_ADMIN";
    let adminUnlocked = false;

    window.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.shiftKey && e.code === "KeyU"){
        const k = prompt("Admin key:");
        if (k === ADMIN_KEY){
          adminUnlocked = true;
          ADMIN_PANEL.classList.add("show");
        }
      }
    });

    document.getElementById("postUpdate").addEventListener("click", () => {
      if (!adminUnlocked) return;
      const ta = document.getElementById("adminMsg");
      const msg = (ta.value || "").trim();
      if (!msg) return;
      const entry = { ts: beijingStamp(), msg };
      updatesState = [entry, ...updatesState];
      localStorage.setItem(UPDATES_KEY, JSON.stringify(updatesState));
      ta.value = "";
      renderUpdates(updatesState);
    });

    document.getElementById("downloadUpdates").addEventListener("click", () => {
      if (!adminUnlocked) return;
      const blob = new Blob([JSON.stringify(updatesState, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "updates.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    });

    document.getElementById("importUpdates").addEventListener("click", () => {
      if (!adminUnlocked) return;
      document.getElementById("importUpdatesFile").click();
    });

    document.getElementById("importUpdatesFile").addEventListener("change", async (e) => {
      if (!adminUnlocked) return;
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try{
        const text = await f.text();
        const j = JSON.parse(text);
        const list = Array.isArray(j) ? j : (j && Array.isArray(j.updates) ? j.updates : null);
        if (list){
          updatesState = list;
          localStorage.setItem(UPDATES_KEY, JSON.stringify(updatesState));
          renderUpdates(updatesState);
        }
      }catch(_){}
      e.target.value = "";
    });

    /********************
     * Utilities
     ********************/
    function clampInt(v, lo, hi){
      const n = Math.trunc(Number(v));
      if (!Number.isFinite(n)) return null;
      if (n < lo || n > hi) return null;
      return n;
    }
    function shuffle(arr){
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function escapeSpaces(s){
      return (s || "").replace(/\s+/g, " ").trim();
    }
    function hardenIntegerInput(el){
      const normalize = () => {
        const min = Number(el.min) || 1;
        const max = Number(el.max) || 100;
        const raw = el.value;
        if (raw === "") return;
        const n = Math.trunc(Number(raw));
        if (!Number.isFinite(n)) { el.value = ""; return; }
        el.value = String(Math.max(min, Math.min(max, n)));
      };
      el.addEventListener("blur", normalize);
      el.addEventListener("keydown", (e) => { if (e.key === "Enter") normalize(); });
    }

    /********************
     * Quiz engine (supports "Finish now" at any time)
     ********************/
    function mkQuizUI(mount){
      mount.innerHTML = "";
      const holder = document.createElement("div");
      holder.className = "card";
      mount.appendChild(holder);
      return holder;
    }

    function renderQuiz(holder, quizState){
      holder.innerHTML = "";

      const q = quizState.questions[quizState.idx];

      const top = document.createElement("div");
      top.className = "quizTop";

      const left = document.createElement("div");
      const prog = document.createElement("div");
      prog.className = "progress";
      prog.textContent = `Question ${quizState.idx + 1} of ${quizState.questions.length}`;
      const stem = document.createElement("div");
      stem.className = "qstem";
      stem.textContent = q.stem;
      left.appendChild(prog);
      left.appendChild(stem);

      const right = document.createElement("div");
      right.className = "row";
      right.style.justifyContent = "flex-end";

      const changeN = document.createElement("button");
      changeN.className = "btn";
      changeN.textContent = "Change number";
      changeN.addEventListener("click", () => quizState.onExit?.());
      right.appendChild(changeN);

      top.appendChild(left);
      top.appendChild(right);

      const opts = document.createElement("div");
      opts.className = "options";
      const selected = quizState.answers[quizState.idx] ?? null;

      q.options.forEach((txt, i) => {
        const lab = document.createElement("label");
        lab.className = "opt";

        const inp = document.createElement("input");
        inp.type = "radio";
        inp.name = "opt";
        inp.value = String(i);
        if (selected === i) inp.checked = true;

        const span = document.createElement("div");
        span.className = "otxt";
        span.textContent = txt;

        lab.appendChild(inp);
        lab.appendChild(span);

        lab.addEventListener("click", () => {
          quizState.answers[quizState.idx] = i;
          hint.textContent = "";
        });

        opts.appendChild(lab);
      });

      const actions = document.createElement("div");
      actions.className = "quizActions";

      const back = document.createElement("button");
      back.className = "btn";
      back.textContent = "Back";
      back.disabled = (quizState.idx === 0);
      back.addEventListener("click", () => {
        quizState.idx -= 1;
        renderQuiz(holder, quizState);
      });

      const finishNow = document.createElement("button");
      finishNow.className = "btn";
      finishNow.textContent = "Finish now";
      finishNow.addEventListener("click", () => quizState.onFinish?.());

      const hint = document.createElement("div");
      hint.className = "hintBad";

      const next = document.createElement("button");
      next.className = "btn primary";
      const isLast = (quizState.idx === quizState.questions.length - 1);
      next.textContent = isLast ? "Finish" : "Next";
      next.addEventListener("click", () => {
        const a = quizState.answers[quizState.idx];
        if (a === undefined || a === null){
          hint.textContent = "Select an answer to continue (or finish now).";
          return;
        }
        if (isLast){
          quizState.onFinish?.();
        }else{
          quizState.idx += 1;
          renderQuiz(holder, quizState);
        }
      });

      actions.appendChild(back);
      actions.appendChild(finishNow);
      actions.appendChild(hint);
      actions.appendChild(next);

      holder.appendChild(top);
      holder.appendChild(opts);
      holder.appendChild(actions);
    }

    function renderSummary(holder, quizState, rationaleMode){
      holder.innerHTML = "";

      const total = quizState.questions.length;
      let correct = 0;
      let answered = 0;

      for (let i=0;i<total;i++){
        const a = quizState.answers[i];
        if (a !== null && a !== undefined) answered++;
        if (a === quizState.questions[i].correctIndex) correct++;
      }
      const pct = Math.round((correct / total) * 100);

      const head = document.createElement("div");
      head.className = "summaryHeader";

      const h1 = document.createElement("p");
      h1.className = "scoreBig";
      h1.textContent = "Results";

      const meta = document.createElement("div");
      meta.className = "scoreMeta";
      meta.textContent = `${correct} / ${total} (${pct}%) • Answered: ${answered}/${total}`;

      const p1 = document.createElement("span");
      p1.className = "pill " + (pct >= 70 ? "ok" : "bad");
      p1.textContent = (pct >= 70 ? "Strong" : "Needs work");

      const p2 = document.createElement("span");
      p2.className = "pill";
      p2.textContent = "Summary generated";

      head.appendChild(h1);
      head.appendChild(meta);
      head.appendChild(p1);
      head.appendChild(p2);

      const actions = document.createElement("div");
      actions.className = "row";
      actions.style.marginTop = "8px";

      const retry = document.createElement("button");
      retry.className = "btn";
      retry.textContent = "Retry same quiz";
      retry.addEventListener("click", () => quizState.onRetrySame?.());

      const newq = document.createElement("button");
      newq.className = "btn primary";
      newq.textContent = "Generate new quiz";
      newq.addEventListener("click", () => quizState.onNewQuiz?.());

      actions.appendChild(retry);
      actions.appendChild(newq);

      const list = document.createElement("div");
      list.className = "reviewList";

      for (let i=0;i<total;i++){
        const qq = quizState.questions[i];
        const a = quizState.answers[i];
        const ok = (a === qq.correctIndex);

        const item = document.createElement("div");
        item.className = "reviewItem " + (ok ? "ok" : "bad");

        const top = document.createElement("div");
        top.className = "reviewTop";

        const qlbl = document.createElement("div");
        qlbl.className = "reviewQ";
        qlbl.textContent = `Q${i+1}: ${qq.stem}`;

        const mark = document.createElement("div");
        mark.className = "mark " + (ok ? "ok" : "bad");
        mark.textContent = ok ? "Correct" : "Incorrect";

        top.appendChild(qlbl);
        top.appendChild(mark);

        const your = document.createElement("div");
        your.className = "reviewLine";
        your.innerHTML = `<span class="k">Your answer: </span><span class="v">${(a === null || a === undefined) ? "—" : qq.options[a]}</span>`;

        const cor = document.createElement("div");
        cor.className = "reviewLine";
        cor.innerHTML = `<span class="k">Correct answer: </span><span class="v">${qq.options[qq.correctIndex]}</span>`;

        const rat = document.createElement("div");
        rat.className = "reviewLine";

        let rationaleText = "";
        if (a === null || a === undefined){
          rationaleText = "No response recorded; use the correct option as your reference definition.";
        } else if (rationaleMode === "provided" && qq.rationale){
          rationaleText = qq.rationale;
        } else if (ok){
          rationaleText = "Matched the correct definition/claim.";
        } else {
          rationaleText = "Selected option is plausible but mismatched; align the term/stem to the correct definition/claim.";
        }
        rat.innerHTML = `<span class="k">Rationale: </span><span class="v">${rationaleText}</span>`;

        item.appendChild(top);
        item.appendChild(your);
        item.appendChild(cor);
        item.appendChild(rat);

        list.appendChild(item);
      }

      holder.appendChild(head);
      holder.appendChild(actions);
      holder.appendChild(list);
    }

    /********************
     * ETY/VOCAB: load bank, then require N + Generate
     ********************/
    const BANK_TXT_PATH = "ib_bio_clean_index.txt";
    const etyStatus = document.getElementById("etyStatus");
    const bankBar = document.getElementById("bankBar");
    const bankFile = document.getElementById("bankFile");
    const etyN = document.getElementById("etyN");
    const etyGenerate = document.getElementById("etyGenerate");
    const etyView = document.getElementById("etyView");

    hardenIntegerInput(etyN);

    let etyBank = [];
    let etyQuiz = null;

    function parseIndexText(text){
      const lines = (text || "").replace(/\r/g,"").split("\n");
      const items = [];
      let last = null;

      const dashRe = /^(.*?)\s*(?:—|–|-|:)\s*(.+)$/;
      const tabRe  = /^(.*?)\t+(.+)$/;

      for (let raw of lines){
        const line = raw.trimEnd();
        if (!line.trim()) continue;

        const h = line.trim().toLowerCase();
        if (h === "glossary" || h.startsWith("words in blue")) continue;

        if (/^\s+/.test(raw) && last){
          last.def = escapeSpaces(last.def + " " + line.trim());
          continue;
        }

        let m = line.match(tabRe);
        if (!m) m = line.match(dashRe);

        if (!m){
          const parts = line.split(/\s{2,}/);
          if (parts.length >= 2){
            const term = escapeSpaces(parts.shift());
            const def = escapeSpaces(parts.join(" "));
            if (term && def){
              last = { term, def };
              items.push(last);
            }
          }
          continue;
        }

        const term = escapeSpaces(m[1]);
        const def  = escapeSpaces(m[2]);
        if (!term || !def) continue;

        last = { term, def };
        items.push(last);
      }

      const map = new Map();
      for (const it of items){
        const k = it.term.toLowerCase();
        if (!map.has(k) || (map.get(k).def.length < it.def.length)){
          map.set(k, it);
        }
      }
      const out = Array.from(map.values()).filter(x => x.term.length >= 2 && x.def.length >= 6);
      out.sort((a,b)=> a.term.localeCompare(b.term));
      return out;
    }

    async function tryLoadBankViaFetch(){
      try{
        const r = await fetch(BANK_TXT_PATH, { cache:"no-store" });
        if (!r.ok) throw new Error("fetch not ok");
        const t = await r.text();
        const parsed = parseIndexText(t);
        if (!parsed.length) throw new Error("empty parse");
        return parsed;
      }catch(_){
        return null;
      }
    }

    function refreshEtyControls(){
      const raw = etyN.value;
      const n = clampInt(raw, 1, 100);
      const ready = etyBank.length > 0 && n !== null;
      etyGenerate.disabled = !ready;

      if (!etyBank.length){
        etyStatus.textContent = "Question bank not loaded.";
      } else {
        etyStatus.textContent = `Ready. Bank loaded: ${etyBank.length} terms.`;
      }
    }

    function makeEtyQuiz(n){
      const maxN = Math.min(100, etyBank.length);
      const nn = Math.min(n, maxN);

      const pool = etyBank.slice();
      shuffle(pool);
      const pick = pool.slice(0, nn);

      return pick.map((item) => {
        const others = [];
        while (others.length < 3){
          const cand = etyBank[Math.floor(Math.random() * etyBank.length)];
          if (!cand) continue;
          if (cand.term === item.term) continue;
          if (others.some(x => x.term === cand.term)) continue;
          others.push(cand);
        }
        const opts = [ item.def, others[0].def, others[1].def, others[2].def ];
        const idxs = [0,1,2,3];
        shuffle(idxs);
        const options = idxs.map(i => opts[i]);
        const correctIndex = options.indexOf(item.def);
        return { stem: item.term, options, correctIndex };
      });
    }

    function startEtyQuiz(){
      const n = clampInt(etyN.value, 1, 100);
      if (!etyBank.length || n === null) return;

      const questions = makeEtyQuiz(n);
      const holder = mkQuizUI(etyView);

      etyQuiz = {
        questions,
        idx: 0,
        answers: new Array(questions.length).fill(null),
        onExit: () => { etyView.innerHTML = ""; },
        onFinish: () => { renderSummary(holder, etyQuiz, "generic"); },
        onRetrySame: () => {
          etyQuiz.idx = 0;
          etyQuiz.answers = new Array(questions.length).fill(null);
          renderQuiz(holder, etyQuiz);
        },
        onNewQuiz: () => {
          etyView.innerHTML = "";
        }
      };

      renderQuiz(holder, etyQuiz);
    }

    etyN.addEventListener("input", refreshEtyControls);
    etyGenerate.addEventListener("click", startEtyQuiz);

    bankFile.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const t = await f.text();
      const parsed = parseIndexText(t);
      if (parsed.length){
        etyBank = parsed;
        bankBar.classList.remove("show");
      }else{
        etyBank = [];
      }
      refreshEtyControls();
      e.target.value = "";
    });

    (async function initBank(){
      const parsed = await tryLoadBankViaFetch();
      if (parsed){
        etyBank = parsed;
        bankBar.classList.remove("show");
      } else {
        bankBar.classList.add("show");
      }
      refreshEtyControls();
    })();

    /********************
     * CUSTOM JSON: require JSON load, then require N + Generate
     ********************/
    const customJson = document.getElementById("customJson");
    const customFile = document.getElementById("customFile");
    const customLoad = document.getElementById("customLoad");
    const customStatus = document.getElementById("customStatus");
    const customN = document.getElementById("customN");
    const customGenerate = document.getElementById("customGenerate");
    const customView = document.getElementById("customView");

    hardenIntegerInput(customN);

    let customBank = [];
    let customQuiz = null;

    function normalizeCustomJSON(obj){
      let arr = null;
      if (Array.isArray(obj)) arr = obj;
      else if (obj && Array.isArray(obj.questions)) arr = obj.questions;
      else if (obj && Array.isArray(obj.items)) arr = obj.items;
      if (!arr) return [];

      const out = [];
      for (const q of arr){
        if (!q) continue;
        const stem = escapeSpaces(q.stem || q.question || q.q || q.prompt || "");
        if (!stem) continue;

        let options = q.options || q.choices || q.answers || null;
        if (options && !Array.isArray(options) && typeof options === "object"){
          const keys = ["A","B","C","D"];
          const as = keys.map(k => options[k]).filter(Boolean);
          options = (as.length >= 4) ? as.slice(0,4) : Object.values(options);
        }
        if (!Array.isArray(options) || options.length < 4) continue;
        options = options.slice(0,4).map(x => escapeSpaces(String(x)));

        let ans = q.answer ?? q.correct ?? q.key ?? q.correctAnswer ?? null;
        let correctIndex = null;
        if (typeof ans === "number") correctIndex = ans;
        else if (typeof ans === "string"){
          const s = ans.trim().toUpperCase();
          if (["A","B","C","D"].includes(s)) correctIndex = ["A","B","C","D"].indexOf(s);
          else {
            const idx = options.indexOf(escapeSpaces(ans));
            if (idx >= 0) correctIndex = idx;
          }
        }
        if (correctIndex === null || correctIndex < 0 || correctIndex > 3) continue;

        const rationale = escapeSpaces(q.rationale || q.explanation || q.reason || "");
        out.push({ stem, options, correctIndex, rationale });
      }
      return out;
    }

    function refreshCustomControls(){
      const n = clampInt(customN.value, 1, 100);
      const ready = customBank.length > 0 && n !== null;
      customGenerate.disabled = !ready;
    }

    function loadCustomFromText(text){
      let obj = null;
      try{ obj = JSON.parse(text); }catch(_){ return null; }
      const norm = normalizeCustomJSON(obj);
      return norm.length ? norm : null;
    }

    function startCustomQuiz(){
      const n = clampInt(customN.value, 1, 100);
      if (!customBank.length || n === null) return;

      const maxN = Math.min(100, customBank.length);
      const nn = Math.min(n, maxN);

      const pool = customBank.slice();
      shuffle(pool);
      const questions = pool.slice(0, nn).map(q => ({
        stem: q.stem,
        options: q.options.slice(),
        correctIndex: q.correctIndex,
        rationale: q.rationale || ""
      }));

      const holder = mkQuizUI(customView);

      customQuiz = {
        questions,
        idx: 0,
        answers: new Array(questions.length).fill(null),
        onExit: () => { customView.innerHTML = ""; },
        onFinish: () => { renderSummary(holder, customQuiz, "provided"); },
        onRetrySame: () => {
          customQuiz.idx = 0;
          customQuiz.answers = new Array(questions.length).fill(null);
          renderQuiz(holder, customQuiz);
        },
        onNewQuiz: () => {
          customView.innerHTML = "";
        }
      };

      renderQuiz(holder, customQuiz);
    }

    customN.addEventListener("input", refreshCustomControls);
    customGenerate.addEventListener("click", startCustomQuiz);

    customFile.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const t = await f.text();
      const norm = loadCustomFromText(t);
      if (norm){
        customBank = norm;
        customStatus.textContent = `Loaded ${customBank.length} questions.`;
      }else{
        customBank = [];
        customStatus.textContent = "Invalid JSON or unsupported structure.";
      }
      customView.innerHTML = "";
      refreshCustomControls();
      e.target.value = "";
    });

    customLoad.addEventListener("click", () => {
      const t = (customJson.value || "").trim();
      if (!t){
        customStatus.textContent = "Awaiting JSON…";
        customBank = [];
        customView.innerHTML = "";
        refreshCustomControls();
        return;
      }
      const norm = loadCustomFromText(t);
      if (norm){
        customBank = norm;
        customStatus.textContent = `Loaded ${customBank.length} questions.`;
      }else{
        customBank = [];
        customStatus.textContent = "Invalid JSON or unsupported structure.";
      }
      customView.innerHTML = "";
      refreshCustomControls();
    });

    refreshCustomControls();
  </script>
</body>
</html>
