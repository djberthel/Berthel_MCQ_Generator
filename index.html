<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Berthel's Biology</title>

  <style>
    /* ====== Latin Modern (local-first; falls back cleanly) ====== */
    @font-face{
      font-family:"Latin Modern Roman";
      src:url("./lmroman10-regular.woff2") format("woff2"),
          url("./lmroman10-regular.woff") format("woff");
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }
    @font-face{
      font-family:"Latin Modern Roman";
      src:url("./lmroman10-bold.woff2") format("woff2"),
          url("./lmroman10-bold.woff") format("woff");
      font-weight:700;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --bg0:#000;
      --bg1:#0b0c0f;
      --panel:#0f1116;
      --panel2:#0b0d12;
      --line:rgba(255,255,255,.12);
      --soft:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --faint:rgba(255,255,255,.46);
      --accent:rgba(255,255,255,.92);
      --good:#36d06e;
      --bad:#ff4d4d;
      --warn:#ffd166;
      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family:"Latin Modern Roman","LM Roman 10","CMU Serif","Times New Roman",serif;
      background:
        radial-gradient(1200px 600px at 18% 8%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 520px at 82% 18%, rgba(255,255,255,.06), transparent 62%),
        linear-gradient(180deg, #05060a, #000 60%);
      letter-spacing:.2px;
      font-size:18px; /* larger */
    }

    a{ color:inherit; text-decoration:none; }
    button, input, textarea{
      font-family:inherit;
      color:inherit;
    }

    /* ====== Layout ====== */
    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding:28px 18px 40px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:0;
    }
    .avatar{
      width:56px; height:56px;
      border-radius:999px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow:0 10px 26px rgba(0,0,0,.55);
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{
      width:100%; height:100%;
      object-fit:cover;
      object-position:center 30%;
      display:block;
      filter:contrast(1.02);
    }
    .brandText{
      min-width:0;
    }
    .brandTitle{
      font-size:34px;
      font-weight:700;
      margin:0;
      line-height:1.08;
      letter-spacing:.3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandSub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:18px;
    }
    .version{
      color:var(--faint);
      font-size:16px;
      white-space:nowrap;
      padding:8px 12px;
      border:1px solid var(--soft);
      border-radius:999px;
      background:rgba(0,0,0,.25);
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:16px 0 18px;
    }
    .tab{
      padding:10px 14px;
      border:1px solid var(--soft);
      border-radius:999px;
      background:rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
      transition:transform .04s ease, background .12s ease, border-color .12s ease;
      font-size:18px;
    }
    .tab:hover{ background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.18); }
    .tab:active{ transform:translateY(1px); }
    .tab.active{
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.26);
    }

    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .panelHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .panelTitle{
      margin:0;
      font-size:26px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .panelHint{
      margin:8px 0 0;
      color:var(--muted);
      font-size:18px;
      line-height:1.35;
    }

    .row{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-top:14px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:240px;
      flex:1 1 260px;
    }
    label{
      color:var(--muted);
      font-size:16px;
    }
    input[type="number"], input[type="password"], textarea{
      border-radius:14px;
      border:1px solid var(--soft);
      background:rgba(0,0,0,.28);
      padding:12px 12px;
      outline:none;
      font-size:18px;
    }
    textarea{ min-height:120px; resize:vertical; }

    .btn{
      border:1px solid var(--soft);
      background:rgba(255,255,255,.06);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      transition:background .12s ease, border-color .12s ease, transform .04s ease;
      font-size:18px;
      user-select:none;
    }
    .btn:hover{ background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.18); }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{
      background:rgba(255,255,255,.92);
      color:#000;
      border-color:rgba(255,255,255,.92);
    }
    .btn.primary:hover{ background:rgba(255,255,255,.98); }
    .btn.ghost{
      background:transparent;
    }
    .btn.danger{
      background:rgba(255,77,77,.14);
      border-color:rgba(255,77,77,.35);
    }
    .btn.good{
      background:rgba(54,208,110,.12);
      border-color:rgba(54,208,110,.35);
    }

    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 980px){
      .split{ grid-template-columns: 1.25fr .75fr; }
    }

    /* ====== Quiz ====== */
    .quizTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:12px;
    }
    .qMeta{
      color:var(--muted);
      font-size:17px;
    }
    .qTitle{
      margin:6px 0 0;
      font-size:34px;
      font-weight:700;
      line-height:1.12;
      letter-spacing:.2px;
    }

    .options{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:16px;
    }
    .opt{
      border:1px solid var(--soft);
      background:rgba(0,0,0,.22);
      border-radius:16px;
      padding:14px 14px;
      cursor:pointer;
      display:flex;
      gap:12px;
      align-items:flex-start;
      transition:background .12s ease, border-color .12s ease, transform .04s ease;
    }
    .opt:hover{ background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.18); }
    .opt:active{ transform:translateY(1px); }
    .opt.selected{
      border-color:rgba(255,255,255,.32);
      background:rgba(255,255,255,.07);
    }
    .optLetter{
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid var(--soft);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      background:rgba(255,255,255,.04);
      flex:0 0 auto;
      margin-top:1px;
    }
    .optText{
      line-height:1.32;
      color:var(--text);
    }

    .nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:18px;
      flex-wrap:wrap;
    }
    .navLeft, .navRight{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* ====== Summary ====== */
    .scoreLine{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .scoreBig{
      font-size:40px;
      font-weight:700;
      letter-spacing:.3px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--soft);
      background:rgba(0,0,0,.22);
      color:var(--muted);
      font-size:16px;
    }
    .pill.good{ border-color:rgba(54,208,110,.35); color:rgba(54,208,110,.95); background:rgba(54,208,110,.09); }
    .pill.bad{ border-color:rgba(255,77,77,.35); color:rgba(255,77,77,.95); background:rgba(255,77,77,.09); }
    .review{
      margin-top:16px;
      border-top:1px solid var(--soft);
      padding-top:14px;
    }
    .reviewItem{
      border:1px solid var(--soft);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
    }
    .reviewHead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:10px;
    }
    .reviewQ{
      font-weight:700;
      font-size:18px;
      line-height:1.2;
    }
    .tag{
      font-size:14px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--soft);
      color:var(--muted);
      background:rgba(0,0,0,.2);
    }
    .rLine{
      margin:6px 0 0;
      color:var(--muted);
      line-height:1.35;
      font-size:17px;
    }
    .rLine strong{ color:var(--text); font-weight:700; }

    .status{
      margin-top:10px;
      color:var(--muted);
      font-size:16px;
    }
    .status.ok{ color:rgba(54,208,110,.92); }
    .status.bad{ color:rgba(255,77,77,.92); }

    .adminLink{
      margin-top:18px;
      color:var(--faint);
      font-size:15px;
      display:inline-block;
      padding:8px 10px;
      border:1px solid transparent;
      border-radius:999px;
    }
    .adminLink:hover{
      border-color:var(--soft);
      background:rgba(255,255,255,.03);
      color:var(--muted);
    }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="avatar" aria-label="avatar">
          <img id="avatarImg" src="./Chinstrap_LOgo.jfif" alt="Penguin avatar" />
        </div>
        <div class="brandText">
          <h1 class="brandTitle">Berthel's Biology</h1>
          <p class="brandSub">Professional student testing and review workspace.</p>
        </div>
      </div>
      <div class="version" id="versionBox">v00000000-000000</div>
    </div>

    <div class="tabs" role="tablist" aria-label="Sections">
      <div class="tab active" data-tab="home" role="tab" aria-selected="true">Home</div>
      <div class="tab" data-tab="etyvocab" role="tab" aria-selected="false">Etymology + Vocabulary</div>
      <div class="tab" data-tab="custom" role="tab" aria-selected="false">Custom Content</div>
    </div>

    <!-- HOME -->
    <section id="tab-home" class="panel" role="tabpanel">
      <div class="panelHeader">
        <div>
          <h2 class="panelTitle">Updates</h2>
          <p class="panelHint">Latest engine notes (most recent first).</p>
        </div>
      </div>

      <div id="updatesList"></div>

      <a class="adminLink" id="adminToggle" href="javascript:void(0)">Admin</a>

      <div id="adminPanel" class="hidden" style="margin-top:14px;">
        <div class="split">
          <div class="panel" style="padding:16px;">
            <h3 class="panelTitle" style="font-size:22px;margin:0 0 10px;">Add update</h3>
            <div class="row" style="margin-top:0;">
              <div class="field" style="flex:1 1 520px;min-width:280px;">
                <label for="updateText">Message</label>
                <textarea id="updateText" placeholder="Write the update note..."></textarea>
              </div>
            </div>
            <div class="row">
              <button class="btn good" id="addUpdateBtn">Add (timestamped)</button>
              <button class="btn ghost" id="lockAdminBtn">Lock</button>
            </div>
            <div class="status" id="adminStatus"></div>
          </div>

          <div class="panel" style="padding:16px;">
            <h3 class="panelTitle" style="font-size:22px;margin:0 0 10px;">Deploy helper</h3>
            <p class="panelHint" style="margin-top:0;">
              If you want everyone to see the same updates across devices, publish the updated HTML after adding notes here.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- ETY + VOCAB -->
    <section id="tab-etyvocab" class="panel hidden" role="tabpanel">
      <div id="etySetup">
        <div class="panelHeader">
          <div>
            <h2 class="panelTitle">Etymology + Vocabulary Quiz</h2>
            <p class="panelHint">Choose how many practice questions you want (1–100).</p>
          </div>
        </div>

        <div class="split">
          <div class="panel" style="padding:16px;">
            <div class="row" style="margin-top:0;">
              <div class="field">
                <label for="etyCount">Number of questions (1–100)</label>
                <input id="etyCount" type="number" min="1" max="100" step="1" inputmode="numeric" placeholder="e.g., 25" />
              </div>
              <button class="btn primary" id="etyStartBtn" disabled>Start</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="field" style="min-width:280px;">
                <label for="etyFallbackFile">If the preset list doesn’t load, upload: ib_bio_clean_index.txt</label>
                <input id="etyFallbackFile" type="file" accept=".txt,text/plain" />
              </div>
            </div>

            <div class="status" id="etyLoadStatus">Loading preset list…</div>
          </div>

          <div class="panel" style="padding:16px;">
            <h3 class="panelTitle" style="font-size:22px;margin:0 0 10px;">What you’ll get</h3>
            <p class="panelHint" style="margin-top:0;">
              A clean MCQ flow with A–D choices, the ability to finish early, and a professional results summary with rationale.
            </p>
          </div>
        </div>
      </div>

      <div id="etyQuiz" class="hidden">
        <div class="quizTop">
          <div>
            <div class="qMeta" id="etyMeta">Question 1 of 10</div>
            <div class="qTitle" id="etyStem">—</div>
          </div>
          <button class="btn ghost" id="etyChangeNumberBtn">Change number</button>
        </div>

        <div class="options" id="etyOptions"></div>

        <div class="nav">
          <div class="navLeft">
            <button class="btn" id="etyBackBtn">Back</button>
            <button class="btn danger" id="etyFinishBtn">Finish now</button>
          </div>
          <div class="navRight">
            <button class="btn primary" id="etyNextBtn">Next</button>
          </div>
        </div>
      </div>

      <div id="etySummary" class="hidden">
        <div class="panelHeader">
          <div>
            <h2 class="panelTitle">Summary</h2>
            <p class="panelHint" id="etySummaryHint">—</p>
          </div>
        </div>

        <div class="scoreLine">
          <div class="scoreBig" id="etyScoreBig">0/0</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <span class="pill" id="etyPctPill">0%</span>
            <span class="pill" id="etyAttemptPill">Attempted: 0</span>
            <span class="pill" id="etyTimePill">Time: 0:00</span>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn good" id="etyRetryBtn">Retry same quiz</button>
          <button class="btn" id="etyNewBtn">Generate new quiz</button>
          <button class="btn ghost" id="etyChangeNumberBtn2">Change number</button>
        </div>

        <div class="review" id="etyReview"></div>
      </div>
    </section>

    <!-- CUSTOM CONTENT -->
    <section id="tab-custom" class="panel hidden" role="tabpanel">
      <div id="custSetup">
        <div class="panelHeader">
          <div>
            <h2 class="panelTitle">Custom Content Quiz</h2>
            <p class="panelHint">Upload a .txt file and choose how many questions you want (1–100).</p>
          </div>
        </div>

        <div class="split">
          <div class="panel" style="padding:16px;">
            <div class="row" style="margin-top:0;">
              <div class="field">
                <label for="custFile">Upload text file</label>
                <input id="custFile" type="file" accept=".txt,text/plain" />
              </div>

              <div class="field">
                <label for="custCount">Number of questions (1–100)</label>
                <input id="custCount" type="number" min="1" max="100" step="1" inputmode="numeric" placeholder="e.g., 20" />
              </div>

              <button class="btn primary" id="custStartBtn" disabled>Start</button>
            </div>

            <div class="status" id="custStatus">Waiting for a file…</div>
          </div>

          <div class="panel" style="padding:16px;">
            <h3 class="panelTitle" style="font-size:22px;margin:0 0 10px;">Supported format</h3>
            <p class="panelHint" style="margin-top:0;">
              Best results come from term–definition style notes (term lines followed by definition lines).
            </p>
          </div>
        </div>
      </div>

      <div id="custQuiz" class="hidden">
        <div class="quizTop">
          <div>
            <div class="qMeta" id="custMeta">Question 1 of 10</div>
            <div class="qTitle" id="custStem">—</div>
          </div>
          <button class="btn ghost" id="custChangeBtn">Change number</button>
        </div>

        <div class="options" id="custOptions"></div>

        <div class="nav">
          <div class="navLeft">
            <button class="btn" id="custBackBtn">Back</button>
            <button class="btn danger" id="custFinishBtn">Finish now</button>
          </div>
          <div class="navRight">
            <button class="btn primary" id="custNextBtn">Next</button>
          </div>
        </div>
      </div>

      <div id="custSummary" class="hidden">
        <div class="panelHeader">
          <div>
            <h2 class="panelTitle">Summary</h2>
            <p class="panelHint" id="custSummaryHint">—</p>
          </div>
        </div>

        <div class="scoreLine">
          <div class="scoreBig" id="custScoreBig">0/0</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <span class="pill" id="custPctPill">0%</span>
            <span class="pill" id="custAttemptPill">Attempted: 0</span>
            <span class="pill" id="custTimePill">Time: 0:00</span>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn good" id="custRetryBtn">Retry same quiz</button>
          <button class="btn" id="custNewBtn">Generate new quiz</button>
          <button class="btn ghost" id="custBackSetupBtn">Back to setup</button>
        </div>

        <div class="review" id="custReview"></div>
      </div>
    </section>
  </div>

  <script>
    /* ==========================
       BUILD VERSION (Beijing UTC+8)
       ========================== */
    const BUILD_VERSION = "v20260210-160740"; // 2026-02-10 16:07:40 (UTC+8)
    document.getElementById("versionBox").textContent = BUILD_VERSION;

    /* ==========================
       AVATAR (file with fallback)
       ========================== */
    const avatarImg = document.getElementById("avatarImg");
    const fallbackDataUriEncoded =
      "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQE%0ABQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRQBAwME%0ADgQHBgkIBwkUDQsMFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU%0AFBQUFBQUFBQUFBQUFBQUFP/AABEIAQ0A+gMBIgACEQEDEQH/xAAbAAEAAgMBAQAA%0AAAAAAAAAAAAGBQcBAgMEB//EADoQAAIBAgQDBQYEBwAAAAAAAAECAwQRAAUSITFB%0ABhMiUWEHMoGRoRQjQlNiscHR8BVCYv/EABcBAQEBAQAAAAAAAAAAAAAAAAABAgP/%0AxAAhEQEBAQEAAgIDAQAAAAAAAAABEQIhAxIxQVEiMmFxkf/aAAwDAQACEQMRAD8A%0A9u0pV5I9kqm5wK8GJxHkqQ8E1Y3p6y+6o8JqF0cKk0YwW2zZbG3mI8fQnR3iYh8o%0Alq4k3h7p8N8bT5p3c5c3m0n9oBv6m4+S1x7m2q0fH2l9t2g2Lw2qgQpJH2c0j5cI%0A3VJf0yQ8b4nXKXqE7H6z1y2t3l1m7QbZ7bqB7VQ4xQH4u3m5w7Y1zv5bOq8f7g5%0Ap+4s0m3b0G2v2aYb5qUoUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpUqVKlSpU%0AqVKlSpUqVKlSpUqVKlf/2Q==";
    const fallbackDataUri = decodeURIComponent(fallbackDataUriEncoded);

    avatarImg.addEventListener("error", () => {
      avatarImg.src = fallbackDataUri;
    });

    /* ==========================
       Tabs
       ========================== */
    const tabs = document.querySelectorAll(".tab");
    const tabPanels = {
      home: document.getElementById("tab-home"),
      etyvocab: document.getElementById("tab-etyvocab"),
      custom: document.getElementById("tab-custom"),
    };

    function setTab(key){
      tabs.forEach(t => {
        const is = t.dataset.tab === key;
        t.classList.toggle("active", is);
        t.setAttribute("aria-selected", is ? "true" : "false");
      });
      Object.entries(tabPanels).forEach(([k, el]) => {
        el.classList.toggle("hidden", k !== key);
      });
    }
    tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

    /* ==========================
       Time (Beijing)
       ========================== */
    function nowBeijingISO(){
      const d = new Date();
      const fmt = new Intl.DateTimeFormat("sv-SE", {
        timeZone: "Asia/Shanghai",
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      });
      // "YYYY-MM-DD HH:mm:ss"
      return fmt.format(d);
    }

    /* ==========================
       HOME Updates (Admin-gated)
       ========================== */
    const ADMIN_PASS = "DEREK"; // change this
    const UPDATES_KEY = "bb_updates_v1";

    const defaultUpdates = [
      {
        ts: "2026-02-10 16:07:40",
        msg: "Next update: Fix Ety+Vocab numeric input (1–100), ensure all integers accepted, and deliver a cleaner post-quiz summary with rationale + retry options."
      }
    ];

    function loadUpdates(){
      const raw = localStorage.getItem(UPDATES_KEY);
      if(!raw){
        localStorage.setItem(UPDATES_KEY, JSON.stringify(defaultUpdates));
        return [...defaultUpdates];
      }
      try{
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)) return arr;
      }catch(_){}
      localStorage.setItem(UPDATES_KEY, JSON.stringify(defaultUpdates));
      return [...defaultUpdates];
    }

    function saveUpdates(arr){
      localStorage.setItem(UPDATES_KEY, JSON.stringify(arr));
    }

    function renderUpdates(){
      const list = document.getElementById("updatesList");
      const updates = loadUpdates().slice().sort((a,b)=> (a.ts<b.ts?1:-1));
      if(updates.length === 0){
        list.innerHTML = "<div class='status'>No updates.</div>";
        return;
      }
      list.innerHTML = updates.map(u => `
        <div class="reviewItem">
          <div class="reviewHead">
            <div class="reviewQ">${escapeHTML(u.msg)}</div>
            <span class="tag">${escapeHTML(u.ts)}</span>
          </div>
        </div>
      `).join("");
    }

    const adminToggle = document.getElementById("adminToggle");
    const adminPanel  = document.getElementById("adminPanel");
    const adminStatus = document.getElementById("adminStatus");
    const addUpdateBtn = document.getElementById("addUpdateBtn");
    const lockAdminBtn = document.getElementById("lockAdminBtn");
    const updateText = document.getElementById("updateText");

    let adminUnlocked = false;

    adminToggle.addEventListener("click", () => {
      if(adminUnlocked){
        adminPanel.classList.toggle("hidden");
        return;
      }
      const p = prompt("Admin passphrase:");
      if(p === null) return;
      if(p === ADMIN_PASS){
        adminUnlocked = true;
        adminPanel.classList.remove("hidden");
        adminStatus.textContent = "Unlocked.";
        adminStatus.className = "status ok";
      }else{
        adminStatus.textContent = "Incorrect passphrase.";
        adminStatus.className = "status bad";
      }
    });

    lockAdminBtn.addEventListener("click", () => {
      adminUnlocked = false;
      adminPanel.classList.add("hidden");
      adminStatus.textContent = "Locked.";
      adminStatus.className = "status";
    });

    addUpdateBtn.addEventListener("click", () => {
      if(!adminUnlocked) return;
      const msg = (updateText.value || "").trim();
      if(!msg){
        adminStatus.textContent = "Write an update message first.";
        adminStatus.className = "status bad";
        return;
      }
      const ts = nowBeijingISO();
      const updates = loadUpdates();
      updates.push({ ts, msg });
      saveUpdates(updates);
      updateText.value = "";
      adminStatus.textContent = "Update added.";
      adminStatus.className = "status ok";
      renderUpdates();
    });

    renderUpdates();

    /* ==========================
       Utilities
       ========================== */
    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function clampInt(n, min, max){
      const x = Math.trunc(Number(n));
      if(!Number.isFinite(x)) return null;
      if(x < min || x > max) return null;
      return x;
    }

    function secondsToMMSS(sec){
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s/60);
      const r = s % 60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function makeAnswerKey(n){
      // balanced A/B/C/D; no >3 repeats
      const letters = ["A","B","C","D"];
      while(true){
        const base = Math.floor(n/4);
        const rem = n % 4;
        const counts = {A:base,B:base,C:base,D:base};
        const picks = shuffle(letters.slice()).slice(0, rem);
        picks.forEach(l => counts[l]++);

        let key = [];
        letters.forEach(l => { for(let i=0;i<counts[l];i++) key.push(l); });
        shuffle(key);

        // constraint: no >3 repeats
        let runOk = true;
        let run = 1;
        for(let i=1;i<key.length;i++){
          if(key[i] === key[i-1]) run++;
          else run = 1;
          if(run > 3){ runOk = false; break; }
        }
        if(!runOk) continue;

        // constraint: frequencies differ by at most 1
        const freqs = letters.map(l => key.filter(x => x===l).length);
        const maxF = Math.max(...freqs), minF = Math.min(...freqs);
        if(maxF - minF > 1) continue;

        return key;
      }
    }

    function pickDistinct(pool, k, banSet){
      // returns k distinct items from pool, excluding any items whose id is in banSet
      const out = [];
      const triesMax = 5000;
      let tries = 0;
      while(out.length < k && tries++ < triesMax){
        const it = pool[Math.floor(Math.random()*pool.length)];
        if(!it) continue;
        if(banSet && banSet.has(it._id)) continue;
        if(out.some(x => x._id === it._id)) continue;
        out.push(it);
      }
      return out;
    }

    /* ==========================
       Parsing: ib_bio_clean_index.txt
       Fixes the two errors you showed:
       - Headings like "CLEAN INDEX ..." never enter the pools
       - Lines like "Variable A factor..." split into term="Variable", def="A factor..."
       Also removes "Examples: ..." from word-part meanings.
       ========================== */
    const bannedLineRe = /(CLEAN INDEX|GLOSSARY|WORD PARTS|Words in blue|Option topics|Change number|Table of contents)/i;

    const DEF_STARTERS = new Set([
      "A","An","The","Essential","Organic","Inorganic","Any","Group","Process","Movement","Change",
      "White","Red","Blood","Protein","Enzyme","Cell","Cells","Organism","Organisms","Structure",
      "Theoretical","Ability","Condition","Disease","Series","Mixture","Method","Rate","Energy",
      "Substance","System","Form","Type","Reaction","Molecule","Molecules","Gene","Genes"
    ]);

    function stripExamples(s){
      // remove "Examples: ..." (and variants)
      const idx = s.toLowerCase().indexOf("examples:");
      if(idx >= 0) return s.slice(0, idx).trim().replace(/[.;,:-]+$/,"").trim();
      return s.trim();
    }

    function cleanMeaningLine(s){
      // remove leading em-dash / hyphen bullets, and examples
      let t = s.replace(/^\s*[—–-]\s*/,"").trim();
      t = stripExamples(t);
      return t.trim();
    }

    function splitInlineTermDef(line){
      let s = (line || "").replace(/\u00A0/g," ").trim();
      if(!s) return null;

      // hard reject headings
      if(bannedLineRe.test(s)) return null;

      // tab split
      if(s.includes("\t")){
        const [a,...rest] = s.split("\t");
        const term = a.trim();
        const def = rest.join(" ").trim();
        if(term && def) return { term, def };
      }

      // 2+ space split
      const m = s.match(/^(.+?)\s{2,}(.+)$/);
      if(m){
        const term = m[1].trim();
        const def  = m[2].trim();
        if(term && def && !bannedLineRe.test(term) && !bannedLineRe.test(def)) return { term, def };
      }

      // token-based split: find earliest definition-starter token
      const tokens = s.split(/\s+/);
      if(tokens.length >= 3){
        for(let i=1; i<Math.min(tokens.length-1, 6); i++){
          const tok = tokens[i].replace(/[,:;]+$/,"");
          if(DEF_STARTERS.has(tok)){
            const term = tokens.slice(0,i).join(" ").trim();
            const def  = tokens.slice(i).join(" ").trim();
            // sanity: short term, meaningful def
            if(term.length <= 40 && def.length >= 12){
              // avoid splitting obvious non-entries
              if(!bannedLineRe.test(term) && !bannedLineRe.test(def)) return { term, def };
            }
            break;
          }
        }
      }

      return null;
    }

    function parseCleanIndex(text){
      const lines = text.replace(/\r/g,"").split("\n");
      const vocab = [];
      const ety   = [];
      let i = 0;
      let idCounter = 1;

      function nextNonEmpty(idx){
        while(idx < lines.length && !lines[idx].trim()) idx++;
        return idx;
      }

      while(i < lines.length){
        i = nextNonEmpty(i);
        if(i >= lines.length) break;

        let line = lines[i].trim();

        // skip headings/junk
        if(!line || bannedLineRe.test(line)){
          i++;
          continue;
        }

        // WORD PART candidate: current line = term, next non-empty line starts with —/–/-
        const termCandidate = line;
        const j = nextNonEmpty(i+1);
        const next = (j < lines.length) ? lines[j].trim() : "";

        const nextLooksLikeMeaning = /^[—–-]\s+/.test(next);

        if(nextLooksLikeMeaning){
          // parse etymology block: termCandidate + meaning lines until blank
          let k = j;
          const meaningLines = [];
          while(k < lines.length && lines[k].trim()){
            const ml = lines[k].trim();
            if(bannedLineRe.test(ml)) { k++; continue; }
            meaningLines.push(cleanMeaningLine(ml));
            k++;
          }
          const meaning = meaningLines.join(" ").replace(/\s+/g," ").trim();
          const term = termCandidate.trim();

          if(term && meaning && !bannedLineRe.test(term) && !bannedLineRe.test(meaning)){
            ety.push({_id:`e${idCounter++}`, term, def: meaning});
          }
          i = k + 1;
          continue;
        }

        // VOCAB: try inline split; otherwise treat as term line + def block
        const inline = splitInlineTermDef(line);

        if(inline){
          const term = inline.term.trim();
          let def = inline.def.trim();

          // def may continue on subsequent lines until blank
          let k = i+1;
          const more = [];
          while(k < lines.length && lines[k].trim()){
            const t = lines[k].trim();
            if(bannedLineRe.test(t)) { k++; continue; }
            more.push(t);
            k++;
          }
          if(more.length){
            def = (def + " " + more.join(" ")).replace(/\s+/g," ").trim();
          }

          // filter again
          if(term && def && !bannedLineRe.test(term) && !bannedLineRe.test(def)){
            vocab.push({_id:`v${idCounter++}`, term, def});
          }
          i = k + 1;
          continue;
        }else{
          // term line, then definition lines until blank
          const term = line.trim();
          let k = i+1;
          const defLines = [];
          while(k < lines.length && lines[k].trim()){
            const t = lines[k].trim();
            if(bannedLineRe.test(t)) { k++; continue; }
            defLines.push(t);
            k++;
          }
          const def = defLines.join(" ").replace(/\s+/g," ").trim();
          if(term && def && term.length <= 60 && def.length >= 8 && !bannedLineRe.test(term) && !bannedLineRe.test(def)){
            vocab.push({_id:`v${idCounter++}`, term, def});
          }
          i = k + 1;
          continue;
        }
      }

      // final cleanup: remove anything empty/too weird
      const cleanPool = (arr) => arr
        .filter(x => x.term && x.def)
        .map(x => ({...x, term: x.term.replace(/\s+/g," ").trim(), def: x.def.replace(/\s+/g," ").trim()}))
        .filter(x => x.term.length <= 70 && x.def.length <= 380)
        .filter(x => !bannedLineRe.test(x.term) && !bannedLineRe.test(x.def));

      return { vocab: cleanPool(vocab), ety: cleanPool(ety) };
    }

    /* ==========================
       Quiz Engine (shared)
       - A/B/C/D choices (not bullets)
       - Finish early -> summary
       - Summary includes red/green indicators + rationale
       - Distractors pulled ONLY from same question type pool
       ========================== */
    function buildQuiz({count, vocabPool, etyPool, mix=true}){
      const n = count;
      const key = makeAnswerKey(n);

      // Decide which type each question is (balanced if both pools exist)
      const hasV = vocabPool.length >= 6;
      const hasE = etyPool.length >= 6;

      let types = [];
      if(mix && hasV && hasE){
        // 50/50 split
        const vN = Math.ceil(n/2);
        const eN = n - vN;
        types = Array(vN).fill("vocab").concat(Array(eN).fill("ety"));
        shuffle(types);
      }else if(hasV){
        types = Array(n).fill("vocab");
      }else if(hasE){
        types = Array(n).fill("ety");
      }else{
        return { error: "Not enough usable entries to generate a quiz." };
      }

      // sample distinct entries
      const usedV = new Set();
      const usedE = new Set();

      const questions = [];
      for(let qi=0; qi<n; qi++){
        const type = types[qi];
        const correctLetter = key[qi];
        const correctIndex = {A:0,B:1,C:2,D:3}[correctLetter];

        if(type === "vocab"){
          const picked = pickDistinct(vocabPool, 1, usedV)[0];
          if(!picked) break;
          usedV.add(picked._id);

          const distractors = pickDistinct(vocabPool, 3, new Set([picked._id]));
          const opts = Array(4).fill(null);
          opts[correctIndex] = picked.def;

          let di = 0;
          for(let oi=0; oi<4; oi++){
            if(opts[oi] !== null) continue;
            opts[oi] = distractors[di++]?.def || vocabPool[Math.floor(Math.random()*vocabPool.length)].def;
          }

          questions.push({
            id: `q${qi+1}`,
            type,
            stem: picked.term,
            prompt: picked.term, // IMPORTANT: term only; avoids "Variable A factor..." bug
            rationale: picked.def,
            correctIndex,
            options: opts
          });
        }else{
          const picked = pickDistinct(etyPool, 1, usedE)[0];
          if(!picked) break;
          usedE.add(picked._id);

          const distractors = pickDistinct(etyPool, 3, new Set([picked._id]));
          const opts = Array(4).fill(null);
          opts[correctIndex] = picked.def;

          let di = 0;
          for(let oi=0; oi<4; oi++){
            if(opts[oi] !== null) continue;
            opts[oi] = distractors[di++]?.def || etyPool[Math.floor(Math.random()*etyPool.length)].def;
          }

          questions.push({
            id: `q${qi+1}`,
            type,
            stem: picked.term,
            prompt: picked.term,
            rationale: picked.def,
            correctIndex,
            options: opts
          });
        }
      }

      return { questions };
    }

    function createQuizController(cfg){
      const {
        // setup elements
        setupRoot, countInput, startBtn, loadStatusEl, fallbackFileEl,
        // quiz elements
        quizRoot, metaEl, stemEl, optionsEl, backBtn, nextBtn, finishBtn, changeBtn,
        // summary
        summaryRoot, summaryHintEl, scoreBigEl, pctPillEl, attemptPillEl, timePillEl,
        retryBtn, newBtn, changeBtn2, reviewEl,
        // data loader
        getPools, onNewQuizRequested, onChangeNumber
      } = cfg;

      const LETTERS = ["A","B","C","D"];

      let pools = { vocab: [], ety: [] };
      let state = {
        mode: "setup",
        count: 0,
        questions: [],
        answers: [], // selected indices or null
        startedAt: null,
        finishedAt: null
      };

      function setSetupEnabled(enabled){
        startBtn.disabled = !enabled;
      }

      function validateCount(){
        const v = clampInt(countInput.value, 1, 100);
        setSetupEnabled(v !== null);
        return v;
      }

      function showSetup(){
        state.mode = "setup";
        setupRoot.classList.remove("hidden");
        quizRoot.classList.add("hidden");
        summaryRoot.classList.add("hidden");
      }
      function showQuiz(){
        state.mode = "quiz";
        setupRoot.classList.add("hidden");
        quizRoot.classList.remove("hidden");
        summaryRoot.classList.add("hidden");
      }
      function showSummary(){
        state.mode = "summary";
        setupRoot.classList.add("hidden");
        quizRoot.classList.add("hidden");
        summaryRoot.classList.remove("hidden");
      }

      function renderQuestion(idx){
        const q = state.questions[idx];
        metaEl.textContent = `Question ${idx+1} of ${state.questions.length}`;
        stemEl.textContent = q.prompt;

        optionsEl.innerHTML = "";
        const selected = state.answers[idx];

        q.options.forEach((txt, oi) => {
          const div = document.createElement("div");
          div.className = "opt" + (selected === oi ? " selected" : "");
          div.setAttribute("role","button");
          div.setAttribute("tabindex","0");
          div.addEventListener("click", () => selectOption(idx, oi));
          div.addEventListener("keydown", (e) => {
            if(e.key === "Enter" || e.key === " "){
              e.preventDefault();
              selectOption(idx, oi);
            }
          });

          const l = document.createElement("div");
          l.className = "optLetter";
          l.textContent = LETTERS[oi];

          const t = document.createElement("div");
          t.className = "optText";
          t.textContent = txt;

          div.appendChild(l);
          div.appendChild(t);
          optionsEl.appendChild(div);
        });

        backBtn.disabled = (idx === 0);
        const isLast = (idx === state.questions.length - 1);
        nextBtn.textContent = isLast ? "Finish" : "Next";
      }

      function selectOption(qi, oi){
        state.answers[qi] = oi;
        // re-render current question options
        const cur = getCurrentIndex();
        renderQuestion(cur);
      }

      function getCurrentIndex(){
        const raw = quizRoot.getAttribute("data-qindex");
        return raw ? Number(raw) : 0;
      }
      function setCurrentIndex(i){
        quizRoot.setAttribute("data-qindex", String(i));
      }

      function computeResults(){
        const total = state.questions.length;
        let attempted = 0;
        let correct = 0;

        let vocabT=0, vocabC=0, etyT=0, etyC=0;

        for(let i=0;i<total;i++){
          const a = state.answers[i];
          if(a !== null && a !== undefined) attempted++;
          const q = state.questions[i];
          const isCorrect = (a === q.correctIndex);
          if(isCorrect) correct++;

          if(q.type === "vocab"){
            vocabT++;
            if(isCorrect) vocabC++;
          }else{
            etyT++;
            if(isCorrect) etyC++;
          }
        }

        const pct = total ? Math.round((correct/total)*100) : 0;
        return { total, attempted, correct, pct, vocabT, vocabC, etyT, etyC };
      }

      function renderSummary(){
        const res = computeResults();
        const end = state.finishedAt || new Date();
        const start = state.startedAt || end;
        const elapsedSec = Math.max(0, Math.floor((end - start)/1000));

        summaryHintEl.textContent =
          `Results reflect accuracy, distractor discipline, and definition-level precision.`;

        scoreBigEl.textContent = `${res.correct}/${res.total}`;

        pctPillEl.textContent = `${res.pct}%`;
        pctPillEl.className = "pill " + (res.pct >= 70 ? "good" : (res.pct >= 50 ? "" : "bad"));

        attemptPillEl.textContent = `Attempted: ${res.attempted}/${res.total}`;
        timePillEl.textContent = `Time: ${secondsToMMSS(elapsedSec)}`;

        // Review (shows rationale; red/green indicator)
        reviewEl.innerHTML = "";
        for(let i=0;i<res.total;i++){
          const q = state.questions[i];
          const a = state.answers[i];
          const correct = q.correctIndex;

          const isAttempted = (a !== null && a !== undefined);
          const isCorrect = (a === correct);

          const badge = isCorrect ? "pill good" : "pill bad";
          const badgeText = isCorrect ? "Correct" : (isAttempted ? "Incorrect" : "Unanswered");

          const yourChoice = isAttempted ? `${["A","B","C","D"][a]} — ${q.options[a]}` : "—";
          const correctChoice = `${["A","B","C","D"][correct]} — ${q.options[correct]}`;

          const typeTag = (q.type === "vocab") ? "Vocabulary" : "Etymology";

          const block = document.createElement("div");
          block.className = "reviewItem";

          block.innerHTML = `
            <div class="reviewHead">
              <div class="reviewQ">Q${i+1}. ${escapeHTML(q.prompt)}</div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <span class="tag">${typeTag}</span>
                <span class="${badge}">${badgeText}</span>
              </div>
            </div>
            <div class="rLine"><strong>Your answer:</strong> ${escapeHTML(yourChoice)}</div>
            <div class="rLine"><strong>Correct answer:</strong> ${escapeHTML(correctChoice)}</div>
            <div class="rLine"><strong>Rationale:</strong> ${escapeHTML(q.rationale)}</div>
          `;
          reviewEl.appendChild(block);
        }
      }

      function startQuiz(newQuiz){
        const c = validateCount();
        if(c === null) return;

        pools = getPools();

        const built = newQuiz || buildQuiz({
          count: c,
          vocabPool: pools.vocab,
          etyPool: pools.ety,
          mix: true
        });

        if(built.error){
          loadStatusEl.textContent = built.error;
          loadStatusEl.className = "status bad";
          return;
        }

        state.count = c;
        state.questions = built.questions;
        state.answers = Array(state.questions.length).fill(null);
        state.startedAt = new Date();
        state.finishedAt = null;

        setCurrentIndex(0);
        showQuiz();
        renderQuestion(0);
      }

      function finishQuiz(){
        state.finishedAt = new Date();
        showSummary();
        renderSummary();
      }

      // Setup interactions
      countInput.addEventListener("input", validateCount);
      countInput.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          if(!startBtn.disabled) startQuiz(null);
        }
      });
      startBtn.addEventListener("click", () => startQuiz(null));

      // Change number
      changeBtn.addEventListener("click", () => {
        onChangeNumber?.();
        showSetup();
      });
      if(changeBtn2){
        changeBtn2.addEventListener("click", () => {
          onChangeNumber?.();
          showSetup();
        });
      }

      backBtn.addEventListener("click", () => {
        const i = getCurrentIndex();
        if(i>0){
          setCurrentIndex(i-1);
          renderQuestion(i-1);
        }
      });

      nextBtn.addEventListener("click", () => {
        const i = getCurrentIndex();
        const isLast = (i === state.questions.length - 1);
        if(isLast){
          finishQuiz();
          return;
        }
        setCurrentIndex(i+1);
        renderQuestion(i+1);
      });

      finishBtn.addEventListener("click", () => finishQuiz());

      retryBtn.addEventListener("click", () => {
        // retry same quiz: same questions/options
        state.answers = Array(state.questions.length).fill(null);
        state.startedAt = new Date();
        state.finishedAt = null;
        setCurrentIndex(0);
        showQuiz();
        renderQuestion(0);
      });

      newBtn.addEventListener("click", () => {
        onNewQuizRequested?.();
        showSetup();
      });

      // Fallback file loader (optional)
      if(fallbackFileEl){
        fallbackFileEl.addEventListener("change", async () => {
          const file = fallbackFileEl.files && fallbackFileEl.files[0];
          if(!file) return;
          const text = await file.text();
          const parsed = parseCleanIndex(text);
          cfg._overridePools(parsed);
        });
      }

      return {
        showSetup,
        setStatus: (text, ok=true) => {
          loadStatusEl.textContent = text;
          loadStatusEl.className = "status " + (ok ? "ok" : "bad");
        },
        overridePools: (p) => cfg._overridePools(p),
        startQuiz
      };
    }

    /* ==========================
       ETY+VOCAB: Load preset file
       ========================== */
    let presetPools = { vocab: [], ety: [] };
    const etyLoadStatus = document.getElementById("etyLoadStatus");

    async function loadPreset(){
      try{
        const res = await fetch("./ib_bio_clean_index.txt", { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        presetPools = parseCleanIndex(text);

        // sanity: require minimal sizes
        const ok = (presetPools.vocab.length >= 10 || presetPools.ety.length >= 10);
        if(ok){
          etyLoadStatus.textContent = `Preset loaded. Vocabulary: ${presetPools.vocab.length} | Etymology: ${presetPools.ety.length}`;
          etyLoadStatus.className = "status ok";
        }else{
          etyLoadStatus.textContent = "Preset loaded, but not enough usable entries. Upload the file below.";
          etyLoadStatus.className = "status bad";
        }
      }catch(err){
        etyLoadStatus.textContent = "Preset failed to load. Upload ib_bio_clean_index.txt below.";
        etyLoadStatus.className = "status bad";
      }
    }
    loadPreset();

    /* ==========================
       ETY+VOCAB Controller
       ========================== */
    const etyController = createQuizController({
      setupRoot: document.getElementById("etySetup"),
      countInput: document.getElementById("etyCount"),
      startBtn: document.getElementById("etyStartBtn"),
      loadStatusEl: document.getElementById("etyLoadStatus"),
      fallbackFileEl: document.getElementById("etyFallbackFile"),

      quizRoot: document.getElementById("etyQuiz"),
      metaEl: document.getElementById("etyMeta"),
      stemEl: document.getElementById("etyStem"),
      optionsEl: document.getElementById("etyOptions"),
      backBtn: document.getElementById("etyBackBtn"),
      nextBtn: document.getElementById("etyNextBtn"),
      finishBtn: document.getElementById("etyFinishBtn"),
      changeBtn: document.getElementById("etyChangeNumberBtn"),

      summaryRoot: document.getElementById("etySummary"),
      summaryHintEl: document.getElementById("etySummaryHint"),
      scoreBigEl: document.getElementById("etyScoreBig"),
      pctPillEl: document.getElementById("etyPctPill"),
      attemptPillEl: document.getElementById("etyAttemptPill"),
      timePillEl: document.getElementById("etyTimePill"),
      retryBtn: document.getElementById("etyRetryBtn"),
      newBtn: document.getElementById("etyNewBtn"),
      changeBtn2: document.getElementById("etyChangeNumberBtn2"),
      reviewEl: document.getElementById("etyReview"),

      getPools: () => presetPools,
      onNewQuizRequested: () => { /* no-op; user changes number or restarts */ },
      onChangeNumber: () => { /* no-op */ },

      _overridePools: (p) => {
        presetPools = p;
        const ok = (presetPools.vocab.length >= 10 || presetPools.ety.length >= 10);
        etyLoadStatus.textContent = ok
          ? `Preset loaded from upload. Vocabulary: ${presetPools.vocab.length} | Etymology: ${presetPools.ety.length}`
          : "Upload parsed, but not enough usable entries.";
        etyLoadStatus.className = "status " + (ok ? "ok" : "bad");
      }
    });

    /* ==========================
       CUSTOM CONTENT
       ========================== */
    let customPools = { vocab: [], ety: [] };
    const custFile = document.getElementById("custFile");
    const custCount = document.getElementById("custCount");
    const custStartBtn = document.getElementById("custStartBtn");
    const custStatus = document.getElementById("custStatus");

    function validateCust(){
      const n = clampInt(custCount.value, 1, 100);
      const fileOk = !!(custFile.files && custFile.files[0]);
      custStartBtn.disabled = !(n !== null && fileOk && customPools.vocab.length >= 6);
    }

    custCount.addEventListener("input", validateCust);
    custCount.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        if(!custStartBtn.disabled) custController.startQuiz(null);
      }
    });

    custFile.addEventListener("change", async () => {
      const f = custFile.files && custFile.files[0];
      if(!f){
        custStatus.textContent = "Waiting for a file…";
        custStatus.className = "status";
        customPools = { vocab: [], ety: [] };
        validateCust();
        return;
      }
      const text = await f.text();

      // For custom uploads we treat everything as vocabulary-style unless it explicitly uses — word-part lines.
      const parsed = parseCleanIndex(text);

      // custom quiz uses vocab pool primarily; ety allowed if present, but minimal UI.
      customPools = parsed;

      if(customPools.vocab.length >= 6 || customPools.ety.length >= 6){
        custStatus.textContent = `Loaded. Vocabulary: ${customPools.vocab.length} | Etymology: ${customPools.ety.length}`;
        custStatus.className = "status ok";
      }else{
        custStatus.textContent = "Loaded, but not enough usable entries to generate MCQs.";
        custStatus.className = "status bad";
      }
      validateCust();
    });

    /* ==========================
       CUSTOM Controller
       ========================== */
    const custController = createQuizController({
      setupRoot: document.getElementById("custSetup"),
      countInput: document.getElementById("custCount"),
      startBtn: document.getElementById("custStartBtn"),
      loadStatusEl: document.getElementById("custStatus"),
      fallbackFileEl: null,

      quizRoot: document.getElementById("custQuiz"),
      metaEl: document.getElementById("custMeta"),
      stemEl: document.getElementById("custStem"),
      optionsEl: document.getElementById("custOptions"),
      backBtn: document.getElementById("custBackBtn"),
      nextBtn: document.getElementById("custNextBtn"),
      finishBtn: document.getElementById("custFinishBtn"),
      changeBtn: document.getElementById("custChangeBtn"),

      summaryRoot: document.getElementById("custSummary"),
      summaryHintEl: document.getElementById("custSummaryHint"),
      scoreBigEl: document.getElementById("custScoreBig"),
      pctPillEl: document.getElementById("custPctPill"),
      attemptPillEl: document.getElementById("custAttemptPill"),
      timePillEl: document.getElementById("custTimePill"),
      retryBtn: document.getElementById("custRetryBtn"),
      newBtn: document.getElementById("custNewBtn"),
      changeBtn2: null,
      reviewEl: document.getElementById("custReview"),

      getPools: () => customPools,
      onNewQuizRequested: () => { /* keep file; user can change number */ },
      onChangeNumber: () => { /* no-op */ },

      _overridePools: (_) => {}
    });

    document.getElementById("custBackSetupBtn").addEventListener("click", () => {
      document.getElementById("custSetup").classList.remove("hidden");
      document.getElementById("custQuiz").classList.add("hidden");
      document.getElementById("custSummary").classList.add("hidden");
    });

    validateCust();

    /* ==========================
       Final small fix:
       if student clicks “Generate new quiz” from summary,
       keep the same number in the input and just rebuild.
       ========================== */
    document.getElementById("etyNewBtn").addEventListener("click", () => {
      // rebuild immediately using current count
      etyController.showSetup();
      const btn = document.getElementById("etyStartBtn");
      btn.disabled = false;
      etyController.startQuiz(null);
    });

    document.getElementById("custNewBtn").addEventListener("click", () => {
      custController.showSetup();
      validateCust();
      if(!custStartBtn.disabled){
        custController.startQuiz(null);
      }
    });
  </script>
</body>
</html>
