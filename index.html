<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berthel’s Biology — Unified Workspace</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg0:#050506;
      --bg1:#0b0c10;
      --bg2:#12131a;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.12);
      --border2:rgba(255,255,255,.18);
      --fg:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.52);
      --shadow: 0 18px 52px rgba(0,0,0,.55);
      --ring: 0 0 0 3px rgba(255,255,255,.10);
      --ok:#9ff3c2;
      --bad:#ff9aa5;
      --warn:#ffe3a6;
      --pill: rgba(255,255,255,.08);
      --pillBorder: rgba(255,255,255,.14);
      --btn: rgba(255,255,255,.10);
      --btnHover: rgba(255,255,255,.14);
      --btnActive: rgba(255,255,255,.18);
      --input: rgba(0,0,0,.30);
      --input2: rgba(0,0,0,.18);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui,-apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--fg);
      font: 16px/1.55 var(--sans);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.09), transparent 55%),
        radial-gradient(900px 540px at 90% -20%, rgba(255,255,255,.07), transparent 52%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg2));
    }

    .container{max-width:1150px;margin:0 auto;padding:18px}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px) saturate(130%);
      background: rgba(5,5,6,.52);
      border-bottom:1px solid var(--border);
    }

    .hero{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding:16px 0;
    }

    .brand{
      display:flex; align-items:center; gap:14px; min-width: 280px;
    }

    .avatarWrap{
      width:54px; height:54px; border-radius:999px;
      border:1px solid var(--border2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow:hidden;
      flex: 0 0 auto;
    }
    #avatar{
      width:100%; height:100%;
      object-fit:cover;
      object-position: 50% 35%;
      display:block;
      filter: contrast(1.03) brightness(1.02);
    }

    .titles h1{
      margin:0;
      font-size: 34px;
      letter-spacing: .2px;
      font-weight: 820;
    }
    .titles p{margin:6px 0 0; color:var(--muted); max-width: 62ch}

    .tagRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border:1px solid var(--pillBorder);
      background: var(--pill);
      border-radius:999px;
      font-weight: 720;
      color: rgba(255,255,255,.86);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      white-space: nowrap;
    }
    .pill small{color:var(--muted); font-weight:650}
    .pill .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,255,255,.75);
      opacity:.9;
    }

    .nav{
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 0 0 14px;
    }

    .tabBtn{
      border:1px solid var(--border);
      background: var(--btn);
      color: var(--fg);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 760;
      letter-spacing:.1px;
      transition: transform .06s, background .15s, border-color .15s, opacity .2s;
    }
    .tabBtn:hover{ background: var(--btnHover); border-color: var(--border2); }
    .tabBtn:active{ transform: translateY(1px); background: var(--btnActive); }
    .tabBtn[aria-selected="true"]{
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.22);
    }

    main{padding: 18px 0 40px}

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
      .titles h1{font-size: 30px}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .pad{padding:18px}
    .card h2{
      margin:0 0 10px;
      font-size: 18px;
      letter-spacing:.2px;
      font-weight: 820;
    }
    .subtle{color:var(--muted); font-size: 13px}
    .hr{height:1px;background:var(--border); margin:14px 0}

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .row.between{justify-content:space-between}
    .grow{flex:1}
    .min220{min-width:220px}
    .min260{min-width:260px}
    .min320{min-width:320px}

    label{display:block; font-size: 12px; color: var(--muted); margin-bottom:6px; font-weight:700; letter-spacing:.2px}

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      color: var(--fg);
      background: rgba(0,0,0,.30);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 11px 12px;
      outline:none;
      box-shadow: none;
      transition: border-color .15s, box-shadow .15s, background .15s;
    }
    input[type="text"]::placeholder, textarea::placeholder{color: rgba(255,255,255,.40)}
    input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus{
      border-color: rgba(255,255,255,.22);
      box-shadow: var(--ring);
      background: rgba(0,0,0,.18);
    }
    input[type="number"]{appearance: textfield;}
    textarea{min-height: 140px; font-family: var(--mono); font-size: 13px; line-height: 1.55}

    .btn{
      border:1px solid var(--border);
      background: var(--btn);
      color: var(--fg);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 820;
      transition: transform .06s, background .15s, border-color .15s, opacity .2s;
    }
    .btn:hover{ background: var(--btnHover); border-color: var(--border2); }
    .btn:active{ transform: translateY(1px); background: var(--btnActive); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.ghost{ background: transparent; }
    .btn.danger{ border-color: rgba(255,154,165,.38); background: rgba(255,154,165,.08); }
    .btn.ok{ border-color: rgba(159,243,194,.35); background: rgba(159,243,194,.08); }

    .notice{
      border:1px solid var(--border);
      background: rgba(0,0,0,.20);
      padding: 12px 12px;
      border-radius: 14px;
      color: rgba(255,255,255,.84);
    }
    .notice b{font-weight:900}
    .notice .muted{color:var(--muted)}
    .notice.warn{ border-color: rgba(255,227,166,.25); background: rgba(255,227,166,.08); }
    .notice.bad{ border-color: rgba(255,154,165,.25); background: rgba(255,154,165,.08); }
    .notice.ok{ border-color: rgba(159,243,194,.22); background: rgba(159,243,194,.07); }

    .kbd{
      font: 12px var(--mono);
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      border-bottom-width: 3px;
      border-radius: 10px;
      padding: 2px 8px;
      color: rgba(255,255,255,.86);
      white-space: nowrap;
    }

    /* Quiz UI */
    .progressBar{
      height: 10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.28);
      border-radius: 999px;
      overflow:hidden;
    }
    .progressBar > div{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(255,255,255,.45), rgba(255,255,255,.20));
    }
    .qPrompt{
      margin: 10px 0 14px;
      font-size: 21px;
      font-weight: 860;
      letter-spacing:.15px;
    }
    .termBadge{
      display:inline-block;
      font: 16px var(--mono);
      background: rgba(0,0,0,.22);
      border:1px solid var(--border);
      padding: 3px 9px;
      border-radius: 999px;
      margin: 0 8px;
      color: rgba(255,255,255,.92);
    }
    .opts{display:grid; gap:10px}
    .opt{
      width:100%;
      display:flex; align-items:flex-start; gap:10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.90);
      padding: 12px 12px;
      border-radius: 14px;
      cursor:pointer;
      text-align:left;
      transition: transform .06s, background .15s, border-color .15s;
      font-size: 15px;
      line-height: 1.35;
    }
    .opt:hover{ background: rgba(255,255,255,.06); border-color: var(--border2); transform: translateY(-1px); }
    .opt:active{ transform: translateY(1px); }
    .opt.correct{ border-color: rgba(159,243,194,.45); background: rgba(159,243,194,.10); }
    .opt.wrong{ border-color: rgba(255,154,165,.45); background: rgba(255,154,165,.10); }
    .opt .k{margin-top:1px}
    .opt .t{flex:1}

    details{
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
    }
    summary{cursor:pointer; color: var(--muted); font-weight: 800}

    .mono{font-family: var(--mono)}
    .hide{display:none !important;}
    .sectionTitle{
      display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .sectionTitle .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .tiny{font-size:12px;color:var(--muted)}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.80);
      font-weight: 780;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="hero">
        <div class="brand">
          <div class="avatarWrap">
            <img id="avatar" alt="Chinstrap penguin avatar" />
          </div>
          <div class="titles">
            <h1>Berthel’s Biology</h1>
            <p>Professional student testing and review workspace.</p>
          </div>
        </div>

        <div class="tagRow">
          <span class="pill"><span class="dot"></span>LIVE BUILD: <b>Unified Workspace</b> <small>v2026.02.10</small></span>
        </div>
      </div>

      <div class="nav" role="tablist" aria-label="Workspace tabs">
        <button class="tabBtn" id="tab-home" aria-selected="true" aria-controls="panel-home" role="tab">Home</button>
        <button class="tabBtn" id="tab-ety" aria-selected="false" aria-controls="panel-ety" role="tab">Etymology + Vocabulary</button>
        <button class="tabBtn" id="tab-mcq" aria-selected="false" aria-controls="panel-mcq" role="tab">MCQ</button>
        <button class="tabBtn" id="tab-settings" aria-selected="false" aria-controls="panel-settings" role="tab">Settings</button>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- HOME -->
    <section class="card" id="panel-home" role="tabpanel" aria-labelledby="tab-home">
      <div class="pad">
        <div class="sectionTitle">
          <h2>Workspace overview</h2>
          <div class="right">
            <span class="badge">Offline-friendly</span>
            <span class="badge">No external deps</span>
          </div>
        </div>

        <div class="notice warn">
          <b>Note:</b> Some browsers block <span class="mono">fetch()</span> when opened as <span class="mono">file://</span>.
          If the preset bank doesn’t auto-load from <span class="mono">ib_bio_clean_index.txt</span>, run a local server or use the upload fallback in Settings.
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div class="card">
            <div class="pad">
              <h2>Student workflow</h2>
              <ol style="margin:8px 0 0; padding-left: 18px; color: rgba(255,255,255,.86)">
                <li>Open <b>Etymology + Vocabulary</b> or <b>MCQ</b>.</li>
                <li>Select the number of practice questions.</li>
                <li>The quiz auto-generates immediately.</li>
              </ol>
              <div class="tiny" style="margin-top:10px">
                Keyboard: <span class="kbd">1–4</span> answer · <span class="kbd">Enter</span> next.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="pad">
              <h2>Status</h2>
              <div class="notice" id="statusBox">
                <div><b>Avatar:</b> <span id="statusAvatar" class="muted">loading…</span></div>
                <div style="margin-top:6px"><b>Term bank:</b> <span id="statusBank" class="muted">loading…</span></div>
                <div style="margin-top:6px"><b>MCQ JSON:</b> <span id="statusMcq" class="muted">loading…</span></div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <button class="btn" id="jumpEty">Open Etymology + Vocabulary</button>
                <button class="btn" id="jumpMcq">Open MCQ</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ETYMOLOGY + VOCAB -->
    <section class="card hide" id="panel-ety" role="tabpanel" aria-labelledby="tab-ety">
      <div class="pad">
        <div class="sectionTitle">
          <h2>Etymology + Vocabulary Review Engine</h2>
          <div class="right">
            <span class="badge">Preset bank</span>
            <span class="badge">Auto-generate</span>
            <span class="badge">Review</span>
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <div class="card">
            <div class="pad">
              <h2>Practice settings</h2>
              <div class="subtle">Preset bank: <span class="mono">ib_bio_clean_index.txt</span> (same directory as this HTML).</div>

              <div class="hr"></div>

              <div class="row between">
                <div class="min220">
                  <label>Number of questions</label>
                  <input id="etyQCount" type="number" min="1" value="40" />
                  <div class="tiny" id="etyMaxHint">Max: —</div>
                </div>

                <div class="grow"></div>

                <button id="etyStartBtn" class="btn" disabled>Generate quiz</button>
              </div>

              <div class="notice" style="margin-top:12px" id="etyRunState">
                <div><b>Bank:</b> <span class="muted" id="etyBankState">loading…</span></div>
                <div style="margin-top:6px"><b>Session:</b> <span class="muted" id="etySessionState">not running</span></div>
              </div>

              <div class="tiny" style="margin-top:10px">
                Auto-generate: changing the number of questions will regenerate (once loaded).
              </div>
            </div>
          </div>

          <div class="card">
            <div class="pad">
              <h2>Controls</h2>
              <div class="notice">
                <div><b>Keyboard:</b> <span class="kbd">1–4</span> answer · <span class="kbd">Enter</span> next</div>
                <div class="tiny" style="margin-top:8px">
                  If the bank fails to auto-load (browser blocking <span class="mono">fetch()</span> on <span class="mono">file://</span>), go to Settings and upload the TXT once.
                </div>
              </div>

              <div class="hr"></div>

              <details>
                <summary>What counts as “etymology” vs “vocabulary”</summary>
                <div class="tiny" style="margin-top:8px">
                  The parser uses a heuristic: word parts with leading/trailing hyphens (e.g., <span class="mono">-lysis</span>, <span class="mono">bio-</span>) are treated as etymology; others as vocabulary. You can override later if you want explicit tags.
                </div>
              </details>
            </div>
          </div>
        </div>

        <div style="height:16px"></div>

        <!-- Active quiz -->
        <section class="card hide" id="etyQuizCard">
          <div class="pad">
            <div class="row between" style="margin-bottom: 10px">
              <div class="row">
                <span class="badge">Q <span id="etyQi">0</span>/<span id="etyQt">0</span></span>
                <span class="badge">Score <span id="etyScore">0</span></span>
                <span class="badge" id="etyKindBadge">—</span>
              </div>
              <div class="grow" style="min-width:240px">
                <div class="progressBar"><div id="etyPbar"></div></div>
              </div>
              <div class="row">
                <button class="btn ghost" id="etyFinishNowBtn">Finish</button>
              </div>
            </div>

            <div class="qPrompt" id="etyPrompt"></div>
            <div class="opts" id="etyOpts" role="group" aria-label="options"></div>

            <div class="row between" style="margin-top: 12px">
              <div class="notice" style="padding:10px 12px" id="etyFeedbackBox">
                <b>Feedback:</b> <span class="muted" id="etyFeedback">—</span>
              </div>
              <div class="row">
                <button class="btn" id="etyNextBtn" disabled>Next</button>
                <button class="btn danger" id="etyAbortBtn">Abort</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Results -->
        <section class="card hide" id="etyResultCard">
          <div class="pad">
            <h2>Results</h2>
            <div class="row" style="margin-top:6px">
              <span class="pill">Score: <b id="etyFinalScore">0</b></span>
              <span class="pill">Questions: <b id="etyFinalTotal">0</b></span>
              <span class="pill">Accuracy: <b id="etyFinalPct">0%</b></span>
            </div>

            <div class="hr"></div>

            <details open>
              <summary>Review</summary>
              <ol id="etyReview" style="margin-top:10px"></ol>
            </details>

            <div style="height:12px"></div>

            <div class="row">
              <button class="btn ok" id="etyRetryBtn">Try again</button>
              <button class="btn ghost" id="etyExitBtn">Exit to settings</button>
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- MCQ -->
    <section class="card hide" id="panel-mcq" role="tabpanel" aria-labelledby="tab-mcq">
      <div class="pad">
        <div class="sectionTitle">
          <h2>MCQ (JSON-driven)</h2>
          <div class="right">
            <span class="badge">Preset JSON</span>
            <span class="badge">Auto-generate</span>
            <span class="badge">Review</span>
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <div class="card">
            <div class="pad">
              <h2>Practice settings</h2>
              <div class="subtle">
                This MCQ tab expects a preset JSON file in the same directory (default):
                <span class="mono">mcq_bank.json</span>.
              </div>

              <div class="hr"></div>

              <div class="row between">
                <div class="min220">
                  <label>Number of questions</label>
                  <input id="mcqRunCount" type="number" min="1" value="20" />
                  <div class="tiny" id="mcqRunMax">Max: —</div>
                </div>

                <div class="grow"></div>

                <button class="btn" id="mcqStartBtn" disabled>Generate quiz</button>
              </div>

              <div class="notice" style="margin-top:12px" id="mcqRunState">
                <div><b>Bank:</b> <span class="muted" id="mcqBankState">loading…</span></div>
                <div style="margin-top:6px"><b>Session:</b> <span class="muted" id="mcqSession">not running</span></div>
              </div>

              <div class="tiny" style="margin-top:10px">
                Auto-generate: changing the number of questions will regenerate (once loaded).
              </div>
            </div>
          </div>

          <div class="card">
            <div class="pad">
              <h2>Options</h2>
              <div class="row">
                <div class="grow min220">
                  <label>Shuffle questions</label>
                  <select id="mcqShuffle">
                    <option value="yes" selected>Yes</option>
                    <option value="no">No</option>
                  </select>
                </div>

                <div class="grow min220">
                  <label>Show explanation after answer</label>
                  <select id="mcqShowExp">
                    <option value="yes" selected>Yes</option>
                    <option value="no">No</option>
                  </select>
                </div>
              </div>

              <div class="hr"></div>

              <div class="notice">
                <div class="tiny">
                  If you are not using a preset file, go to Settings and upload a JSON once. This is kept in local storage for that browser.
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="row">
                <button class="btn ghost" id="mcqFinishBtn" disabled>Finish</button>
                <button class="btn ghost" id="mcqExportAttemptsBtn" disabled>Export attempt log (JSON)</button>
              </div>
            </div>
          </div>
        </div>

        <div style="height:16px"></div>

        <!-- Active MCQ quiz -->
        <section class="card hide" id="mcqQuizCard">
          <div class="pad">
            <div class="row between" style="margin-bottom:10px">
              <div class="row">
                <span class="badge">Q <span id="mcqQi">0</span>/<span id="mcqQt">0</span></span>
                <span class="badge">Score <span id="mcqScore">0</span></span>
              </div>
              <div class="grow" style="min-width:240px">
                <div class="progressBar"><div id="mcqPbar"></div></div>
              </div>
              <div class="row">
                <button class="btn ghost" id="mcqNextBtn" disabled>Next</button>
              </div>
            </div>

            <div class="qPrompt" id="mcqPrompt"></div>
            <div class="opts" id="mcqOpts"></div>

            <div class="notice" id="mcqFeedbackBox" style="margin-top:12px">
              <b>Feedback:</b> <span class="muted" id="mcqFeedback">—</span>
              <div class="tiny" id="mcqExplanation" style="margin-top:6px"></div>
            </div>
          </div>
        </section>

        <!-- MCQ Results -->
        <section class="card hide" id="mcqResultCard">
          <div class="pad">
            <h2>MCQ Results</h2>
            <div class="row" style="margin-top:6px">
              <span class="pill">Score: <b id="mcqFinalScore">0</b></span>
              <span class="pill">Questions: <b id="mcqFinalTotal">0</b></span>
              <span class="pill">Accuracy: <b id="mcqFinalPct">0%</b></span>
            </div>

            <div class="hr"></div>

            <details open>
              <summary>Review</summary>
              <ol id="mcqReview" style="margin-top:10px"></ol>
            </details>

            <div style="height:12px"></div>

            <div class="row">
              <button class="btn ok" id="mcqRetryBtn">Try again</button>
              <button class="btn ghost" id="mcqExitBtn">Exit to settings</button>
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="card hide" id="panel-settings" role="tabpanel" aria-labelledby="tab-settings">
      <div class="pad">
        <div class="sectionTitle">
          <h2>Settings (fallback upload only)</h2>
          <div class="right">
            <span class="badge">Avatar</span>
            <span class="badge">Bank upload</span>
            <span class="badge">MCQ upload</span>
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <div class="card">
            <div class="pad">
              <h2>Avatar</h2>
              <div class="subtle">Default avatar: <span class="mono">Chinstrap_LOgo.jfif</span> (same directory as this HTML).</div>

              <div style="height:10px"></div>

              <label>Upload avatar (JPG/PNG/WebP/JFIF)</label>
              <input id="avatarFile" type="file" accept="image/*" />

              <div style="height:12px"></div>

              <div class="notice" id="avatarMsg">
                <b>Avatar status:</b> <span class="muted" id="avatarMsgText">—</span>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="pad">
              <h2>Fallback uploads (if preset fetch is blocked)</h2>
              <div class="subtle">
                Upload once; saved to this browser (localStorage).
              </div>

              <div class="hr"></div>

              <div class="row">
                <div class="grow min260">
                  <label>Upload term bank TXT/JSON (ib_bio_clean_index.txt)</label>
                  <input id="bankCombinedFile" type="file" accept=".txt,.json" />
                </div>
                <div class="grow min260">
                  <label>Upload MCQ JSON (mcq_bank.json)</label>
                  <input id="mcqJsonFile" type="file" accept=".json" />
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="row">
                <button class="btn" id="saveStateBtn">Save now</button>
                <button class="btn ghost" id="loadStateBtn">Load saved</button>
                <button class="btn danger" id="wipeStateBtn">Wipe saved</button>
              </div>

              <div style="height:12px"></div>
              <div class="notice" id="stateMsg">
                <b>State:</b> <span class="muted" id="stateMsgText">No action yet.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /***********************
     * PRESETS (same directory as this HTML)
     ***********************/
    const PRESET_TERM_BANK_URL = './ib_bio_clean_index.txt';
    const PRESET_AVATAR_PATH = './Chinstrap_LOgo.jfif';

    // MCQ: default preset JSON filename. Put it in the same folder.
    // If you use a different name, change this constant.
    const PRESET_MCQ_JSON_URL = './mcq_bank.json';

    /***********************
     * TAB NAV
     ***********************/
    const tabs = [
      {btn:'tab-home', panel:'panel-home'},
      {btn:'tab-ety', panel:'panel-ety'},
      {btn:'tab-mcq', panel:'panel-mcq'},
      {btn:'tab-settings', panel:'panel-settings'},
    ];
    const $ = (id)=>document.getElementById(id);

    function showPanel(panelId){
      for (const t of tabs){
        const b = $(t.btn);
        const p = $(t.panel);
        const on = (t.panel === panelId);
        b.setAttribute('aria-selected', on ? 'true' : 'false');
        p.classList.toggle('hide', !on);
      }
      const map = {'panel-home':'home','panel-ety':'ety','panel-mcq':'mcq','panel-settings':'settings'};
      history.replaceState(null, '', '#' + (map[panelId] || 'home'));
    }
    for (const t of tabs){ $(t.btn).addEventListener('click', () => showPanel(t.panel)); }
    $('jumpEty').addEventListener('click', ()=>showPanel('panel-ety'));
    $('jumpMcq').addEventListener('click', ()=>showPanel('panel-mcq'));

    (function initHash(){
      const h = (location.hash || '').replace('#','').toLowerCase();
      const map = {home:'panel-home', ety:'panel-ety', mcq:'panel-mcq', settings:'panel-settings'};
      showPanel(map[h] || 'panel-home');
    })();

    /***********************
     * STATUS
     ***********************/
    function setStatus(){
      $('statusAvatar').textContent = window.__avatarOk ? 'loaded' : 'not loaded';
      $('statusBank').textContent = window.__bankTotal ? `${window.__bankTotal} items` : 'not loaded';
      $('statusMcq').textContent = window.__mcqLoaded ? `${window.__mcqLoaded} questions` : 'not loaded';
    }

    /***********************
     * UTIL
     ***********************/
    function safeJsonParse(s){ try { return JSON.parse(s); } catch { return null; } }
    function clamp(n, lo, hi){ return Math.min(Math.max(n, lo), hi); }

    async function readFileAsText(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ''));
        r.onerror = () => reject(new Error('File read failed'));
        r.readAsText(file);
      });
    }
    async function readFileAsDataUrl(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ''));
        r.onerror = () => reject(new Error('File read failed'));
        r.readAsDataURL(file);
      });
    }

    function randomInt(max){
      if (max <= 0) return 0;
      const c = window.crypto || window.msCrypto;
      if (c && c.getRandomValues){
        const buf = new Uint32Array(1);
        const range = 0xFFFFFFFF;
        const limit = range - (range % max);
        let x = 0;
        do { c.getRandomValues(buf); x = buf[0]; } while (x >= limit);
        return x % max;
      }
      return Math.floor(Math.random() * max);
    }
    function shuffle(arr){
      for (let i = arr.length - 1; i > 0; i--){
        const j = randomInt(i + 1);
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /***********************
     * AVATAR (preset first)
     ***********************/
    async function applyAvatarFromPath(path){
      return new Promise((resolve) => {
        const img = $('avatar');
        let done = false;
        const finish = (ok, msg) => {
          if (done) return;
          done = true;
          window.__avatarOk = ok;
          $('avatarMsgText').textContent = msg;
          setStatus();
          resolve(ok);
        };
        img.onload = () => finish(true, 'Loaded.');
        img.onerror = () => finish(false, 'Failed to load preset. Upload in Settings.');
        img.src = path;
      });
    }

    $('avatarFile').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const durl = await readFileAsDataUrl(f);
      const img = $('avatar');
      img.src = durl;
      window.__avatarOk = true;
      try { localStorage.setItem('bb.avatar.data', durl); } catch {}
      $('avatarMsgText').textContent = 'Uploaded + applied.';
      setStatus();
    });

    /***********************
     * TERM BANK (preset TXT auto-load)
     ***********************/
    function classifyKind(term){
      const t = (term || '').trim();
      const looksEty =
        (/^-?[a-z]{1,12}-?$/.test(t) && (t.startsWith('-') || t.endsWith('-'))) ||
        /,\s*-\w+/.test(t) ||
        /-\w+$/.test(t) || /^\w+-/.test(t);
      return looksEty ? 'ETY' : 'VOCAB';
    }

    function dedupe(entries){
      const seen = new Map();
      for (const e of entries){
        const term = (e.term || '').trim();
        const meaning = (e.meaning || '').trim();
        if (!term || !meaning) continue;
        const key = term.toLowerCase();
        if (!seen.has(key) || seen.get(key).meaning.length < meaning.length){
          seen.set(key, {term, meaning, kind: e.kind || classifyKind(term)});
        }
      }
      return Array.from(seen.values());
    }

    function parsePairsFromLine(line){
      const out = [];
      const s = (line || '').trim();
      if (!s) return out;

      const lower = s.toLowerCase();
      if (lower === 'glossary' || lower.startsWith('words in blue')) return out;

      if (s.includes('\t')){
        const parts = s.split('\t').map(x => x.trim()).filter(Boolean);
        if (parts.length >= 2){
          out.push({term: parts[0], meaning: parts.slice(1).join(' '), kind: classifyKind(parts[0])});
          return out;
        }
      }

      const cols = s.split(/\s{2,}/).map(x => x.trim()).filter(Boolean);
      if (cols.length >= 2){
        for (let i=0; i<cols.length-1; i+=2){
          const term = cols[i];
          const meaning = cols[i+1] ?? '';
          if (term && meaning) out.push({term, meaning, kind: classifyKind(term)});
        }
        return out;
      }

      const mDash = s.match(/^(.+?)\s*[—–-]\s+(.+)$/);
      if (mDash){
        out.push({term: mDash[1].trim(), meaning: mDash[2].trim(), kind: classifyKind(mDash[1])});
        return out;
      }

      const mColon = s.match(/^(.+?)\s*:\s+(.+)$/);
      if (mColon){
        out.push({term: mColon[1].trim(), meaning: mColon[2].trim(), kind: classifyKind(mColon[1])});
        return out;
      }

      return out;
    }

    function parseGlossaryText(text){
      const lines = String(text || '').split(/\r?\n/);
      const entries = [];
      let last = null;

      for (const rawLine of lines){
        const line = rawLine.replace(/\u00A0/g,' ').trim();
        if (!line) continue;

        const pairs = parsePairsFromLine(line);

        if (pairs.length){
          for (const p of pairs){
            entries.push(p);
            last = p;
          }
          continue;
        }

        if (last && line.length > 2){
          last.meaning = (last.meaning + ' ' + line).replace(/\s+/g,' ').trim();
        }
      }

      return dedupe(entries);
    }

    async function fetchText(url){
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error('Fetch failed: ' + res.status);
      return await res.text();
    }

    let bankAll = [];
    let bankEty = [];
    let bankVocab = [];

    function updateBankUI(){
      bankEty = bankAll.filter(x=>x.kind === 'ETY');
      bankVocab = bankAll.filter(x=>x.kind === 'VOCAB');

      const total = bankAll.length;
      window.__bankTotal = total;

      $('etyMaxHint').textContent = 'Max: ' + (total ? total : '—');
      $('etyQCount').max = String(Math.max(total, 1));
      $('etyStartBtn').disabled = total === 0;
      $('etyBankState').textContent = total ? `${total} items loaded.` : 'not loaded';
      setStatus();
    }

    /***********************
     * ETY QUIZ ENGINE (auto-generate)
     ***********************/
    const CHOICES = 4;
    let etyPlan = [];
    let etyIndex = 0;
    let etyScore = 0;
    let etyAnswered = false;
    let etyHistory = [];
    let etyAutoReady = false;

    function setEtyPrompt(kind, term){
      const p = $('etyPrompt');
      p.innerHTML = '';
      const lead = document.createTextNode(kind === 'ETY' ? 'What is the meaning of ' : 'Which definition best matches ');
      const badge = document.createElement('span');
      badge.className = 'termBadge';
      badge.textContent = term;
      p.appendChild(lead);
      p.appendChild(badge);
      p.appendChild(document.createTextNode('?'));
      $('etyKindBadge').textContent = kind;
    }

    function buildChoices(correct, pool){
      const picks = [correct];
      let tries = 0;
      while (picks.length < CHOICES && tries < 2500){
        const c = pool[randomInt(pool.length)];
        if (c && !picks.includes(c)) picks.push(c);
        tries++;
      }
      while (picks.length < CHOICES) picks.push('—');
      return shuffle(picks);
    }

    function renderEtyChoices(choices, correct, record){
      const box = $('etyOpts');
      box.innerHTML = '';
      choices.forEach((choice, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'opt';
        btn.dataset.correct = (choice === correct) ? '1' : '0';

        const k = document.createElement('span');
        k.className = 'kbd k';
        k.textContent = String(i + 1);

        const t = document.createElement('span');
        t.className = 't';
        t.textContent = choice;

        btn.appendChild(k); btn.appendChild(t);
        btn.addEventListener('click', () => gradeEty(btn, correct, {...record, picked: choice, ok: choice === correct}));
        box.appendChild(btn);
      });
    }

    function resetEtySession(total){
      etyPlan = [];
      etyIndex = 0;
      etyScore = 0;
      etyAnswered = false;
      etyHistory = [];

      $('etyQi').textContent = '0';
      $('etyQt').textContent = String(total);
      $('etyScore').textContent = '0';
      $('etyPbar').style.width = '0%';
      $('etyFeedback').textContent = '—';
      $('etyNextBtn').disabled = true;
      $('etySessionState').textContent = 'not running';
    }

    function nextEtyQuestion(){
      if (etyIndex >= etyPlan.length) return finishEty();
      etyAnswered = false;
      $('etyNextBtn').disabled = true;
      $('etyFeedback').textContent = '—';

      const item = bankAll[etyPlan[etyIndex]];
      if (!item) { etyIndex++; return nextEtyQuestion(); }

      $('etyQi').textContent = String(etyIndex + 1);
      setEtyPrompt(item.kind, item.term);

      const correct = item.meaning;
      const pool = (item.kind === 'ETY' ? bankEty : bankVocab).map(x => x.meaning);
      const effectivePool = pool.length >= 4 ? pool : bankAll.map(x => x.meaning);

      const record = {kind: item.kind, term: item.term, correct, picked:'', ok:false};
      const choices = buildChoices(correct, effectivePool);
      renderEtyChoices(choices, correct, record);
    }

    function gradeEty(btn, correct, record){
      if (etyAnswered) return;
      etyAnswered = true;

      const all = Array.from(document.querySelectorAll('#etyOpts .opt'));
      all.forEach(el => el.disabled = true);

      if (btn.dataset.correct === '1'){
        btn.classList.add('correct');
        etyScore++;
        $('etyFeedback').textContent = 'Correct.';
      } else {
        btn.classList.add('wrong');
        $('etyFeedback').textContent = 'Correct: ' + correct;
        const target = all.find(el => el.dataset.correct === '1');
        if (target) target.classList.add('correct');
      }

      $('etyScore').textContent = String(etyScore);
      etyHistory.push(record);

      etyIndex++;
      $('etyPbar').style.width = Math.round((etyIndex / etyPlan.length) * 100) + '%';
      $('etyNextBtn').disabled = false;
    }

    function finishEty(){
      $('etyQuizCard').classList.add('hide');
      $('etyResultCard').classList.remove('hide');

      $('etyFinalScore').textContent = String(etyScore);
      $('etyFinalTotal').textContent = String(etyPlan.length);
      $('etyFinalPct').textContent = etyPlan.length ? (Math.round((etyScore / etyPlan.length) * 100) + '%') : '0%';

      const ol = $('etyReview');
      ol.innerHTML = '';
      etyHistory.forEach(h => {
        const li = document.createElement('li');
        li.style.color = h.ok ? 'var(--ok)' : 'var(--bad)';
        li.textContent = `${h.kind} · ${h.term} → ${h.correct}` + (h.ok ? '' : ` · you chose: ${h.picked}`);
        ol.appendChild(li);
      });

      $('etySessionState').textContent = 'completed';
    }

    function startEty(){
      if (!bankAll.length) return;

      const requested = clamp(parseInt($('etyQCount').value || 40, 10), 1, bankAll.length);
      const indices = Array.from({length: bankAll.length}, (_, i) => i);
      shuffle(indices);
      etyPlan = indices.slice(0, requested);

      resetEtySession(etyPlan.length);
      $('etySessionState').textContent = `running (${etyPlan.length} Q)`;

      $('etyResultCard').classList.add('hide');
      $('etyQuizCard').classList.remove('hide');
      nextEtyQuestion();
    }

    // Auto-generate when Q count changes (once bank is loaded)
    $('etyQCount').addEventListener('input', () => {
      if (!etyAutoReady) return;
      startEty();
    });

    $('etyStartBtn').addEventListener('click', startEty);
    $('etyNextBtn').addEventListener('click', nextEtyQuestion);
    $('etyFinishNowBtn').addEventListener('click', finishEty);
    $('etyAbortBtn').addEventListener('click', () => {
      resetEtySession(0);
      $('etyQuizCard').classList.add('hide');
      $('etyResultCard').classList.add('hide');
      $('etySessionState').textContent = 'aborted';
    });
    $('etyRetryBtn').addEventListener('click', () => {
      $('etyResultCard').classList.add('hide');
      startEty();
    });
    $('etyExitBtn').addEventListener('click', () => showPanel('panel-settings'));

    window.addEventListener('keydown', (e) => {
      if ($('panel-ety').classList.contains('hide')) return;
      if ($('etyQuizCard').classList.contains('hide')) return;

      if (/^[1-4]$/.test(e.key)){
        const i = Number(e.key) - 1;
        document.querySelectorAll('#etyOpts .opt')[i]?.click();
      } else if (e.key === 'Enter'){
        if (!$('etyNextBtn').disabled) $('etyNextBtn').click();
      }
    });

    /***********************
     * MCQ JSON RUNNER (preset JSON + auto-generate)
     ***********************/
    let mcqBank = null;
    let mcqPlan = [];
    let mcqIndex = 0;
    let mcqScore = 0;
    let mcqAnswered = false;
    let mcqAttempts = [];
    let mcqAutoReady = false;

    function normalizeMcqJson(obj){
      if (!obj) return null;
      const title = String(obj.title ?? obj.name ?? 'MCQ Set').trim();
      const qArr = Array.isArray(obj.questions) ? obj.questions
                : Array.isArray(obj.items) ? obj.items
                : Array.isArray(obj.mcqs) ? obj.mcqs
                : null;
      if (!qArr) return null;

      const questions = [];
      for (const q of qArr){
        if (!q) continue;
        const prompt = String(q.prompt ?? q.question ?? q.stem ?? q.text ?? '').trim();
        const choices = q.choices ?? q.options ?? q.answers ?? null;
        if (!prompt || !Array.isArray(choices) || choices.length < 2) continue;

        const ch = choices.map(x => String(x).trim());

        let ai = null;
        if (Number.isInteger(q.answer_index)) ai = q.answer_index;
        else if (Number.isInteger(q.answer)) ai = q.answer;
        else if (typeof q.answer_letter === 'string'){
          ai = 'ABCD'.indexOf(q.answer_letter.trim().toUpperCase());
        } else if (typeof q.correct === 'string'){
          ai = 'ABCD'.indexOf(q.correct.trim().toUpperCase());
        }
        if (ai == null || ai < 0 || ai >= ch.length) continue;

        questions.push({
          prompt,
          choices: ch,
          answer_index: ai,
          explanation: String(q.explanation ?? q.rationale ?? '').trim(),
          tags: Array.isArray(q.tags) ? q.tags.map(x => String(x)) : []
        });
      }

      if (!questions.length) return null;
      return {title, questions};
    }

    async function loadMcqFromPresetOrSaved(){
      // Saved (uploaded once) takes precedence
      try{
        const saved = localStorage.getItem('bb.mcq.json');
        if (saved){
          const raw = safeJsonParse(saved);
          const normalized = normalizeMcqJson(raw);
          if (normalized) return normalized;
        }
      } catch {}

      // Else preset file
      const txt = await fetchText(PRESET_MCQ_JSON_URL);
      const raw = safeJsonParse(txt);
      if (!raw) throw new Error('Preset MCQ JSON invalid.');
      const normalized = normalizeMcqJson(raw);
      if (!normalized) throw new Error('Preset MCQ JSON schema not recognized.');
      return normalized;
    }

    function updateMcqUI(){
      const n = mcqBank?.questions?.length || 0;
      window.__mcqLoaded = n;

      $('mcqRunMax').textContent = 'Max: ' + (n ? n : '—');
      $('mcqRunCount').max = String(Math.max(n, 1));
      $('mcqStartBtn').disabled = n === 0;

      $('mcqBankState').textContent = n ? `${n} questions loaded.` : 'not loaded';
      setStatus();
    }

    function resetMcqSession(total){
      mcqPlan = [];
      mcqIndex = 0;
      mcqScore = 0;
      mcqAnswered = false;
      mcqAttempts = [];

      $('mcqQi').textContent = '0';
      $('mcqQt').textContent = String(total);
      $('mcqScore').textContent = '0';
      $('mcqPbar').style.width = '0%';
      $('mcqFeedback').textContent = '—';
      $('mcqExplanation').textContent = '';
      $('mcqNextBtn').disabled = true;
      $('mcqFinishBtn').disabled = true;
      $('mcqExportAttemptsBtn').disabled = true;
    }

    function renderMcqQuestion(){
      if (!mcqBank) return;
      if (mcqIndex >= mcqPlan.length) return finishMcq();

      mcqAnswered = false;
      $('mcqNextBtn').disabled = true;
      $('mcqFeedback').textContent = '—';
      $('mcqExplanation').textContent = '';

      const q = mcqBank.questions[mcqPlan[mcqIndex]];
      $('mcqQi').textContent = String(mcqIndex + 1);
      $('mcqQt').textContent = String(mcqPlan.length);
      $('mcqPrompt').textContent = q.prompt;

      const opts = $('mcqOpts');
      opts.innerHTML = '';

      q.choices.forEach((choice, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'opt';
        btn.dataset.correct = (i === q.answer_index) ? '1' : '0';

        const k = document.createElement('span');
        k.className = 'kbd k';
        k.textContent = 'ABCD'[i] || String(i+1);

        const t = document.createElement('span');
        t.className = 't';
        t.textContent = choice;

        btn.appendChild(k); btn.appendChild(t);
        btn.addEventListener('click', () => gradeMcq(btn, q, i));
        opts.appendChild(btn);
      });
    }

    function gradeMcq(btn, q, pickedIndex){
      if (mcqAnswered) return;
      mcqAnswered = true;

      const all = Array.from(document.querySelectorAll('#mcqOpts .opt'));
      all.forEach(el => el.disabled = true);

      const ok = (pickedIndex === q.answer_index);
      if (ok){
        btn.classList.add('correct');
        mcqScore++;
        $('mcqFeedback').textContent = 'Correct.';
      } else {
        btn.classList.add('wrong');
        $('mcqFeedback').textContent = 'Correct: ' + (q.choices[q.answer_index] ?? '(missing)');
        const target = all.find(el => el.dataset.correct === '1');
        if (target) target.classList.add('correct');
      }

      $('mcqScore').textContent = String(mcqScore);
      mcqAttempts.push({
        ts: new Date().toISOString(),
        q_index: mcqPlan[mcqIndex],
        prompt: q.prompt,
        picked_index: pickedIndex,
        answer_index: q.answer_index,
        ok,
        explanation: q.explanation || '',
        tags: q.tags || []
      });

      if ($('mcqShowExp').value === 'yes' && q.explanation){
        $('mcqExplanation').textContent = q.explanation;
      }

      mcqIndex++;
      $('mcqPbar').style.width = Math.round((mcqIndex / mcqPlan.length) * 100) + '%';
      $('mcqNextBtn').disabled = false;
      $('mcqFinishBtn').disabled = false;
      $('mcqExportAttemptsBtn').disabled = false;
    }

    function startMcq(){
      if (!mcqBank) return;
      const total = mcqBank.questions.length;
      const requested = clamp(parseInt($('mcqRunCount').value || 20, 10), 1, total);

      const indices = Array.from({length: total}, (_, i) => i);
      if ($('mcqShuffle').value === 'yes') shuffle(indices);

      mcqPlan = indices.slice(0, requested);
      resetMcqSession(mcqPlan.length);

      $('mcqQuizCard').classList.remove('hide');
      $('mcqResultCard').classList.add('hide');

      $('mcqSession').textContent = `running (${mcqPlan.length} Q)`;
      renderMcqQuestion();
    }

    $('mcqRunCount').addEventListener('input', () => {
      if (!mcqAutoReady) return;
      startMcq();
    });

    $('mcqStartBtn').addEventListener('click', startMcq);
    $('mcqNextBtn').addEventListener('click', renderMcqQuestion);

    function finishMcq(){
      $('mcqQuizCard').classList.add('hide');
      $('mcqResultCard').classList.remove('hide');

      $('mcqFinalScore').textContent = String(mcqScore);
      $('mcqFinalTotal').textContent = String(mcqPlan.length);
      $('mcqFinalPct').textContent = mcqPlan.length ? (Math.round((mcqScore / mcqPlan.length) * 100) + '%') : '0%';

      const ol = $('mcqReview');
      ol.innerHTML = '';
      mcqAttempts.forEach(a => {
        const li = document.createElement('li');
        li.style.color = a.ok ? 'var(--ok)' : 'var(--bad)';
        const picked = a.picked_index != null ? ('ABCD'[a.picked_index] || a.picked_index) : '?';
        const ans = a.answer_index != null ? ('ABCD'[a.answer_index] || a.answer_index) : '?';
        li.textContent = `${a.ok ? '✓' : '✗'} [${picked} vs ${ans}] ${a.prompt}`;
        if (a.explanation){
          const div = document.createElement('div');
          div.className = 'tiny';
          div.style.marginTop = '6px';
          div.style.color = 'rgba(255,255,255,.70)';
          div.textContent = 'Explanation: ' + a.explanation;
          li.appendChild(div);
        }
        ol.appendChild(li);
      });

      $('mcqSession').textContent = 'completed';
    }

    $('mcqFinishBtn').addEventListener('click', finishMcq);
    $('mcqRetryBtn').addEventListener('click', () => {
      $('mcqResultCard').classList.add('hide');
      startMcq();
    });
    $('mcqExitBtn').addEventListener('click', () => showPanel('panel-settings'));

    $('mcqExportAttemptsBtn').addEventListener('click', () => {
      const payload = {
        exported_at: new Date().toISOString(),
        title: mcqBank?.title || 'MCQ',
        run_count: mcqPlan.length,
        score: mcqScore,
        attempts: mcqAttempts
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'mcq_attempt_log.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    window.addEventListener('keydown', (e) => {
      // ETY keys
      if (!$('panel-ety').classList.contains('hide') && !$('etyQuizCard').classList.contains('hide')){
        if (/^[1-4]$/.test(e.key)){
          const i = Number(e.key) - 1;
          document.querySelectorAll('#etyOpts .opt')[i]?.click();
          return;
        }
        if (e.key === 'Enter' && !$('etyNextBtn').disabled){
          $('etyNextBtn').click();
          return;
        }
      }

      // MCQ keys
      if (!$('panel-mcq').classList.contains('hide') && !$('mcqQuizCard').classList.contains('hide')){
        const key = e.key.toUpperCase();
        const map = {A:0,B:1,C:2,D:3,'1':0,'2':1,'3':2,'4':3};
        if (key in map){
          document.querySelectorAll('#mcqOpts .opt')[map[key]]?.click();
          return;
        }
        if (e.key === 'Enter' && !$('mcqNextBtn').disabled){
          $('mcqNextBtn').click();
          return;
        }
      }
    });

    /***********************
     * SETTINGS UPLOADS
     ***********************/
    $('bankCombinedFile').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const txt = await readFileAsText(f);
      bankAll = parseGlossaryText(txt);
      updateBankUI();
      etyAutoReady = bankAll.length > 0;
      $('etyStartBtn').disabled = bankAll.length === 0;
      $('etyBankState').textContent = bankAll.length ? `${bankAll.length} items loaded (uploaded).` : 'not loaded';

      try { localStorage.setItem('bb.bankAll', JSON.stringify(bankAll)); } catch {}
      $('stateMsgText').textContent = 'Term bank uploaded + stored.';
    });

    $('mcqJsonFile').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const txt = await readFileAsText(f);
      const raw = safeJsonParse(txt);
      const normalized = normalizeMcqJson(raw);
      if (!normalized){
        $('stateMsgText').textContent = 'MCQ JSON uploaded but schema not recognized.';
        return;
      }
      mcqBank = normalized;
      updateMcqUI();
      mcqAutoReady = (mcqBank.questions.length > 0);
      $('mcqStartBtn').disabled = mcqBank.questions.length === 0;
      $('mcqBankState').textContent = mcqBank.questions.length ? `${mcqBank.questions.length} questions loaded (uploaded).` : 'not loaded';

      try { localStorage.setItem('bb.mcq.json', JSON.stringify(raw)); } catch {}
      $('stateMsgText').textContent = 'MCQ JSON uploaded + stored.';
    });

    $('saveStateBtn').addEventListener('click', () => {
      try{
        if (bankAll?.length) localStorage.setItem('bb.bankAll', JSON.stringify(bankAll));
        if (mcqBank?.questions?.length) localStorage.setItem('bb.mcq.bankNormalized', JSON.stringify(mcqBank));
        $('stateMsgText').textContent = 'Saved.';
      } catch {
        $('stateMsgText').textContent = 'Save failed (storage blocked).';
      }
    });

    $('loadStateBtn').addEventListener('click', async () => {
      try{
        const savedAvatar = localStorage.getItem('bb.avatar.data');
        if (savedAvatar){
          $('avatar').src = savedAvatar;
          window.__avatarOk = true;
        }

        const b = localStorage.getItem('bb.bankAll');
        const arr = b ? safeJsonParse(b) : null;
        if (Array.isArray(arr) && arr.length){
          bankAll = dedupe(arr.map(x => ({
            term: x.term, meaning: x.meaning, kind: (x.kind === 'ETY' || x.kind === 'VOCAB') ? x.kind : classifyKind(x.term)
          })));
          updateBankUI();
          etyAutoReady = bankAll.length > 0;
          $('etyBankState').textContent = `${bankAll.length} items loaded (saved).`;
        }

        const rawSaved = localStorage.getItem('bb.mcq.json');
        const raw = rawSaved ? safeJsonParse(rawSaved) : null;
        const normalized = raw ? normalizeMcqJson(raw) : null;
        if (normalized){
          mcqBank = normalized;
          updateMcqUI();
          mcqAutoReady = mcqBank.questions.length > 0;
          $('mcqBankState').textContent = `${mcqBank.questions.length} questions loaded (saved).`;
        }

        $('stateMsgText').textContent = 'Loaded saved state.';
        setStatus();
      } catch {
        $('stateMsgText').textContent = 'Load failed.';
      }
    });

    $('wipeStateBtn').addEventListener('click', () => {
      try{
        localStorage.removeItem('bb.avatar.data');
        localStorage.removeItem('bb.bankAll');
        localStorage.removeItem('bb.mcq.json');
        $('stateMsgText').textContent = 'Wiped.';
      } catch {
        $('stateMsgText').textContent = 'Wipe failed.';
      }
    });

    /***********************
     * BOOT: auto-load preset avatar + preset banks
     ***********************/
    (async function boot(){
      window.__avatarOk = false;
      window.__bankTotal = 0;
      window.__mcqLoaded = 0;

      // 1) Avatar: saved upload else preset file
      try{
        const savedAvatar = localStorage.getItem('bb.avatar.data');
        if (savedAvatar){
          $('avatar').src = savedAvatar;
          window.__avatarOk = true;
          $('avatarMsgText').textContent = 'Loaded saved avatar.';
        } else {
          const ok = await applyAvatarFromPath(PRESET_AVATAR_PATH);
          window.__avatarOk = ok;
        }
      } catch {
        // ignore
      }

      // 2) Term bank: saved else preset TXT
      try{
        const savedBank = localStorage.getItem('bb.bankAll');
        const arr = savedBank ? safeJsonParse(savedBank) : null;
        if (Array.isArray(arr) && arr.length){
          bankAll = dedupe(arr.map(x => ({
            term: x.term, meaning: x.meaning, kind: (x.kind === 'ETY' || x.kind === 'VOCAB') ? x.kind : classifyKind(x.term)
          })));
          updateBankUI();
          $('etyBankState').textContent = `${bankAll.length} items loaded (saved).`;
        } else {
          const txt = await fetchText(PRESET_TERM_BANK_URL);
          bankAll = parseGlossaryText(txt);
          updateBankUI();
          $('etyBankState').textContent = bankAll.length ? `${bankAll.length} items loaded (preset).` : 'not loaded';
        }
        etyAutoReady = bankAll.length > 0;
      } catch {
        $('etyBankState').textContent = 'preset load blocked; upload in Settings.';
      }

      // 3) MCQ JSON: saved else preset JSON
      try{
        mcqBank = await loadMcqFromPresetOrSaved();
        updateMcqUI();
        $('mcqBankState').textContent = `${mcqBank.questions.length} questions loaded (${localStorage.getItem('bb.mcq.json') ? 'saved' : 'preset'}).`;
        mcqAutoReady = mcqBank.questions.length > 0;
      } catch {
        $('mcqBankState').textContent = 'preset load failed; upload in Settings.';
      }

      // Enable generate buttons if ready
      $('etyStartBtn').disabled = !etyAutoReady;
      $('mcqStartBtn').disabled = !mcqAutoReady;

      // Auto-generate *once* when loaded: use current inputs.
      if (etyAutoReady) startEty();
      if (mcqAutoReady) startMcq();

      setStatus();
    })();
  </script>
</body>
</html>
